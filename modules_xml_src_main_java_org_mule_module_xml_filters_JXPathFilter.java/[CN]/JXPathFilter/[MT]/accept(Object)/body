{
  if (obj == null) {
    logger.warn("Applying JXPathFilter to null object.");
    return false;
  }
  if (pattern == null) {
    logger.warn("Expression for JXPathFilter is not set.");
    return false;
  }
  if (expectedValue == null) {
    if (pattern.endsWith("= null") || pattern.endsWith("=null")) {
      expectedValue="null";
      pattern=pattern.substring(0,pattern.lastIndexOf("="));
    }
 else {
      if (logger.isInfoEnabled()) {
        logger.info("Expected value for JXPathFilter is not set, using 'true' by default");
      }
      expectedValue=Boolean.TRUE.toString();
    }
  }
  Object xpathResult=null;
  boolean accept=false;
  Document dom4jDoc;
  try {
    dom4jDoc=XMLUtils.toDocument(obj,muleContext);
  }
 catch (  Exception e) {
    logger.warn("JxPath filter rejected message because of an error while parsing XML: " + e.getMessage(),e);
    return false;
  }
  if (dom4jDoc != null) {
    if (namespaces == null) {
      xpathResult=dom4jDoc.valueOf(pattern);
    }
 else {
      XPath xpath=DocumentHelper.createXPath(pattern);
      xpath.setNamespaceURIs(namespaces);
      xpathResult=xpath.valueOf(dom4jDoc);
    }
  }
 else {
    if (logger.isDebugEnabled()) {
      logger.debug("Passing object of type " + obj.getClass().getName() + " to JXPathContext");
    }
    JXPathContext context=JXPathContext.newContext(obj);
    initialise(context);
    xpathResult=context.getValue(pattern);
  }
  if (logger.isDebugEnabled()) {
    logger.debug("JXPathFilter Expression result = '" + xpathResult + "' -  Expected value = '"+ expectedValue+ "'");
  }
  if (xpathResult != null) {
    accept=xpathResult.toString().equals(expectedValue);
  }
 else {
    if (expectedValue.equals("null")) {
      accept=true;
    }
 else {
      logger.warn("JXPathFilter expression evaluates to null: " + pattern);
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debug("JXPathFilter accept object  : " + accept);
  }
  return accept;
}
