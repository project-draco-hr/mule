{
  DataType simpleDateType1=DataType.builder().type(String.class).mediaType("text/plain").build();
  InternalMessage message1=InternalMessage.builder().payload("test event A").build();
  InternalMessage message2=InternalMessage.builder().payload("test event B").build();
  InternalMessage message3=InternalMessage.builder().payload("test event C").build();
  Event event1=Event.builder(context).message(message1).flow(flow).addVariable("key1","value1",simpleDateType1).build();
  event1=populateFieldsFromInboundEndpoint(event1,endpoint);
  MuleSession session=event1.getSession();
  Event event2=Event.builder(context).message(message2).flow(flow).session(session).addVariable("key2","value2",simpleDateType1).build();
  event2=populateFieldsFromInboundEndpoint(event2,endpoint);
  Event event3=Event.builder(context).message(message3).flow(flow).session(session).addVariable("key3","value3",simpleDateType1).build();
  event3=populateFieldsFromInboundEndpoint(event3,endpoint);
  event1.getSession().setProperty("key","value");
  event2.getSession().setProperty("key1","value1");
  event2.getSession().setProperty("key2","value2");
  event3.getSession().setProperty("KEY2","value2NEW");
  event3.getSession().setProperty("key3","value3");
  List<Event> events=new ArrayList<>();
  events.add(event2);
  events.add(event3);
  Event result=resultsHandler.aggregateResults(events,event1);
  assertNotNull(result);
  assertEquals(2,((List<InternalMessage>)result.getMessage().getPayload().getValue()).size());
  assertTrue(result.getMessage().getPayload().getValue() instanceof List<?>);
  assertEquals(message2,((List<InternalMessage>)result.getMessage().getPayload().getValue()).get(0));
  assertEquals(message3,((List<InternalMessage>)result.getMessage().getPayload().getValue()).get(1));
  assertEquals("value1",result.getVariable("key1").getValue());
  assertTrue(simpleDateType1.equals(result.getVariable("key1").getDataType()));
  assertThat(result.getVariableNames(),not(contains("key2")));
  assertThat(result.getVariableNames(),not(contains("key3")));
  assertEquals(event1.getCorrelationId(),result.getCorrelationId());
  assertEquals("value",result.getSession().getProperty("key"));
  assertEquals("value1",result.getSession().getProperty("key1"));
  assertEquals("value2NEW",result.getSession().getProperty("key2"));
  assertEquals("value3",result.getSession().getProperty("key3"));
  assertNull(result.getSession().getProperty("key4"));
}
