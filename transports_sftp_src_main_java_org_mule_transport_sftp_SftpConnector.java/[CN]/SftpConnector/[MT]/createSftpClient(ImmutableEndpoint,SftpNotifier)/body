{
  SftpClient client=null;
  boolean ok=false;
  try {
    if (useConnectionPool()) {
      ObjectPool pool=getClientPool(endpoint);
      client=(SftpClient)pool.borrowObject();
    }
 else {
      client=SftpConnectionFactory.createClient(endpoint,preferredAuthenticationMethods);
    }
    String dir=endpoint.getEndpointURI().getPath();
    client.changeWorkingDirectory(dir);
    if (logger.isDebugEnabled()) {
      logger.debug("Successfully changed working directory to: " + dir);
    }
    client.setNotifier(notifier);
    ok=true;
  }
  finally {
    if (!ok && client != null) {
      releaseClient(endpoint,client);
    }
  }
  return client;
}
