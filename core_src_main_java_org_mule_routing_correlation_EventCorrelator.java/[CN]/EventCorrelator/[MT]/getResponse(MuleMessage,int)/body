{
  final String messageId=messageInfoMapping.getMessageId(message);
  if (logger.isTraceEnabled()) {
    try {
      logger.trace(String.format("Waiting for response(s) for message with id: %s%n%s%n%s",messageId,StringMessageUtils.truncate(StringMessageUtils.toString(message.getPayload()),200,false),StringMessageUtils.headersToString(message)));
    }
 catch (    Exception e) {
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Waiting for response for message id: " + messageId + " in "+ this);
  }
  Latch l=(Latch)locks.get(messageId);
  if (l == null) {
    if (logger.isDebugEnabled()) {
      logger.debug("Got response but no one is waiting for it yet. Creating latch for message id " + messageId + " in "+ this);
    }
    l=new Latch();
    Latch previous=(Latch)locks.putIfAbsent(messageId,l);
    if (previous != null) {
      l=previous;
    }
  }
  MuleMessage result;
  boolean resultAvailable=false;
  boolean interruptedWhileWaiting=false;
  try {
    if (logger.isDebugEnabled()) {
      logger.debug("Waiting for response to message: " + messageId);
    }
    if (this.getTimeout() <= 0) {
      l.await();
      resultAvailable=true;
    }
 else {
      resultAvailable=l.await(timeout,TimeUnit.MILLISECONDS);
    }
  }
 catch (  InterruptedException e) {
    interruptedWhileWaiting=true;
  }
 finally {
    locks.remove(messageId);
    result=(MuleMessage)responseMessages.remove(messageId);
    if (interruptedWhileWaiting) {
      Thread.currentThread().interrupt();
    }
  }
  if (!resultAvailable) {
    if (isFailOnTimeout()) {
      if (logger.isTraceEnabled()) {
        logger.trace(String.format("Current responses are: %n%s",MapUtils.toString(responseMessages,true)));
      }
      context.fireNotification(new RoutingNotification(message,null,RoutingNotification.ASYNC_REPLY_TIMEOUT));
      throw new ResponseTimeoutException(CoreMessages.responseTimedOutWaitingForId(this.getTimeout(),messageId),message,null);
    }
 else {
      EventGroup group=this.getEventGroup(messageId);
      if (group == null) {
        if (logger.isTraceEnabled()) {
          logger.trace(String.format("There is no current event Group. Current responses are: %n%s",MapUtils.toString(responseMessages,true)));
        }
        return null;
      }
 else {
        this.removeEventGroup(group);
        MuleMessage msg=callback.aggregateEvents(group);
        return msg;
      }
    }
  }
  if (result == null) {
    throw new IllegalStateException("Response Message is null");
  }
  if (logger.isDebugEnabled()) {
    logger.debug("remaining locks  : " + locks.keySet());
    logger.debug("remaining results: " + responseMessages.keySet());
  }
  return result;
}
