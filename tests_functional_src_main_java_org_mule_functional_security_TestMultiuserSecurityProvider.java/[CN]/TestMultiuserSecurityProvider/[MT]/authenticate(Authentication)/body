{
  String user=(String)authentication.getPrincipal();
  logger.debug("Authenticating user: " + user);
  Authentication oldAuth=authentications.get(user);
  if (oldAuth != null) {
    authentication=oldAuth;
    Map<String,Object> props=authentication.getProperties();
    int numberLogins=(Integer)props.get(PROPERTY_NUMBER_LOGINS);
    String favoriteColor=(String)props.get(PROPERTY_FAVORITE_COLOR);
    props.put(PROPERTY_NUMBER_LOGINS,numberLogins + 1);
    authentication.setProperties(props);
    authentications.put(user,authentication);
    logger.info("Welcome back " + user + " ("+ numberLogins+ 1+ " logins), we remembered your favorite color: "+ favoriteColor);
  }
 else {
    String favoriteColor=getFavoriteColor(user);
    logger.info("First login for user: " + user + ", favorite color is "+ favoriteColor);
    Map<String,Object> props=new HashMap<String,Object>();
    props.put(PROPERTY_NUMBER_LOGINS,1);
    props.put(PROPERTY_FAVORITE_COLOR,favoriteColor);
    authentication.setProperties(props);
    authentications.put(user,authentication);
  }
  return authentication;
}
