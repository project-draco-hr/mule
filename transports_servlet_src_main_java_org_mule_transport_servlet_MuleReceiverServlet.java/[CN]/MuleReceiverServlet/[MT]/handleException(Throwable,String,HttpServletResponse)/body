{
  MuleEvent responseEvent=null;
  if (t instanceof MessagingException) {
    MuleEvent event=((MessagingException)t).getEvent();
    responseEvent=event.getFlowConstruct().getExceptionListener().handleException((Exception)t,event);
    if (responseEvent != null && responseEvent.getMessage().getExceptionPayload() != null && responseEvent.getMessage().getExceptionPayload().getException() instanceof MessagingException) {
      message=responseEvent.getMessage().getExceptionPayload().getException().getMessage();
    }
    if (responseEvent != null && responseEvent.getMessage().getExceptionPayload() == null) {
      try {
        writeResponse(response,responseEvent.getMessage());
        return;
      }
 catch (      Exception e) {
        logger.error("Failed to write on response: " + e.getMessage(),e);
      }
    }
  }
 else   if (t instanceof Exception) {
    muleContext.getExceptionListener().handleException((Exception)t);
  }
  super.handleException(t,message,response);
}
