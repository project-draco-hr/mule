{
  getMuleContextForApp(CLIENT_APP).getClient().dispatch(queueAddress(inQueue),"test",null);
  final AtomicReference<MuleMessage> response=new AtomicReference<MuleMessage>();
  new PollingProber(10000,100).check(new Probe(){
    @Override public boolean isSatisfied(){
      MuleMessage responseMessage;
      try {
        responseMessage=getMuleContextForApp(CLIENT_APP).getClient().request(queueAddress(outQueue),10);
      }
 catch (      MuleException e) {
        throw new RuntimeException(e);
      }
      if (responseMessage != null) {
        response.set(responseMessage);
        return true;
      }
      return false;
    }
    @Override public String describeFailure(){
      return "response message never arrived";
    }
  }
);
  assertThat(getPayloadAsString(response.get(),getMuleContextForApp(CLIENT_APP)),is("works"));
}
