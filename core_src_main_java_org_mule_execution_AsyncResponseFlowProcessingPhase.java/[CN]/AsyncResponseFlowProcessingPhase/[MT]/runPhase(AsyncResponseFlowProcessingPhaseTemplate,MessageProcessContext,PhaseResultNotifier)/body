{
  try {
    try {
      final MessagingExceptionHandler exceptionHandler=messageProcessContext.getFlowConstruct().getExceptionListener();
      TransactionalErrorHandlingExecutionTemplate transactionTemplate=TransactionalErrorHandlingExecutionTemplate.createMainExecutionTemplate(messageProcessContext.getFlowConstruct().getMuleContext(),(messageProcessContext.getTransactionConfig() == null ? new MuleTransactionConfig() : messageProcessContext.getTransactionConfig()),exceptionHandler);
      final MuleEvent response=transactionTemplate.execute(new ExecutionCallback<MuleEvent>(){
        @Override public MuleEvent process() throws Exception {
          MuleEvent muleEvent=template.getMuleEvent();
          fireNotification(muleEvent,MESSAGE_RECEIVED);
          if (muleEvent.isAllowNonBlocking()) {
            muleEvent=new DefaultMuleEvent(muleEvent,new ErrorHandlingCompletionHandlerReplyToHandlerAdaptor(new FlowProcessingCompletionHandler(template,phaseResultNotifier,exceptionHandler),messageProcessContext.getFlowConstruct().getExceptionListener()));
          }
          return template.routeEvent(muleEvent);
        }
      }
);
      if (response != NonBlockingVoidMuleEvent.getInstance()) {
        fireNotification(response,MESSAGE_RESPONSE);
        template.sendResponseToClient(response,createResponseCompletationCallback(phaseResultNotifier,exceptionHandler));
      }
    }
 catch (    final MessagingException e) {
      template.sendFailureResponseToClient(e,createSendFailureResponseCompletationCallback(phaseResultNotifier));
    }
  }
 catch (  Exception e) {
    phaseResultNotifier.phaseFailure(e);
  }
}
