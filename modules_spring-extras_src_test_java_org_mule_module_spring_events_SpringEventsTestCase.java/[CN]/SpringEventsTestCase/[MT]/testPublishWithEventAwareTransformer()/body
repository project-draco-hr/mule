{
  CountDownLatch transformerLatch=new CountDownLatch(1);
  TestEventAwareTransformer trans=new TestEventAwareTransformer();
  trans.setLatch(transformerLatch);
  muleContext.getRegistry().registerTransformer(trans);
  MuleApplicationEvent event=new MuleApplicationEvent("MuleEvent from a spring bean","vm://testBean2?transformers=dummyTransformer");
  TestSubscriptionEventBean bean2=(TestSubscriptionEventBean)muleContext.getRegistry().lookupObject("testSubscribingEventBean2");
  assertNotNull(bean2);
  Latch whenFinished=new Latch();
  bean2.setEventCallback(new CountingEventCallback(eventCounter1,1,whenFinished));
  this.doPublish(event,1);
  whenFinished.await(DEFAULT_LATCH_TIMEOUT,TimeUnit.MILLISECONDS);
  assertTrue(transformerLatch.await(DEFAULT_LATCH_TIMEOUT,TimeUnit.MILLISECONDS));
  assertEquals(1,eventCounter1.get());
}
