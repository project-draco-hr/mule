{
  FileOutputStream fos=(FileOutputStream)connector.getOutputStream(getEndpoint(),event);
  try {
    MuleMessage.Builder messageBuilder=MuleMessage.builder(event.getMessage());
    if (event.getMessage().getOutboundProperty(PROPERTY_FILENAME) == null) {
      messageBuilder.addOutboundProperty(PROPERTY_FILENAME,event.getMessage().getOutboundProperty(PROPERTY_FILENAME,EMPTY));
    }
    event=MuleEvent.builder(event).message(messageBuilder.build()).build();
    Object data=event.getMessage().getPayload();
    if (data instanceof byte[]) {
      fos.write((byte[])data);
    }
 else     if (data instanceof String) {
      fos.write(data.toString().getBytes(resolveEncoding(event)));
    }
 else     if (data instanceof OutputHandler) {
      ((OutputHandler)data).write(event,fos);
    }
 else {
      InputStream is=(InputStream)event.transformMessage(DataType.fromType(InputStream.class),muleContext);
      IOUtils.copyLarge(is,fos);
      is.close();
    }
  }
  finally {
    logger.debug("Closing file");
    fos.close();
  }
}
