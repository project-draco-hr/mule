{
  final int connectorRedelivery=connector.getMaxRedelivery();
  if (connectorRedelivery == JmsConnector.REDELIVERY_SWALLOW_MESSAGE || connectorRedelivery < 0) {
    return;
  }
  String messageId=message.getJMSMessageID();
  int deliveryCount=-1;
  try {
    deliveryCount=message.getIntProperty(JmsConstants.JMS_X_DELIVERY_COUNT);
  }
 catch (  NumberFormatException nex) {
    throw new MuleRuntimeException(MessageFactory.createStaticMessage(String.format("Invalid use of %s. Message is flagged with JMSRedelivered, but JMSXDeliveryCount is not set",getClass().getName())));
  }
  int redeliveryCount=deliveryCount - 1;
  if (redeliveryCount == 1) {
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + messageId + " has been redelivered for the first time");
    }
    if (connectorRedelivery == JmsConnector.REDELIVERY_FAIL_ON_FIRST) {
      JmsMessageAdapter adapter=(JmsMessageAdapter)connector.getMessageAdapter(message);
      throw new MessageRedeliveredException(JmsMessages.tooManyRedeliveries(messageId,String.valueOf(redeliveryCount),connectorRedelivery,connector.getName()),new DefaultMuleMessage(adapter,connector.getMuleContext()));
    }
  }
 else   if (redeliveryCount > connectorRedelivery) {
    logger.debug(MessageFormat.format("Message with id: {0} has been redelivered {1} times, which exceeds the maxRedelivery setting " + "of {2} on the connector {3}",messageId,redeliveryCount,connectorRedelivery,connector.getName()));
    JmsMessageAdapter adapter=(JmsMessageAdapter)connector.getMessageAdapter(message);
    throw new MessageRedeliveredException(JmsMessages.tooManyRedeliveries(messageId,String.valueOf(redeliveryCount),connectorRedelivery,connector.getName()),new DefaultMuleMessage(adapter,connector.getMuleContext()));
  }
 else {
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + messageId + " has been redelivered "+ redeliveryCount+ " times");
    }
  }
}
