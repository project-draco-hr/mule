{
  builder.chain(new LoggingInterceptor());
  builder.chain(new FlowConstructStatisticsMessageObserver());
  EventReturningMessageProcessor outboundMessageProcessor=new EventReturningMessageProcessor();
  outboundMessageProcessor.setListener(outboundEndpoint);
  ResponseMessageProcessorAdapter ackResponseMessageProcessor=new ResponseMessageProcessorAdapter();
  ackResponseMessageProcessor.setListener(outboundMessageProcessor);
  ackResponseMessageProcessor.setProcessor(getExpressionTransformer(getName() + "-ack-expression",ackExpression));
  final ChoiceRouter choiceRouter=new ChoiceRouter();
  choiceRouter.addRoute(ackResponseMessageProcessor,validationFilter);
  choiceRouter.setDefaultRoute(getExpressionTransformer(getName() + "-nack-expression",nackExpression));
  builder.chain(choiceRouter);
}
