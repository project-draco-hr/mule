{
  out.defaultWriteObject();
  if (payload instanceof Serializable) {
    out.writeBoolean(true);
    out.writeObject(payload);
  }
 else {
    out.writeBoolean(false);
    byte[] serializablePayload=getPayloadAsBytes();
    out.writeInt(serializablePayload.length);
    new DataOutputStream(out).write(serializablePayload);
  }
  out.writeObject(serializeAttachments(inboundAttachments));
  out.writeObject(serializeAttachments(outboundAttachments));
}
