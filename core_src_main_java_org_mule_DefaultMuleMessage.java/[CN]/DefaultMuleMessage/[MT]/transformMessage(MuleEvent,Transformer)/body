{
  Object result;
  if (transformer instanceof MessageTransformer) {
    result=((MessageTransformer)transformer).transform(this,event);
  }
 else {
    result=transformer.transform(this);
  }
  RequestContext.internalRewriteEvent(this,false);
  if (originalPayload == null && muleContext.getConfiguration().isCacheMessageOriginalPayload()) {
    originalPayload=payload;
  }
  if (result instanceof MuleMessage) {
    if (!result.equals(this)) {
synchronized (this) {
        MuleMessage resultMessage=(MuleMessage)result;
        setPayload(resultMessage.getPayload(),resultMessage.getDataType());
        originalPayload=resultMessage.getOriginalPayload();
        copyMessageProperties(resultMessage);
        copyAttachments(resultMessage);
      }
    }
  }
 else {
    final DataType<?> mergedDataType=mergeDataType(dataType,transformer.getReturnDataType());
    setPayload(result,mergedDataType);
  }
}
