{
  in.defaultReadObject();
  boolean payloadWasSerialized=in.readBoolean();
  if (payloadWasSerialized) {
    payload=in.readObject();
  }
 else {
    int payloadSize=in.readInt();
    byte[] serializedPayload=new byte[payloadSize];
    new DataInputStream(in).readFully(serializedPayload);
    payload=serializedPayload;
  }
  inboundAttachments=deserializeAttachments((Map<String,SerializedDataHandler>)in.readObject());
  outboundAttachments=deserializeAttachments((Map<String,SerializedDataHandler>)in.readObject());
}
