{
  String scheme=uriBuilder.getEndpoint().getFullScheme();
  Connector connector;
  try {
    if (uriBuilder.getEndpoint().getConnectorName() != null) {
      connector=muleContext.getRegistry().lookupConnector(uriBuilder.getEndpoint().getConnectorName());
      if (connector == null) {
        throw new TransportFactoryException(CoreMessages.objectNotRegistered("Connector",uriBuilder.getEndpoint().getConnectorName()));
      }
    }
 else {
      TransportFactory factory=new TransportFactory(muleContext);
      connector=factory.getConnectorByProtocol(scheme);
      if (connector == null) {
        connector=factory.createConnector(endpointURI,muleContext);
        muleContext.getRegistry().registerConnector(connector);
      }
    }
  }
 catch (  Exception e) {
    throw new TransportFactoryException(e);
  }
  if (connector == null) {
    Message m=CoreMessages.failedToCreateObjectWith("Endpoint","endpointURI: " + endpointURI);
    m.setNextMessage(CoreMessages.objectIsNull("connector"));
    throw new TransportFactoryException(m);
  }
  return connector;
}
