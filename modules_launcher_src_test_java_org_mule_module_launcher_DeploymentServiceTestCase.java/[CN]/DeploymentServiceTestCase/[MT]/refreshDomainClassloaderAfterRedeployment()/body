{
  deploymentService.start();
  addPackedDomainFromBuilder(sharedHttpDomainFileBuilder);
  long firstFileTimestamp=new File(sharedHttpDomainFileBuilder.getZipPath()).lastModified();
  addPackedAppFromBuilder(httpAAppFileBuilder);
  addPackedAppFromBuilder(httpBAppFileBuilder);
  assertDeploymentSuccess(domainDeploymentListener,sharedHttpDomainFileBuilder.getId());
  assertDeploymentSuccess(applicationDeploymentListener,httpAAppFileBuilder.getId());
  assertDeploymentSuccess(applicationDeploymentListener,httpBAppFileBuilder.getId());
  Domain domain=findADomain(sharedHttpDomainFileBuilder.getId(),1);
  assertThat(domain.getMuleContext().getRegistry().get("http-listener-config"),not(is(nullValue())));
  ArtifactClassLoader initialArtifactClassLoader=domain.getArtifactClassLoader();
  reset(domainDeploymentListener);
  reset(applicationDeploymentListener);
  File domainFolder=new File(domainsDir.getPath(),sharedHttpDomainFileBuilder.getId());
  File configFile=new File(domainFolder,sharedHttpDomainFileBuilder.getConfigFile());
  FileUtils.touch(configFile);
  alterTimestampIfNeeded(configFile,firstFileTimestamp);
  assertUndeploymentSuccess(applicationDeploymentListener,httpAAppFileBuilder.getId());
  assertUndeploymentSuccess(applicationDeploymentListener,httpBAppFileBuilder.getId());
  assertUndeploymentSuccess(domainDeploymentListener,sharedHttpDomainFileBuilder.getId());
  assertDeploymentSuccess(domainDeploymentListener,sharedHttpDomainFileBuilder.getId());
  assertDeploymentSuccess(applicationDeploymentListener,httpAAppFileBuilder.getId());
  assertDeploymentSuccess(applicationDeploymentListener,httpBAppFileBuilder.getId());
  domain=findADomain(sharedHttpDomainFileBuilder.getId(),1);
  ArtifactClassLoader artifactClassLoaderAfterRedeployment=domain.getArtifactClassLoader();
  assertThat(artifactClassLoaderAfterRedeployment,not(sameInstance(initialArtifactClassLoader)));
  removeAppAnchorFile(httpAAppFileBuilder.getId());
  removeAppAnchorFile(httpBAppFileBuilder.getId());
  removeDomainAnchorFile(sharedHttpDomainFileBuilder.getId());
  assertUndeploymentSuccess(applicationDeploymentListener,httpAAppFileBuilder.getId());
  assertUndeploymentSuccess(applicationDeploymentListener,httpBAppFileBuilder.getId());
  assertUndeploymentSuccess(domainDeploymentListener,sharedHttpDomainFileBuilder.getId());
}
