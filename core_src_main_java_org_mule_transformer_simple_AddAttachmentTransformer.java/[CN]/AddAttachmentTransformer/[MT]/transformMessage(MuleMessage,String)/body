{
  try {
    Object keyValue=nameEvaluator.resolveValue(message);
    if (keyValue == null) {
      logger.error("Setting Null attachment key is not supported, this entry is being ignored");
    }
 else {
      String key=keyValue.toString();
      Object value=valueEvaluator.resolveValue(message);
      if (value == null) {
        logger.info(MessageFormat.format("Attachment with key '{0}', not found on message using '{1}'. Since the value was marked optional, nothing was set on the message for this attachment",key,valueEvaluator.getRawValue()));
      }
 else {
        String contentType=contentTypeEvaluator.resolveValue(message).toString();
        message.addOutboundAttachment(key,value,contentType);
      }
    }
    return message;
  }
 catch (  Exception e) {
    throw new TransformerException(this,e);
  }
}
