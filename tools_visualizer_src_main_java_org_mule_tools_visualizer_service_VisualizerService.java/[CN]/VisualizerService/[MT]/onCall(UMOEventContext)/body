{
  UMOMessage msg=eventContext.getMessage();
  Set names=msg.getAttachmentNames();
  if (names.size() == 0) {
    throw new IllegalArgumentException("There were no files attached to process");
  }
  List files=new ArrayList(names.size());
  for (Iterator iterator=names.iterator(); iterator.hasNext(); ) {
    String s=(String)iterator.next();
    DataHandler dh=msg.getAttachment(s);
    if (dh.getDataSource().getContentType().startsWith("text/xml")) {
      files.add(dh.getInputStream());
    }
  }
  if (files.size() == 0) {
    throw new IllegalArgumentException("There were no Xml attachments for email: " + msg.getProperty("subject"));
  }
  List results=visualizer.visualize(files);
  UMOMessage result=new MuleMessage("Thanks for using Mule Visualizer!");
  if (results == null) {
    return null;
  }
  for (Iterator iterator=results.iterator(); iterator.hasNext(); ) {
    String s=(String)iterator.next();
    File f=new File(s);
    FileDataSource ds=new FileDataSource(f);
    result.addAttachment(f.getName(),new DataHandler(ds));
  }
  for (Iterator iterator=names.iterator(); iterator.hasNext(); ) {
    String s=(String)iterator.next();
    result.addAttachment(s,msg.getAttachment(s));
  }
  return result;
}
