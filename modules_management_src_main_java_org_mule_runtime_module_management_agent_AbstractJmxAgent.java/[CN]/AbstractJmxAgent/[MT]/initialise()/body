{
  if (initialized.get()) {
    return;
  }
  this.containerMode=muleContext.getConfiguration().isContainerMode();
  try {
    Object agent=muleContext.getRegistry().lookupObject(this.getClass());
    if (agent == this && this.initialized.get()) {
      if (logger.isDebugEnabled()) {
        logger.debug("Found an existing JMX agent in the registry, we're done here.");
      }
      return;
    }
  }
 catch (  Exception e) {
    throw new InitialisationException(e,this);
  }
  if (mBeanServer == null && createServer) {
    mBeanServer=MBeanServerFactory.createMBeanServer();
    serverCreated.set(true);
  }
  if (mBeanServer == null && locateServer) {
    mBeanServer=ManagementFactory.getPlatformMBeanServer();
  }
  if (mBeanServer == null) {
    throw new InitialisationException(ManagementMessages.cannotLocateOrCreateServer(),this);
  }
  if (StringUtils.isBlank(muleContext.getConfiguration().getId())) {
    throw new IllegalArgumentException("Manager ID is mandatory when running with JmxAgent. Give your Mule configuration a valid ID.");
  }
  try {
    muleContextStartedListener=new MuleContextStartedListener();
    muleContext.registerListener(muleContextStartedListener);
    muleContextStoppedListener=new MuleContextStoppedListener();
    muleContext.registerListener(muleContextStoppedListener);
  }
 catch (  NotificationException e) {
    throw new InitialisationException(e,this);
  }
  initialized.compareAndSet(false,true);
}
