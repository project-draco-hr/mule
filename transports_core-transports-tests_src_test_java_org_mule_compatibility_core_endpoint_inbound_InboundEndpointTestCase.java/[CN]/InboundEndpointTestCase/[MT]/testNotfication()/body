{
  TestEndpointMessageNotificationListener listener=new TestEndpointMessageNotificationListener();
  muleContext.registerListener(listener);
  endpoint=createTestInboundEndpoint(null,null,null,null,REQUEST_RESPONSE,null);
  endpoint.setListener(inboundListener);
  endpoint.setFlowConstruct(getTestFlow(muleContext));
  requestEvent=createTestRequestEvent(endpoint);
  responseEvent=createTestResponseEvent(endpoint);
  Processor mpChain=((AbstractEndpoint)endpoint).getMessageProcessorChain(endpoint.getFlowConstruct());
  result=mpChain.process(requestEvent);
  assertTrue(listener.latch.await(RECEIVE_TIMEOUT,TimeUnit.MILLISECONDS));
  assertEquals(EndpointMessageNotification.MESSAGE_RECEIVED,listener.messageNotification.getAction());
  assertEquals(endpoint.getEndpointURI().getUri().toString(),listener.messageNotification.getEndpoint());
  assertTrue(listener.messageNotification.getSource() instanceof InternalMessage);
  assertThat(listener.messageNotification.getSource().getPayload().getValue(),equalTo(inMessage.getPayload().getValue()));
}
