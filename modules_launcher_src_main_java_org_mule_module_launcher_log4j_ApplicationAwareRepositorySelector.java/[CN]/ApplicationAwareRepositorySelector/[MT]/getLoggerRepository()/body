{
  final ClassLoader ccl=Thread.currentThread().getContextClassLoader();
  LoggerRepository repository=this.repository.get(ccl.hashCode());
  if (repository == null) {
    final RootLogger root=new RootLogger(Level.INFO);
    repository=new Hierarchy(root);
    try {
      if (ccl instanceof MuleApplicationClassLoader) {
        MuleApplicationClassLoader muleCL=(MuleApplicationClassLoader)ccl;
        final URL appLogConfig=muleCL.findResource("log4j.properties");
        if (appLogConfig == null) {
          String logName=String.format("mule-app-%s.log",muleCL.getAppName());
          File logDir=new File(MuleContainerBootstrapUtils.getMuleHome(),"logs");
          File logFile=new File(logDir,logName);
          RollingFileAppender fileAppender=new RollingFileAppender(new PatternLayout(PATTERN_LAYOUT),logFile.getAbsolutePath(),true);
          fileAppender.setMaxBackupIndex(100);
          fileAppender.setMaximumFileSize(1000000);
          fileAppender.activateOptions();
          root.addAppender(fileAppender);
        }
 else {
          new PropertyConfigurator().doConfigure(appLogConfig,repository);
        }
      }
 else {
        final File defaultSystemLog=new File(MuleContainerBootstrapUtils.getMuleHome(),"conf/log4j.properties");
        new PropertyConfigurator().doConfigure(defaultSystemLog.getAbsolutePath(),repository);
      }
      final LoggerRepository previous=this.repository.putIfAbsent(ccl.hashCode(),repository);
      if (previous != null) {
        repository=previous;
      }
    }
 catch (    IOException e) {
      throw new RuntimeException(e);
    }
  }
  return repository;
}
