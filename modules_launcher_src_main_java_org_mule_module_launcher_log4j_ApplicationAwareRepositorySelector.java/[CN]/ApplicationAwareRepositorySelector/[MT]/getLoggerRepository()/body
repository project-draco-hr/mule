{
  final ClassLoader ccl=Thread.currentThread().getContextClassLoader();
  LoggerRepository repository=this.repository.get(ccl.hashCode());
  if (repository == null) {
    final RootLogger root=new RootLogger(Level.INFO);
    repository=new Hierarchy(root);
    try {
      ConfigWatchDog configWatchDog=null;
      if (ccl instanceof MuleApplicationClassLoader) {
        MuleApplicationClassLoader muleCL=(MuleApplicationClassLoader)ccl;
        URL appLogConfig=muleCL.findResource("log4j.xml");
        if (appLogConfig == null) {
          appLogConfig=muleCL.findResource("log4j.properties");
        }
        final String appName=muleCL.getAppName();
        if (appLogConfig == null) {
          String logName=String.format("mule-app-%s.log",appName);
          File logDir=new File(MuleContainerBootstrapUtils.getMuleHome(),"logs");
          File logFile=new File(logDir,logName);
          RollingFileAppender fileAppender=new RollingFileAppender(new PatternLayout(PATTERN_LAYOUT),logFile.getAbsolutePath(),true);
          fileAppender.setMaxBackupIndex(100);
          fileAppender.setMaximumFileSize(1000000);
          fileAppender.activateOptions();
          root.addAppender(fileAppender);
        }
 else {
          configureFrom(appLogConfig,repository);
          if (appLogConfig.toExternalForm().startsWith("file:")) {
            configWatchDog=new ConfigWatchDog(appLogConfig.getFile(),repository);
            configWatchDog.setName(String.format("[%s].log4j.config.watchdog",appName));
          }
 else {
            if (logger.isInfoEnabled()) {
              logger.info(String.format("Logging config %s is not an external file, will not be monitored for changes",appLogConfig));
            }
          }
        }
      }
 else {
        File defaultSystemLog=new File(MuleContainerBootstrapUtils.getMuleHome(),"conf/log4j.xml");
        if (defaultSystemLog.exists() && defaultSystemLog.canRead()) {
          new DOMConfigurator().doConfigure(defaultSystemLog.getAbsolutePath(),repository);
        }
 else {
          defaultSystemLog=new File(MuleContainerBootstrapUtils.getMuleHome(),"conf/log4j.properties");
          new PropertyConfigurator().doConfigure(defaultSystemLog.getAbsolutePath(),repository);
        }
      }
      final LoggerRepository previous=this.repository.putIfAbsent(ccl.hashCode(),repository);
      if (previous != null) {
        repository=previous;
      }
      if (configWatchDog != null) {
        configWatchDog.start();
      }
    }
 catch (    IOException e) {
      throw new RuntimeException(e);
    }
  }
  return repository;
}
