{
  FtpFileAttributes attributes=getExistingFile(filePath);
  if (attributes.isDirectory()) {
    throw cannotReadDirectoryException(Paths.get(attributes.getPath()));
  }
  Path path=Paths.get(attributes.getPath());
  PathLock pathLock;
  if (lock) {
    pathLock=fileSystem.lock(path);
  }
 else {
    fileSystem.verifyNotLocked(path);
    pathLock=new NullPathLock();
  }
  try {
    InputStream payload=SftpInputStream.newInstance((FtpConnector)config,attributes,pathLock);
    MediaType mediaType=fileSystem.getFileMessageMediaType(message.getPayload().getDataType().getMediaType(),attributes);
    return OperationResult.<InputStream,FileAttributes>builder().output(payload).mediaType(mediaType).attributes(attributes).build();
  }
 catch (  ConnectionException e) {
    throw exception("Could not obtain connection to fetch file " + path,e);
  }
}
