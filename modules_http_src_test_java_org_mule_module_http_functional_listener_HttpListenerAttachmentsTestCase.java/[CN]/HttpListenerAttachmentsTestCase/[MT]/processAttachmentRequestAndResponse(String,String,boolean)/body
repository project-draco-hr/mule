{
  CloseableHttpClient httpClient=HttpClients.createDefault();
  try {
    HttpPost httpPost=new HttpPost(getUrl(pathToCall));
    HttpEntity multipart=createHttpEntity(useChunkedMode);
    httpPost.setEntity(multipart);
    final CloseableHttpResponse response=httpClient.execute(httpPost);
    try {
      final MuleMessage receivedMessage=muleContext.getClient().request("test://out",1000);
      assertThat(receivedMessage.getPayload(),Is.<Object>is(NullPayload.getInstance()));
      assertThat(receivedMessage.getInboundAttachmentNames().size(),is(2));
      assertThat(receivedMessage.getInboundAttachmentNames().contains(TEXT_BODY_FIELD_NAME),is(true));
      assertThat(new String(((HttpPartDataSource)receivedMessage.getInboundAttachment(TEXT_BODY_FIELD_NAME).getDataSource()).getContent()),Is.<Object>is(TEXT_BODY_FIELD_VALUE));
      assertThat(receivedMessage.getInboundAttachmentNames().contains(FILE_BODY_FIELD_NAME),is(true));
      assertThat(new String(((HttpPartDataSource)receivedMessage.getInboundAttachment(FILE_BODY_FIELD_NAME).getDataSource()).getContent()),Is.<Object>is(FILE_BODY_FIELD_VALUE));
      final String contentType=response.getFirstHeader(HttpHeaders.Names.CONTENT_TYPE).getValue();
      assertThat(contentType,Matchers.containsString(expectedResponseContentType));
      final Collection<HttpPart> parts=HttpParser.parseMultipartContent(response.getEntity().getContent(),contentType);
      assertThat(parts.size(),Is.is(2));
      Map<String,Part> partsAsMap=convertPartsToMap(parts);
      assertThat(partsAsMap.get(TEXT_BODY_FIELD_NAME),IsNull.notNullValue());
      assertThat(partsAsMap.get(FILE_BODY_FIELD_NAME),IsNull.notNullValue());
      assertThat(IOUtils.toString(partsAsMap.get(TEXT_BODY_FIELD_NAME).getInputStream()),is(TEXT_BODY_FIELD_VALUE));
      assertThat(IOUtils.toString(partsAsMap.get(FILE_BODY_FIELD_NAME).getInputStream()),is(FILE_BODY_FIELD_VALUE));
    }
  finally {
      response.close();
    }
  }
  finally {
    httpClient.close();
  }
}
