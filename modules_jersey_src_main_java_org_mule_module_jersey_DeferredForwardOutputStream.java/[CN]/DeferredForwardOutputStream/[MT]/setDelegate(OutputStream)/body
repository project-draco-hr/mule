{
  checkState(this.delegate == null,"delegate can only be set once");
  this.delegate=delegate;
  try {
    for (    DeferredWrite deferred : deferredWrites) {
      deferred.write(delegate);
    }
    if (closeRequested) {
      close();
    }
  }
  finally {
    deferredWrites.clear();
  }
}
