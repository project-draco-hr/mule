{
  HashMap props=new HashMap();
  managementContext.getRegistry().registerConnector(createConnector(false),managementContext);
  UMOEndpoint endpoint=new MuleEndpoint(getTestEndpointURI(),false);
  managementContext.getRegistry().registerService(MuleTestUtils.createDescriptor(FunctionalTestComponent.class.getName(),"testComponent",null,endpoint,props),managementContext);
  UMOMessage message=new MuleMessage(MESSAGE);
  message.setStringProperty(MailProperties.TO_ADDRESSES_PROPERTY,EMAIL);
  UMOSession session=getTestSession(getTestComponent(getTestDescriptor("apple",Apple.class.getName())));
  MuleEvent event=new MuleEvent(message,endpoint,session,true,new ResponseOutputStream(System.out));
  endpoint.dispatch(event);
  getServers().waitForIncomingEmail(DELIVERY_DELAY_MS,1);
  MimeMessage[] messages=getServers().getReceivedMessages();
  assertNotNull("did not receive any messages",messages);
  assertEquals("did not receive 1 mail",1,messages.length);
  assertMessageOk(messages[0]);
}
