{
  UMOImmutableEndpoint endpoint=managementContext.getRegistry().lookupEndpointFactory().createOutboundEndpoint(getTestEndpointURI(),managementContext);
  UMOComponent component=getTestComponent(uniqueName("testComponent"),FunctionalTestComponent.class);
  ((OutboundPassThroughRouter)component.getOutboundRouter().getRouters().get(0)).addEndpoint(endpoint);
  managementContext.getRegistry().registerComponent(component,managementContext);
  UMOMessage message=new MuleMessage(MESSAGE);
  message.setStringProperty(MailProperties.TO_ADDRESSES_PROPERTY,EMAIL);
  UMOSession session=getTestSession(getTestComponent("apple",Apple.class));
  MuleEvent event=new MuleEvent(message,endpoint,session,true,new ResponseOutputStream(System.out));
  endpoint.dispatch(event);
  getServers().waitForIncomingEmail(DELIVERY_DELAY_MS,1);
  MimeMessage[] messages=getServers().getReceivedMessages();
  assertNotNull("did not receive any messages",messages);
  assertEquals("did not receive 1 mail",1,messages.length);
  assertMessageOk(messages[0]);
}
