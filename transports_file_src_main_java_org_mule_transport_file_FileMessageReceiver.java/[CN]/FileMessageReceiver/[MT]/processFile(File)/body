{
  boolean checkFileAge=fileConnector.getCheckFileAge();
  if (checkFileAge) {
    long fileAge=fileConnector.getFileAge();
    long lastMod=file.lastModified();
    long now=System.currentTimeMillis();
    long thisFileAge=now - lastMod;
    if (thisFileAge < fileAge) {
      if (logger.isDebugEnabled()) {
        logger.debug("The file has not aged enough yet, will return nothing for: " + file);
      }
      return;
    }
  }
  if (!(file.canRead() && file.exists() && file.isFile())) {
    throw new DefaultMuleException(FileMessages.fileDoesNotExist(file.getName()));
  }
  if (!attemptFileLock(file)) {
    return;
  }
 else   if (logger.isInfoEnabled()) {
    logger.info("Lock obtained on file: " + file.getAbsolutePath());
  }
  DefaultMuleMessage fileParserMessasge=new DefaultMuleMessage(null,connector.getMuleContext());
  fileParserMessasge.setOutboundProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,file.getName());
  final String originalSourceFile=file.getAbsolutePath();
  final String originalSourceFileName=file.getName();
  final File sourceFile;
  if (workDir != null) {
    String workFileName=file.getName();
    workFileName=fileConnector.getFilenameParser().getFilename(fileParserMessasge,workFileNamePattern);
    File workFile=FileUtils.newFile(workDir,workFileName);
    fileConnector.move(file,workFile);
    sourceFile=workFile;
  }
 else {
    sourceFile=file;
  }
  file=null;
  File destinationFile=null;
  if (moveDir != null) {
    String destinationFileName=originalSourceFileName;
    if (moveToPattern != null) {
      destinationFileName=fileConnector.getFilenameParser().getFilename(fileParserMessasge,moveToPattern);
    }
    destinationFile=FileUtils.newFile(moveDir,destinationFileName);
  }
  MuleMessage message=null;
  String encoding=endpoint.getEncoding();
  try {
    if (fileConnector.isStreaming()) {
      ReceiverFileInputStream payload=new ReceiverFileInputStream(sourceFile,fileConnector.isAutoDelete(),destinationFile);
      message=createMuleMessage(payload,encoding);
    }
 else {
      message=createMuleMessage(sourceFile,encoding);
    }
  }
 catch (  FileNotFoundException e) {
    logger.error("File being read disappeared!",e);
    return;
  }
  message.setOutboundProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,originalSourceFileName);
  if (forceSync) {
    message.setProperty(MuleProperties.MULE_FORCE_SYNC_PROPERTY,Boolean.TRUE,PropertyScope.INBOUND);
  }
  final Object originalPayload=message.getPayload();
  try {
    TransactionTemplate<Void> mainTransactionTemplate=TransactionTemplateFactory.<Void>createMainTransactionTemplate(endpoint.getTransactionConfig(),connector.getMuleContext());
    final File finalDestinationFile=destinationFile;
    final MuleMessage finalMessage=message;
    mainTransactionTemplate.execute(new TransactionCallback<Void>(){
      @Override public Void doInTransaction() throws Exception {
        if (!fileConnector.isStreaming()) {
          moveAndDelete(sourceFile,finalDestinationFile,originalSourceFileName,finalMessage);
        }
 else {
          try {
            finalMessage.setOutboundProperty(FileConnector.PROPERTY_FILENAME,sourceFile.getName());
            FileMessageReceiver.this.routeMessage(finalMessage);
          }
 catch (          Exception e) {
            if (originalPayload instanceof ReceiverFileInputStream) {
              ((ReceiverFileInputStream)originalPayload).setStreamProcessingError(true);
            }
            throw e;
          }
        }
        return null;
      }
    }
);
  }
 catch (  Exception e) {
    RollbackSourceCallback rollbackMethod=null;
    if (fileConnector.isStreaming()) {
      if (originalPayload instanceof ReceiverFileInputStream) {
        final ReceiverFileInputStream receiverFileInputStream=(ReceiverFileInputStream)originalPayload;
        rollbackMethod=new RollbackSourceCallback(){
          @Override public void rollback(){
            receiverFileInputStream.setStreamProcessingError(true);
          }
        }
;
      }
    }
 else     if (!sourceFile.getAbsolutePath().equals(originalSourceFile)) {
      rollbackMethod=new RollbackSourceCallback(){
        @Override public void rollback(){
          try {
            rollbackFileMove(sourceFile,originalSourceFile);
          }
 catch (          IOException iox) {
            logger.warn(iox);
          }
        }
      }
;
    }
    if (e instanceof MessagingException) {
      if (((MessagingException)e).getEvent().getMessage().getExceptionPayload() != null && rollbackMethod != null) {
        rollbackMethod.rollback();
      }
    }
 else {
      connector.getMuleContext().getExceptionListener().handleException(e,rollbackMethod);
    }
  }
}
