{
  if (fileConnector.getCheckFileAge() && !isAgedFile(file,fileConnector.getFileAge())) {
    removeProcessingMark(file.getAbsolutePath());
    return;
  }
  if (!(file.canRead() && file.exists() && file.isFile())) {
    throw new DefaultMuleException(FileMessages.fileDoesNotExist(file.getName()));
  }
  if (!attemptFileLock(file)) {
    return;
  }
 else   if (logger.isInfoEnabled()) {
    logger.info("Lock obtained on file: " + file.getAbsolutePath());
  }
  final String originalSourceFilePath=file.getAbsolutePath();
  final String originalSourceFileName=file.getName();
  final String originalSourceDirectory=file.getParent();
  DefaultMuleMessage fileParserMessasge=new DefaultMuleMessage(null,getEndpoint().getMuleContext());
  fileParserMessasge.setInboundProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,originalSourceFileName);
  fileParserMessasge.setInboundProperty(FileConnector.PROPERTY_ORIGINAL_DIRECTORY,originalSourceDirectory);
  final File sourceFile;
  if (workDir != null) {
    String workFileName=fileConnector.getFilenameParser().getFilename(fileParserMessasge,workFileNamePattern);
    File workFile=FileUtils.newFile(workDir,workFileName);
    fileConnector.move(file,workFile);
    sourceFile=workFile;
  }
 else {
    sourceFile=file;
  }
  File destinationFile=null;
  if (moveDir != null) {
    String destinationFileName=originalSourceFileName;
    if (moveToPattern != null) {
      destinationFileName=fileConnector.getFilenameParser().getFilename(fileParserMessasge,moveToPattern);
    }
    destinationFile=FileUtils.newFile(moveDir,destinationFileName);
  }
  MuleMessage message=null;
  String encoding=endpoint.getEncoding();
  try {
    if (fileConnector.isStreaming()) {
      ReceiverFileInputStream payload=createReceiverFileInputStream(sourceFile,destinationFile,new InputStreamCloseListener(){
        @Override public void fileClose(        File file){
          removeProcessingMark(file.getAbsolutePath());
        }
      }
);
      message=createMuleMessage(payload,encoding);
    }
 else {
      message=createMuleMessage(sourceFile,encoding);
    }
  }
 catch (  FileNotFoundException e) {
    logger.error("File being read disappeared!",e);
    return;
  }
  if (workDir != null) {
    message.setProperty(FileConnector.PROPERTY_SOURCE_DIRECTORY,file.getParent(),PropertyScope.INBOUND);
    message.setProperty(FileConnector.PROPERTY_SOURCE_FILENAME,file.getName(),PropertyScope.INBOUND);
  }
  message.setProperty(FileConnector.PROPERTY_ORIGINAL_DIRECTORY,originalSourceDirectory,PropertyScope.INBOUND);
  message.setProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,originalSourceFileName,PropertyScope.INBOUND);
  message.setInvocationProperty(FileConnector.PROPERTY_ORIGINAL_DIRECTORY,originalSourceDirectory);
  message.setInvocationProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,originalSourceFileName);
  if (forceSync) {
    message.setProperty(MuleProperties.MULE_FORCE_SYNC_PROPERTY,Boolean.TRUE,PropertyScope.INBOUND);
  }
  final Object originalPayload=message.getPayload();
  ExecutionTemplate<MuleEvent> executionTemplate=createExecutionTemplate();
  final MuleMessage finalMessage=message;
  if (fileConnector.isStreaming()) {
    processWithStreaming(sourceFile,(ReceiverFileInputStream)originalPayload,executionTemplate,finalMessage);
  }
 else {
    processWithoutStreaming(originalSourceFilePath,originalSourceFileName,originalSourceDirectory,sourceFile,destinationFile,executionTemplate,finalMessage);
  }
}
