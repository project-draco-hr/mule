{
  Flow flow=(Flow)getFlowConstruct("limitedConnections");
  Thread t1=processAsynchronously(flow);
  messageArrived.await();
  try {
    flow.process(createEvent(SMALL_RESPONSE_TIMEOUT));
    fail("Max connections should be reached.");
  }
 catch (  MessagingException e) {
    assertThat(e.getCause(),instanceOf(IOException.class));
  }
  messageHold.release();
  t1.join();
}
