{
  Object msg;
  if (isMimeMessage) {
    msg=GreenMailUtilities.toMessage(message,email,charset);
  }
 else {
    msg=message;
  }
  MuleClient client=muleContext.getClient();
  if (addAttachments) {
    MuleMessage muleMessage=new DefaultMuleMessage(msg,muleContext);
    createOutboundAttachments(muleMessage);
    client.dispatch("vm://send",muleMessage);
  }
 else {
    client.dispatch("vm://send",msg,null);
  }
  server.waitForIncomingEmail(DELIVERY_DELAY_MS,1);
  MimeMessage[] messages=server.getReceivedMessages();
  assertNotNull("did not receive any messages",messages);
  assertEquals("did not receive 1 mail",1,messages.length);
  verifyMessage(messages[0]);
}
