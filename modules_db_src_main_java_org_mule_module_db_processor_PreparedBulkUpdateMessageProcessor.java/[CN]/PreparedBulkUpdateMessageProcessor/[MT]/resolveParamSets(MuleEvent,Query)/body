{
  Object payload;
  if (source == null || source.equals("")) {
    payload=muleEvent.getMessage().getPayload();
  }
 else {
    payload=muleContext.getExpressionManager().evaluate(source,muleEvent);
  }
  if (!(payload instanceof Collection)) {
    throw new IllegalArgumentException("Bulk mode operations require a collection as payload");
  }
  QueryParamResolver queryParamResolver=new DynamicQueryParamResolver(muleContext.getExpressionManager());
  List<List<QueryParamValue>> result=new LinkedList<List<QueryParamValue>>();
  Collection collection=(Collection)payload;
  for (  Object aCollection : collection) {
    MuleMessage itemMessage=new DefaultMuleMessage(aCollection,muleContext);
    MuleEvent itemEvent=new DefaultMuleEvent(itemMessage,muleEvent);
    List<QueryParamValue> queryParamValues=queryParamResolver.resolveParams(itemEvent,query.getParamValues());
    result.add(queryParamValues);
  }
  return result;
}
