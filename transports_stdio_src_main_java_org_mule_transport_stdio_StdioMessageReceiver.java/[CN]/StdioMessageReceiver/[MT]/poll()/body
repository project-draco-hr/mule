{
  String encoding=endpoint.getEncoding();
  try {
    if (sendStream) {
      PushbackInputStream in=new PushbackInputStream(inputStream);
      int i=in.read();
      in.unread(i);
      MuleMessage message=createMuleMessage(in,encoding);
      routeMessage(message);
    }
 else {
      byte[] inputBuffer=new byte[bufferSize];
      int len=inputStream.read(inputBuffer);
      if (len == -1) {
        return;
      }
      StringBuffer fullBuffer=new StringBuffer(bufferSize);
      while (len > 0) {
        fullBuffer.append(new String(inputBuffer,0,len));
        len=0;
        if (inputStream.available() > 0) {
          len=inputStream.read(inputBuffer);
        }
      }
      String[] lines=fullBuffer.toString().split(SystemUtils.LINE_SEPARATOR);
      for (int i=0; i < lines.length; ++i) {
        MuleMessage message=createMuleMessage(lines[i],encoding);
        routeMessage(message);
      }
    }
    doConnect();
  }
 catch (  Exception e) {
    getEndpoint().getMuleContext().getExceptionListener().handleException(e);
  }
}
