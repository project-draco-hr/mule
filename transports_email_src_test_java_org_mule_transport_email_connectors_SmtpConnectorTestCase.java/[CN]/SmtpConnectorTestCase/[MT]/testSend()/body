{
  ImmutableEndpoint endpoint=muleContext.getRegistry().lookupEndpointFactory().getOutboundEndpoint(getTestEndpointURI());
  Service service=getTestService(uniqueName("testComponent"),FunctionalTestComponent.class);
  ((OutboundPassThroughRouter)service.getOutboundRouter().getRouters().get(0)).addEndpoint(endpoint);
  MuleMessage message=new DefaultMuleMessage(MESSAGE);
  message.setStringProperty(MailProperties.TO_ADDRESSES_PROPERTY,EMAIL);
  MuleSession session=getTestSession(getTestService("apple",Apple.class),muleContext);
  DefaultMuleEvent event=new DefaultMuleEvent(message,endpoint,session,true,new ResponseOutputStream(System.out));
  endpoint.dispatch(event);
  getServers().waitForIncomingEmail(DELIVERY_DELAY_MS,1);
  MimeMessage[] messages=getServers().getReceivedMessages();
  assertNotNull("did not receive any messages",messages);
  assertEquals("did not receive 1 mail",1,messages.length);
  assertMessageOk(messages[0]);
}
