{
  Transaction tx=TransactionCoordination.getInstance().getTransaction();
  if (tx != null) {
    if (tx.hasResource(dataSource)) {
      logger.debug("Retrieving connection from current transaction");
      return (Connection)tx.getResource(dataSource);
    }
  }
  logger.debug("Retrieving new connection from data source");
  Connection con=dataSource.getConnection();
  if (tx != null) {
    logger.debug("Binding connection to current transaction");
    try {
      tx.bindResource(dataSource,con);
    }
 catch (    TransactionException e) {
      JdbcUtils.close(con);
      throw new RuntimeException("Could not bind connection to current transaction",e);
    }
  }
  return con;
}
