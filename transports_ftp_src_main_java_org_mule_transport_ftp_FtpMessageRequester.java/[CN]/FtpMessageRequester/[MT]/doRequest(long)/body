{
  FTPClient client=null;
  try {
    client=connector.createFtpClient(endpoint);
    FTPFile fileToProcess;
    if (connector.isFile(endpoint,client)) {
      fileToProcess=client.listFiles(endpoint.getEndpointURI().getPath())[0];
      if (!isValid(fileToProcess,getFilenameFilter())) {
        return null;
      }
    }
 else {
      fileToProcess=findFileToProcess(client);
      if (fileToProcess == null) {
        return null;
      }
    }
    fileToProcess=prepareFile(client,fileToProcess);
    FtpMuleMessageFactory messageFactory=createMuleMessageFactory(client);
    MuleMessage message=messageFactory.create(fileToProcess,endpoint.getEncoding(),endpoint.getMuleContext());
    postProcess(client,fileToProcess,message);
    return message;
  }
  finally {
    connector.releaseFtp(endpoint.getEndpointURI(),client);
  }
}
