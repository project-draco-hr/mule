{
  FTPClient client=null;
  try {
    client=connector.createFtpClient(endpoint);
    FTPFile fileToProcess=findFileToProcess(client);
    if (fileToProcess == null) {
      return null;
    }
    String originalFileName=fileToProcess.getName();
    fileToProcess=prepareFile(client,fileToProcess);
    byte[] payload=retriveFileContents(client,fileToProcess);
    MuleMessage reply=new DefaultMuleMessage(connector.getMessageAdapter(payload),connector.getMuleContext());
    reply.setProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,originalFileName);
    reply.setProperty(FileConnector.PROPERTY_FILE_SIZE,new Long(fileToProcess.getSize()));
    return reply;
  }
  finally {
    connector.releaseFtp(endpoint.getEndpointURI(),client);
  }
}
