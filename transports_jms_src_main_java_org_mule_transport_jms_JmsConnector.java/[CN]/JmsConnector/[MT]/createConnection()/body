{
  if (connectionFactory == null) {
    try {
      connectionFactory=this.createConnectionFactory();
    }
 catch (    NamingException ne) {
      throw new DefaultMuleException(JmsMessages.errorCreatingConnectionFactory(),ne);
    }
  }
  if ((connectionFactoryProperties != null) && !connectionFactoryProperties.isEmpty()) {
    BeanUtils.populateWithoutFail(connectionFactory,connectionFactoryProperties,true);
  }
  connectionFactory=createConnectionFactoryWrapper(connectionFactory);
  Connection connection;
  if (username != null) {
    connection=jmsSupport.createConnection(connectionFactory,username,password);
  }
 else {
    connection=jmsSupport.createConnection(connectionFactory);
  }
  if (connection != null) {
    if (clientId != null && !clientId.equals(connection.getClientID())) {
      connection.setClientID(getClientId());
    }
    if (!embeddedMode) {
      connection.setExceptionListener(this);
    }
  }
  return connection;
}
