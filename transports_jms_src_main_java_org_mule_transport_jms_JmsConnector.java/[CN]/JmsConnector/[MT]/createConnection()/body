{
  ConnectionFactory cf=this.connectionFactory;
  Connection connection;
  try {
    if (cf instanceof XAConnectionFactory && muleContext.getTransactionManager() != null) {
      cf=new ConnectionFactoryWrapper(cf,sameRMOverrideValue);
    }
  }
 catch (  Exception e) {
    throw new InitialisationException(e,this);
  }
  if (username != null) {
    connection=jmsSupport.createConnection(cf,username,password);
  }
 else {
    connection=jmsSupport.createConnection(cf);
  }
  if (connection != null) {
    if (clientId != null && !clientId.equals(connection.getClientID())) {
      connection.setClientID(getClientId());
    }
    if (!embeddedMode) {
      connection.setExceptionListener(this);
    }
  }
  return connection;
}
