{
  if (!isConnected()) {
    throw new ConnectException(MessageFactory.createStaticMessage("Not connected"),this);
  }
  Session session=getSessionFromTransaction();
  if (session != null) {
    return session;
  }
  Transaction tx=TransactionCoordination.getInstance().getTransaction();
  if (logger.isDebugEnabled()) {
    logger.debug(MessageFormat.format("Retrieving new jms session from connection: " + "topic={0}, transacted={1}, ack mode={2}, nolocal={3}",new Object[]{Boolean.valueOf(topic),Boolean.valueOf(transacted),new Integer(acknowledgementMode),Boolean.valueOf(noLocal)}));
  }
  session=jmsSupport.createSession(connection,topic,transacted,acknowledgementMode,noLocal);
  if (tx != null) {
    logger.debug("Binding session " + session + " to current transaction "+ tx);
    try {
      tx.bindResource(connection,session);
    }
 catch (    TransactionException e) {
      closeQuietly(session);
      throw new RuntimeException("Could not bind session to current transaction",e);
    }
  }
  return session;
}
