{
  ConnectionFactory wrappedConnectionFactory=connectionFactory;
  if (connectionFactory instanceof BitronixConnectionFactoryWrapper || connectionFactory instanceof ConnectionFactoryWrapper) {
    return connectionFactory;
  }
  try {
    if (connectionFactory instanceof XAConnectionFactory && muleContext.getTransactionManager() instanceof TransactionManagerWrapper) {
      BitronixConnectionFactoryPoolBuilder builder=new BitronixConnectionFactoryPoolBuilder();
      builder.setConnectionFactory((XAConnectionFactory)connectionFactory);
      builder.setName(getName());
      wrappedConnectionFactory=builder.build(muleContext);
    }
 else {
      if (connectionFactory instanceof XAConnectionFactory && muleContext.getTransactionManager() != null) {
        wrappedConnectionFactory=new ConnectionFactoryWrapper(connectionFactory,sameRMOverrideValue);
      }
    }
    return wrappedConnectionFactory;
  }
 catch (  Exception e) {
    throw new InitialisationException(e,this);
  }
}
