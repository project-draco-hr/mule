{
  MessageProcessingFlowStackManager flowStackManager=mock(MessageProcessingFlowStackManager.class);
  when(applicationContext.getBeansOfType(MessageProcessingFlowStackManager.class)).thenReturn(Collections.singletonMap("flowStackManager",flowStackManager));
  FlowRefFactoryBean flowRefFactoryBean=createDynamicFlowRefFactoryBean(targetSubFlow);
  assertNotSame(targetSubFlow,flowRefFactoryBean.getObject());
  assertNotSame(targetSubFlow,flowRefFactoryBean.getObject());
  verifyProcess(flowRefFactoryBean,targetSubFlow,1);
  verify(flowStackManager,times(2)).onFlowStart(any(MuleEvent.class),eq(PARSED_DYNAMIC_REFERENCED_FLOW));
  verify(flowStackManager,times(2)).onFlowComplete(any(MuleEvent.class));
}
