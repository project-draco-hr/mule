{
  Fault f=(Fault)message.getContent(Exception.class);
  Throwable cause=f.getCause();
  if (cause == null) {
    return;
  }
  BindingOperationInfo bop=message.getExchange().get(BindingOperationInfo.class);
  if (bop == null) {
    return;
  }
  FaultInfo fi=getFaultForClass(bop,cause.getClass());
  if (cause instanceof Exception && fi != null) {
    Exception ex=(Exception)cause;
    Object bean=getFaultBean(cause,fi,message);
    Service service=message.getExchange().get(Service.class);
    MessagePartInfo part=fi.getMessageParts().iterator().next();
    DataBinding db=service.getDataBinding();
    try {
      if (f.hasDetails()) {
        XMLStreamWriter xsw=new W3CDOMStreamWriter(f.getDetail());
        DataWriter<XMLStreamWriter> writer=db.createWriter(XMLStreamWriter.class);
        writer.write(bean,part,xsw);
      }
 else {
        XMLStreamWriter xsw=new W3CDOMStreamWriter(f.getOrCreateDetail());
        DataWriter<XMLStreamWriter> writer=db.createWriter(XMLStreamWriter.class);
        writer.write(bean,part,xsw);
        if (!f.getDetail().hasChildNodes()) {
          f.setDetail(null);
        }
      }
      f.setMessage(ex.getMessage());
    }
 catch (    Exception fex) {
      logger.warn("Exception while writing fault",fex);
    }
  }
}
