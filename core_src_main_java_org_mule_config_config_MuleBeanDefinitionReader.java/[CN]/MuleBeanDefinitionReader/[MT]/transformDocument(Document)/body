{
  if (getXslResource() != null) {
    DOMResult result;
    try {
      Transformer transformer=createTransformer(createXslSource());
      result=new DOMResult();
      transformer.setParameter("firstContext",Boolean.valueOf(isFirstContext()));
      transformer.transform(new DOMSource(document),result);
    }
  finally {
      if (XslHelper.hasErrorReport()) {
        String report=XslHelper.getErrorReport();
        XslHelper.clearErrors();
        throw new IOException(report);
      }
    }
    if (logger.isDebugEnabled()) {
      try {
        String xml=new DOMReader().read((Document)result.getNode()).asXML();
        if (logger.isDebugEnabled()) {
          logger.debug("Transformed document is:\n" + xml);
        }
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
    return (Document)result.getNode();
  }
 else {
    return document;
  }
}
