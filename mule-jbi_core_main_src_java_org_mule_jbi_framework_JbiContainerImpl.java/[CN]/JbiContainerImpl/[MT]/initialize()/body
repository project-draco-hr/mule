{
  try {
    JbiContainer.Factory.setInstance(this);
    Directories.createDirectories(getWorkingDir());
    MuleManager.getConfiguration().setEmbedded(true);
    MuleManager.getInstance().setTransactionManager(getTransactionManager());
    ((MuleManager)MuleManager.getInstance()).initialise();
    if (getMBeanServer() == null) {
      LOGGER.debug("Creating MBeanServer");
      List l=MBeanServerFactory.findMBeanServer(null);
      if (l != null && l.size() > 0) {
        setMBeanServer((MBeanServer)l.get(0));
      }
 else {
        setMBeanServer(MBeanServerFactory.createMBeanServer());
      }
    }
    if (rmiRegistry == null) {
      rmiRegistry=LocateRegistry.createRegistry(DEFAULT_PORT);
    }
    String url=MessageFormat.format(DEFAULT_URL,new Object[]{DEFAULT_HOST,Integer.toString(DEFAULT_PORT)});
    Map env=new HashMap();
    env.put(RMIConnectorServer.JNDI_REBIND_ATTRIBUTE,"true");
    JMXConnectorServer con=JMXConnectorServerFactory.newJMXConnectorServer(new JMXServiceURL(url),env,getMBeanServer());
    con.start();
    if (getTransactionManager() == null) {
      LOGGER.debug("Creating TransactionManager");
      setTransactionManager(new Jotm(true,false).getTransactionManager());
      getTransactionManager().setTransactionTimeout(60);
    }
    if (getNamingContext() == null) {
      System.setProperty(Context.INITIAL_CONTEXT_FACTORY,MuleInitialContextFactory.class.getName());
      System.setProperty(Context.PROVIDER_URL,"mule-jbi");
      setNamingContext(new InitialContext());
    }
    this.endpoints=new EndpointsImpl();
    File regStore=new File(getWorkingDir(),"/registry.xml");
    if (regStore.isFile()) {
      try {
        context.setRegistry(new XmlRegistryStore().load(regStore.getAbsolutePath()));
      }
 catch (      Exception e) {
        LOGGER.warn("Invalid registry found. Creating a new one");
      }
    }
 else {
      LOGGER.info("No registry found. Creating a new one");
    }
    if (getRegistry() == null) {
      context.setRegistry(new XmlRegistryStore().create(regStore.getAbsolutePath(),new JbiRegistryFactory()));
    }
    if (this.router == null) {
      this.router=new InternalMessageRouter(this,new DirectRouter(getRegistry()));
    }
  }
 catch (  Exception e) {
    if (e instanceof JBIException) {
      throw (JBIException)e;
    }
 else {
      throw new JBIException(e);
    }
  }
}
