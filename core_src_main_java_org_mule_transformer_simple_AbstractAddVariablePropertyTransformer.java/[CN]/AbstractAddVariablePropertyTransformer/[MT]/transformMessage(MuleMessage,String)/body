{
  Object keyValue=identifierEvaluator.resolveValue(message);
  String key=(keyValue == null ? null : keyValue.toString());
  if (key == null) {
    logger.error("Setting Null variable keys is not supported, this entry is being ignored");
  }
 else {
    TypedValue typedValue=valueEvaluator.resolveTypedValue(message);
    if (typedValue.getValue() == null || typedValue.getValue() instanceof NullPayload) {
      message.removeProperty(key,getScope());
      if (logger.isDebugEnabled()) {
        logger.debug(MessageFormat.format("Variable with key \"{0}\", not found on message using \"{1}\". Since the value was marked optional, nothing was set on the message for this variable",key,valueEvaluator.getRawValue()));
      }
    }
 else {
      if (!MimeTypes.ANY.equals(mimeType) || !StringUtils.isEmpty(encoding)) {
        DataType<?> dataType=DataTypeFactory.create(typedValue.getValue().getClass(),mimeType);
        dataType.setEncoding(getEncoding());
        message.setProperty(key,typedValue.getValue(),getScope(),dataType);
      }
 else {
        message.setProperty(key,typedValue.getValue(),getScope(),typedValue.getDataType());
        updateMessageDataTypeFromProperty(message,key,typedValue.getValue());
      }
    }
  }
  return message;
}
