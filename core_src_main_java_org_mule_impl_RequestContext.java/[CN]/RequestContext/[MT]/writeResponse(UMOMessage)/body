{
  if (message != null) {
    UMOEvent event=getEvent();
    if (event != null) {
      for (Iterator iterator=event.getMessage().getPropertyNames().iterator(); iterator.hasNext(); ) {
        String key=(String)iterator.next();
        if (key == null) {
          logger.warn("Message property key is null: please report the following stack trace to dev@mule.codehaus.org.",new IllegalArgumentException());
        }
 else {
          if (key.startsWith(MuleProperties.PROPERTY_PREFIX)) {
            Object newValue=message.getProperty(key);
            Object oldValue=event.getMessage().getProperty(key);
            if (newValue == null) {
              message.setProperty(key,oldValue);
            }
 else             if (logger.isInfoEnabled() && !newValue.equals(oldValue)) {
              logger.info("Message already contains property " + key + "="+ newValue+ " not replacing old value: "+ oldValue);
            }
          }
        }
      }
      event=new MuleEvent(message,event.getEndpoint(),event.getSession(),event.isSynchronous());
      setEvent(event);
    }
  }
}
