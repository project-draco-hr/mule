{
  if (event != null && event.getMessage() != null) {
    try {
      MuleMessage message=muleContext.getTransformationService().applyTransformers(event.getMessage(),event,this);
      if (message instanceof DefaultMessageCollection) {
        if (((DefaultMessageCollection)message).isInvalidatedPayload()) {
          if (logger.isDebugEnabled()) {
            logger.debug("Transformed message is an invalidated message collection. Creating new message with payload: " + event.getMessage().getPayload());
          }
          message=new DefaultMuleMessage(message.getPayload(),message,message.getMuleContext());
          event=new DefaultMuleEvent(message,event);
        }
      }
      event.setMessage(message);
    }
 catch (    Exception e) {
      throw new TransformerMessagingException(event,this,e);
    }
  }
  return event;
}
