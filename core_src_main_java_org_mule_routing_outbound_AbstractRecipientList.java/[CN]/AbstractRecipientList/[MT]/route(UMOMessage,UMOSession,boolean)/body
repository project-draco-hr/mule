{
  List recipients=this.getRecipients(message);
  List results=new ArrayList();
  if (enableCorrelation != ENABLE_CORRELATION_NEVER) {
    boolean correlationSet=message.getCorrelationGroupSize() != -1;
    if (correlationSet && (enableCorrelation == ENABLE_CORRELATION_IF_NOT_SET)) {
      logger.debug("CorrelationId is already set, not setting Correlation group size");
    }
 else {
      message.setCorrelationGroupSize(recipients.size());
    }
  }
  UMOMessage result=null;
  UMOEndpoint endpoint;
  UMOMessage request;
  for (Iterator iterator=recipients.iterator(); iterator.hasNext(); ) {
    Object recipient=iterator.next();
    request=new MuleMessage(message.getPayload(),message);
    endpoint=this.getRecipientEndpoint(request,recipient);
    try {
      if (synchronous) {
        result=this.send(session,request,endpoint);
        if (result != null) {
          results.add(result.getPayload());
        }
 else {
          if (logger.isDebugEnabled()) {
            logger.debug("No result was returned for sync call to: " + endpoint.getEndpointURI());
          }
        }
      }
 else {
        this.dispatch(session,request,endpoint);
      }
    }
 catch (    UMOException e) {
      throw new CouldNotRouteOutboundMessageException(request,endpoint,e);
    }
  }
  if (results.size() == 0) {
    return null;
  }
 else   if (results.size() == 1) {
    return new MuleMessage(results.get(0),result);
  }
 else {
    return new MuleMessage(results,result);
  }
}
