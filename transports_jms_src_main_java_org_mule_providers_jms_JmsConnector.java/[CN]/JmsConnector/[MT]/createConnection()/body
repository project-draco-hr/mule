{
  ConnectionFactory cf;
  Connection connection;
  try {
    cf=(ConnectionFactory)connectionFactory.getOrCreate();
    if (cf instanceof XAConnectionFactory && managementContext.getTransactionManager() != null) {
      cf=new ConnectionFactoryWrapper(cf);
    }
  }
 catch (  Exception e) {
    throw new InitialisationException(e,this);
  }
  if (cf == null) {
    throw new InitialisationException(JmsMessages.noConnectionFactorySet(),this);
  }
  if (username != null) {
    connection=jmsSupport.createConnection(cf,username,password);
  }
 else {
    connection=jmsSupport.createConnection(cf);
  }
  if (clientId != null) {
    connection.setClientID(getClientId());
  }
  if (recoverJmsConnections && connectionStrategy != null && connection != null) {
    connection.setExceptionListener(new ExceptionListener(){
      public void onException(      JMSException jmsException){
        logger.debug("About to recycle myself due to remote JMS connection shutdown.");
        final JmsConnector jmsConnector=JmsConnector.this;
        try {
          jmsConnector.stop();
          jmsConnector.initialised.set(false);
        }
 catch (        UMOException e) {
          logger.warn(e.getMessage(),e);
        }
        try {
          jmsConnector.initialise();
          jmsConnector.start();
        }
 catch (        FatalConnectException fcex) {
          logger.fatal("Failed to reconnect to JMS server. I'm giving up.");
        }
catch (        UMOException umoex) {
          throw new UnhandledException("Failed to recover a connector.",umoex);
        }
      }
    }
);
  }
  return connection;
}
