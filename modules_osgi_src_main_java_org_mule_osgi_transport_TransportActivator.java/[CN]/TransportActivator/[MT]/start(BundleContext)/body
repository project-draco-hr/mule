{
  Bundle bundle=bc.getBundle();
  Dictionary headers=bundle.getHeaders();
  ClassLoader bundleClassLoader=BundleDelegatingClassLoader.createBundleClassLoaderFor(bundle,MuleContext.class.getClassLoader());
  String transportHeader=(String)headers.get(TransportServiceDescriptor.OSGI_HEADER_TRANSPORT);
  if (transportHeader == null) {
    throw new ConfigurationException(MessageFactory.createStaticMessage("Transport must declare its protocol(s) as an OSGi header."));
  }
  String[] transports=StringUtils.splitAndTrim(transportHeader,",");
  String transport;
  for (int i=0; i < transports.length; ++i) {
    transport=transports[i];
    String descriptorPath="/" + SpiUtils.SERVICE_ROOT + SpiUtils.PROVIDER_SERVICE_PATH+ transport+ ".properties";
    URL descriptorUrl=bundle.getEntry(descriptorPath);
    if (descriptorUrl == null) {
      throw new ConfigurationException(MessageFactory.createStaticMessage("Unable to locate service descriptor file: " + descriptorPath));
    }
    Properties props=new Properties();
    props.load(descriptorUrl.openStream());
    ServiceDescriptor descriptor=ServiceDescriptorFactory.create(ServiceDescriptorFactory.PROVIDER_SERVICE_TYPE,transport,props,null,MuleServer.getMuleContext().getRegistry(),bundleClassLoader);
    Hashtable osgiProps=new Hashtable();
    osgiProps.put(Constants.SERVICE_PID,headers.get(Constants.BUNDLE_SYMBOLICNAME) + "." + transport);
    osgiProps.put(Constants.SERVICE_DESCRIPTION,headers.get(Constants.BUNDLE_DESCRIPTION));
    osgiProps.put(Constants.SERVICE_VENDOR,headers.get(Constants.BUNDLE_VENDOR));
    osgiProps.put(TransportServiceDescriptor.OSGI_HEADER_TRANSPORT,transport);
    descriptorRef=bc.registerService(TransportServiceDescriptor.class.getName(),descriptor,osgiProps);
  }
}
