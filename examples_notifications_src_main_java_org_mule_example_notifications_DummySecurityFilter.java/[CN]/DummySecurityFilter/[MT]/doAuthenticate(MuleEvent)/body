{
  try {
    Map<?,?> payload=(Map<?,?>)event.getMessage().getPayload(DataTypeFactory.create(Map.class));
    String user=(String)payload.get("user");
    if (user == null) {
      throw new UnauthorisedException(CoreMessages.authNoCredentials());
    }
    if ("anonymous".equals(user)) {
      throw new UnauthorisedException(CoreMessages.authFailedForUser("anonymous"));
    }
  }
 catch (  Exception e) {
    throw new UnauthorisedException(CoreMessages.authFailedForUser("anonymous"),e);
  }
}
