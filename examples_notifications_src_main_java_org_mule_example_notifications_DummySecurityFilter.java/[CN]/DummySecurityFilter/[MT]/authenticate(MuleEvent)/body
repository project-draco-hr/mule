{
  try {
    Map<?,?> payload=event.getMessage().getPayload(DataTypeFactory.create(Map.class));
    String user=(String)payload.get("user");
    if (user == null) {
      throw new UnauthorisedException(CoreMessages.authNoCredentials(),event);
    }
    if ("anonymous".equals(user)) {
      throw new UnauthorisedException(CoreMessages.authFailedForUser("anonymous"),event);
    }
  }
 catch (  TransformerException te) {
    throw new UnauthorisedException(CoreMessages.transformFailed("Object","Map"),event,te);
  }
}
