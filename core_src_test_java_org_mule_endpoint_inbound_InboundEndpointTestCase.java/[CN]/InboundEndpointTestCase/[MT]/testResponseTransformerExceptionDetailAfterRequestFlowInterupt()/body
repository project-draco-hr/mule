{
  endpoint=createTestInboundEndpoint(null,new TestSecurityFilter(false),null,new ResponseAppendTransformer(),MessageExchangePattern.REQUEST_RESPONSE,null);
  endpoint.setListener(inboundListener);
  requestEvent=createTestRequestEvent(endpoint);
  responseEvent=createTestResponseEvent(endpoint);
  responseEvent.getMessage().setExceptionPayload(new DefaultExceptionPayload(new RuntimeException()));
  MessageProcessor mpChain=((AbstractEndpoint)endpoint).getMessageProcessorChain(requestEvent.getFlowConstruct());
  RequestContext.setEvent(requestEvent);
  result=mpChain.process(requestEvent);
  assertMessageNotSent();
  assertNotNull(result);
  assertEquals(TestSecurityFilter.SECURITY_EXCEPTION_MESSAGE + ResponseAppendTransformer.APPEND_STRING,result.getMessage().getPayloadAsString());
  final int status=result.getMessage().getOutboundProperty("status",0);
  assertEquals(403,status);
  assertNotNull(result.getMessage().getExceptionPayload());
  assertTrue(result.getMessage().getExceptionPayload().getException() instanceof TestSecurityFilter.StaticMessageUnauthorisedException);
}
