{
  String destComponent;
  MuleMessage result=null;
  String endpoint=action.getResourceIdentifier();
  if (action.getResourceIdentifier().startsWith("mule:")) {
    destComponent=endpoint.substring(endpoint.lastIndexOf("/") + 1);
  }
 else {
    destComponent=endpoint;
  }
  if (destComponent != null) {
    Object flowConstruct=muleContext.getRegistry().lookupObject(destComponent);
    if (!(flowConstruct instanceof FlowConstruct && flowConstruct instanceof MessageProcessor)) {
      return handleException(null,new DefaultMuleException(ClientMessages.noSuchFlowConstruct(destComponent)));
    }
    MuleSession session=new DefaultMuleSession((FlowConstruct)flowConstruct);
    EndpointBuilder builder=new EndpointURIEndpointBuilder(inboundEndpoint);
    builder.setTransformers(new LinkedList());
    InboundEndpoint ep=muleContext.getEndpointFactory().getInboundEndpoint(builder);
    MuleEvent event=new DefaultMuleEvent(action.getMessage(),ep,context.getSession());
    event=RequestContext.setEvent(event);
    if (context.getExchangePattern().hasResponse()) {
      MuleEvent resultEvent=((MessageProcessor)flowConstruct).process(event);
      result=resultEvent == null ? null : resultEvent.getMessage();
      if (result == null) {
        return null;
      }
 else {
        ByteArrayOutputStream out=new ByteArrayOutputStream();
        wireFormat.write(out,result,getEncoding());
        return out.toByteArray();
      }
    }
 else {
      ((MessageProcessor)flowConstruct).process(event);
      return null;
    }
  }
 else {
    return handleException(result,new DefaultMuleException(CoreMessages.couldNotDetermineDestinationComponentFromEndpoint(endpoint)));
  }
}
