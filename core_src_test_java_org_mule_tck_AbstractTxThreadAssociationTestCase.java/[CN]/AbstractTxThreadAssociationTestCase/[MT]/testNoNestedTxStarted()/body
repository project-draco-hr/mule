{
  muleContext.setTransactionManager(tm);
  assertNull("There sould be no current transaction associated.",tm.getTransaction());
  tm.setTransactionTimeout(TRANSACTION_TIMEOUT_SECONDS);
  TransactionConfig config=new MuleTransactionConfig();
  config.setFactory(new XaTransactionFactory());
  config.setAction(TransactionConfig.ACTION_ALWAYS_BEGIN);
  TransactionTemplate template=new TransactionTemplate(config,new DefaultExceptionStrategy(),muleContext);
  final TransactionConfig nestedConfig=new MuleTransactionConfig();
  nestedConfig.setFactory(new XaTransactionFactory());
  nestedConfig.setAction(TransactionConfig.ACTION_BEGIN_OR_JOIN);
  template.execute(new TransactionCallback<Void>(){
    public Void doInTransaction() throws Exception {
      TransactionTemplate<Void> nestedTemplate=new TransactionTemplate<Void>(nestedConfig,new DefaultExceptionStrategy(),muleContext);
      return nestedTemplate.execute(new TransactionCallback<Void>(){
        public Void doInTransaction() throws Exception {
          return null;
        }
      }
);
    }
  }
);
}
