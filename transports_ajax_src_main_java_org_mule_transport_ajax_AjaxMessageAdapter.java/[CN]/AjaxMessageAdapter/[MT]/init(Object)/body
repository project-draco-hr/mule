{
  if (message instanceof Map) {
    Map map=(Map)message;
    Object p=map.remove(PAYLOAD_PARAM);
    if (p != null) {
      if (filter.accept(p)) {
        this.payload=readJsonAs(p,HashMap.class);
      }
 else {
        payload=p;
      }
    }
 else {
      throw new IllegalArgumentException("payload parameter not set");
    }
    setReplyTo(map.remove(REPLYTO_PARAM));
    if (map.size() > 0) {
      addProperties(map,PropertyScope.INVOCATION);
    }
  }
 else   if (filter.accept(message)) {
    if (message.toString().indexOf("payload") > -1) {
      DefaultMuleMessageDTO dto=readJsonAs(message,DefaultMuleMessageDTO.class);
      payload=dto.getPayload();
      dto.addPropertiesTo(this);
    }
 else {
      this.payload=readJsonAs(message,HashMap.class);
    }
  }
 else {
    payload=message;
  }
}
