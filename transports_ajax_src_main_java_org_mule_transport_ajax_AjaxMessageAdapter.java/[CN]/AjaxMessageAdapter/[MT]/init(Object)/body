{
  if (message instanceof Map) {
    Map map=(Map)message;
    Object p=map.remove(PAYLOAD_PARAM);
    if (p != null) {
      if (filter.accept(p)) {
        transformer=new JsonToObject();
        transformer.setReturnClass(Map.class);
        this.payload=transformer.transform(p);
      }
 else {
        payload=p;
      }
    }
 else {
      throw new IllegalArgumentException("payload parameter not set");
    }
    setReplyTo(map.remove(REPLYTO_PARAM));
    if (map.size() > 0) {
      addProperties(map,PropertyScope.INVOCATION);
    }
  }
 else   if (filter.accept(message)) {
    if (message.toString().indexOf("payload") > -1) {
      transformer=new JsonToObject();
      transformer.setReturnClass(DefaultMuleMessageDTO.class);
      DefaultMuleMessageDTO dto=null;
      dto=(DefaultMuleMessageDTO)transformer.transform(message);
      payload=dto.getPayload();
      dto.addPropertiesTo(this);
    }
 else {
      transformer=new JsonToObject();
      transformer.setReturnClass(Map.class);
      payload=transformer.transform(message);
    }
  }
 else {
    payload=message;
  }
}
