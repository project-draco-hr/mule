{
  if (message instanceof Map) {
    Map map=(Map)message;
    Object p=map.remove(Bayeux.DATA_FIELD);
    if (p != null) {
      payload=p;
    }
 else {
      throw new IllegalArgumentException("data parameter not set");
    }
    setReplyTo(map.remove(REPLYTO_PARAM));
    if (map.size() > 0) {
      addProperties(map,PropertyScope.INVOCATION);
    }
  }
 else   if (filter.accept(message)) {
    if (message.toString().indexOf(Bayeux.DATA_FIELD) > -1) {
      try {
        JsonData jd=new JsonData(message.toString());
        payload=jd.get(Bayeux.DATA_FIELD).toString();
        setReplyTo(jd.get(REPLYTO_PARAM));
      }
 catch (      IOException e) {
        throw new DefaultMuleException(e);
      }
    }
 else {
      this.payload=message;
    }
  }
 else {
    payload=message;
  }
}
