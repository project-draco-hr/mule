{
  MuleMessage message=eventContext.getMessage();
  Message mail=(Message)message.getPayload();
  String from=mail.getFrom()[0].toString();
  String[] received=mail.getHeader("Received");
  List<String> list=new ArrayList<String>();
  for (int i=received.length - 1; i >= 0; i--) {
    ReceivedHeader receivedHeader=ReceivedHeader.getInstance(received[i]);
    if (receivedHeader != null && receivedHeader.getFrom() != null) {
      if (!receivedHeader.getFrom().startsWith("localhost") && !receivedHeader.getFrom().startsWith("127.0.0.1")) {
        String ip=getFromIP(receivedHeader);
        if (ip != null) {
          list.add(ip);
        }
      }
    }
  }
  if (list.isEmpty()) {
    throw new DefaultMuleException("Received e-mail does not provide sender IP information.");
  }
  Map<String,Object> properties=new HashMap<String,Object>();
  properties.put("from.email.address",from);
  MuleMessage result=new DefaultMuleMessage(list,properties,eventContext.getMuleContext());
  return result;
}
