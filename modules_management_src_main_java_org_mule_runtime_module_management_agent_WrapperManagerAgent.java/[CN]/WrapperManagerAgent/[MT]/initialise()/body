{
  try {
    List<?> servers=MBeanServerFactory.findMBeanServer(null);
    if (servers.isEmpty()) {
      throw new InitialisationException(ManagementMessages.noMBeanServerAvailable(),this);
    }
    mBeanServer=(MBeanServer)servers.get(0);
    boolean launchedByWrapper;
    if (System.getProperty(WRAPPER_SYSTEM_PROPERTY_NAME) == null) {
      launchedByWrapper=false;
    }
 else     if (mBeanServer.isRegistered(jmxSupport.getObjectName(DEFAULT_WRAPPER_MBEAN_NAME))) {
      logger.info("Mule is embedded in a container already launched by a wrapper." + "Duplicates will not be registered. Use the " + DEFAULT_WRAPPER_MBEAN_NAME + " MBean "+ "instead for control.");
      unregisterMeQuietly();
      return;
    }
 else {
      lazyInitWrapperManager();
      launchedByWrapper=wrapperManagerRef.get().isControlledByNativeWrapper();
    }
    if (!launchedByWrapper) {
      logger.info("This JVM hasn't been launched by the wrapper, the agent will not run.");
      unregisterMeQuietly();
      return;
    }
    final boolean containerMode=muleContext.getConfiguration().isContainerMode();
    if (containerMode) {
      wrapperName=jmxSupport.getObjectName(JmxSupport.DEFAULT_JMX_DOMAIN_PREFIX + ":" + WRAPPER_JMX_NAME);
      if (mBeanServer.isRegistered(wrapperName)) {
        return;
      }
    }
 else {
      wrapperName=jmxSupport.getObjectName(jmxSupport.getDomainName(muleContext) + ":" + WRAPPER_JMX_NAME);
    }
    unregisterMBeansIfNecessary();
    mBeanServer.registerMBean(wrapperManagerRef.get(),wrapperName);
  }
 catch (  InitialisationException iex) {
    throw iex;
  }
catch (  Exception e) {
    throw new InitialisationException(CoreMessages.failedToStart("wrapper agent"),e,this);
  }
}
