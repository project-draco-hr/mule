{
  CometdMessageDispatcher dispatcher=new CometdMessageDispatcher(endpoint);
  if (endpoint.getConnector() instanceof CometdConnector) {
    CometdConnector.BayeuxHolder holder=((CometdConnector)endpoint.getConnector()).registerBayeuxEndpoint(endpoint);
    dispatcher.setBayeux(holder.getBayeux());
  }
 else {
    AbstractBayeux b=((CometdServletConnector)endpoint.getConnector()).getBayeux();
    if (b == null) {
      throw new IllegalArgumentException("Bayeux is null: " + endpoint.getConnector());
    }
    dispatcher.setBayeux(b);
  }
  return dispatcher;
}
