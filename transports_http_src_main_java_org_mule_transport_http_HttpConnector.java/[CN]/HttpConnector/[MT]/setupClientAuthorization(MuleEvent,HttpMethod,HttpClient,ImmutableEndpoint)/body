{
  httpMethod.setDoAuthentication(true);
  client.getParams().setAuthenticationPreemptive(true);
  if (event != null && event.getCredentials() != null) {
    MuleMessage msg=event.getMessage();
    String authScopeHost=msg.getOutboundProperty(HTTP_PREFIX + "auth.scope.host",event.getMessageSourceURI().getHost());
    int authScopePort=msg.getOutboundProperty(HTTP_PREFIX + "auth.scope.port",event.getMessageSourceURI().getPort());
    String authScopeRealm=msg.getOutboundProperty(HTTP_PREFIX + "auth.scope.realm",AuthScope.ANY_REALM);
    String authScopeScheme=msg.getOutboundProperty(HTTP_PREFIX + "auth.scope.scheme",AuthScope.ANY_SCHEME);
    client.getState().setCredentials(new AuthScope(authScopeHost,authScopePort,authScopeRealm,authScopeScheme),new UsernamePasswordCredentials(event.getCredentials().getUsername(),new String(event.getCredentials().getPassword())));
  }
 else   if (endpoint.getEndpointURI().getUserInfo() != null && endpoint.getProperty(HttpConstants.HEADER_AUTHORIZATION) == null) {
    StringBuilder header=new StringBuilder(128);
    header.append("Basic ");
    header.append(new String(Base64.encodeBase64(endpoint.getEndpointURI().getUserInfo().getBytes(endpoint.getEncoding()))));
    httpMethod.addRequestHeader(HttpConstants.HEADER_AUTHORIZATION,header.toString());
  }
 else   if (event != null && event.getMessage().getOutboundProperty(HttpConstants.HEADER_AUTHORIZATION) != null && httpMethod.getRequestHeader(HttpConstants.HEADER_AUTHORIZATION) == null) {
    String auth=event.getMessage().getOutboundProperty(HttpConstants.HEADER_AUTHORIZATION);
    httpMethod.addRequestHeader(HttpConstants.HEADER_AUTHORIZATION,auth);
  }
 else   if (StringUtils.isEmpty(getProxyUsername())) {
    client.getParams().setAuthenticationPreemptive(false);
  }
}
