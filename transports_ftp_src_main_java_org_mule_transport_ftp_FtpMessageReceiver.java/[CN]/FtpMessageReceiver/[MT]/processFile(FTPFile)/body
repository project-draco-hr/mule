{
  FTPClient client=null;
  try {
    if (!connector.validateFile(file)) {
      return;
    }
    try {
      client=connector.createFtpClient(endpoint);
    }
 catch (    Exception e) {
      throw new ConnectException(e,this);
    }
    MuleMessage message;
    if (connector.isStreaming()) {
      InputStream stream=client.retrieveFileStream(file.getName());
      if (stream == null) {
        throw new IOException(MessageFormat.format("Failed to retrieve file {0}. Ftp error: {1}",file.getName(),client.getReplyCode()));
      }
      message=new DefaultMuleMessage(connector.getMessageAdapter(stream));
    }
 else {
      ByteArrayOutputStream baos=new ByteArrayOutputStream();
      if (!client.retrieveFile(file.getName(),baos)) {
        throw new IOException(MessageFormat.format("Failed to retrieve file {0}. Ftp error: {1}",file.getName(),client.getReplyCode()));
      }
      byte[] bytes=baos.toByteArray();
      if (bytes.length > 0) {
        message=new DefaultMuleMessage(connector.getMessageAdapter(bytes));
      }
 else {
        throw new IOException("File " + file.getName() + " is empty (zero bytes)");
      }
    }
    message.setProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,file.getName());
    message.setProperty(FileConnector.PROPERTY_FILE_SIZE,file.getSize());
    routeMessage(message);
    postProcess(client,file,message);
  }
  finally {
    if (client != null) {
      connector.releaseFtp(endpoint.getEndpointURI(),client);
    }
  }
}
