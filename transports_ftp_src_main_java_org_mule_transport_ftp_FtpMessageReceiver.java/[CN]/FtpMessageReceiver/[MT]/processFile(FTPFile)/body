{
  logger.debug("entering processFile()");
  FTPClient client=null;
  try {
    client=connector.createFtpClient(endpoint);
    final String fileName=file.getName();
    MuleMessage message;
    InputStream stream=client.retrieveFileStream(fileName);
    if (stream == null) {
      throw new IOException(MessageFormat.format("Failed to retrieve file {0}. Ftp error: {1}",new Object[]{fileName,new Integer(client.getReplyCode())}));
    }
    message=new DefaultMuleMessage(connector.getMessageAdapter(stream));
    message.setProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,fileName);
    message.setProperty(FileConnector.PROPERTY_FILE_SIZE,new Long(file.getSize()));
    routeMessage(message);
    if (!client.deleteFile(fileName)) {
      throw new IOException(MessageFormat.format("Failed to delete file {0}. Ftp error: {1}",new Object[]{fileName,new Integer(client.getReplyCode())}));
    }
  }
  finally {
    logger.debug("leaving processFile()");
    if (client != null) {
      connector.releaseFtp(endpoint.getEndpointURI(),client);
    }
  }
}
