{
  FTPClient client=null;
  MuleMessage muleMessage=null;
  try {
    client=connector.createFtpClient(endpoint);
    final FTPClient finalClient=client;
    currentFiles.add(name);
    if (!connector.validateFile(file)) {
      return;
    }
    FtpMuleMessageFactory muleMessageFactory=createMuleMessageFactory(finalClient);
    final MuleMessage finalMessage=muleMessageFactory.create(file,endpoint.getEncoding());
    muleMessage=finalMessage;
    TransactionTemplate<Void> exceptionHandlingTransactionTemplate=TransactionTemplateFactory.<Void>createExceptionHandlingTransactionTemplate(getConnector().getMuleContext());
    exceptionHandlingTransactionTemplate.execute(new TransactionCallback<Void>(){
      @Override public Void doInTransaction() throws Exception {
        routeMessage(finalMessage);
        postProcess(finalClient,file,finalMessage);
        return null;
      }
    }
);
  }
 catch (  MessagingException e) {
    if (!e.isCauseRollback()) {
      try {
        postProcess(client,file,muleMessage);
      }
 catch (      Exception e1) {
        logger.error(e);
      }
    }
  }
catch (  Exception e) {
    getConnector().getMuleContext().getExceptionListener().handleException(e);
  }
 finally {
    if (client != null) {
      try {
        connector.releaseFtp(endpoint.getEndpointURI(),client);
      }
 catch (      Exception e) {
        logger.error(e);
      }
    }
    currentFiles.remove(name);
    scheduledFiles.remove(name);
  }
}
