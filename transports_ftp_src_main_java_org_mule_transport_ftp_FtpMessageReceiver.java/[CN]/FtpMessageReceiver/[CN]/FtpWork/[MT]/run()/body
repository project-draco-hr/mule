{
  FTPClient client=null;
  MuleMessage muleMessage=null;
  Lock lock=getEndpoint().getMuleContext().getLockFactory().createLock(file.getName());
  if (lock.tryLock()) {
    try {
      client=connector.createFtpClient(endpoint);
      final FTPClient finalClient=client;
      currentFiles.add(name);
      if (!connector.validateFile(file)) {
        return;
      }
      FtpMuleMessageFactory muleMessageFactory=createMuleMessageFactory(finalClient);
      final MuleMessage finalMessage=muleMessageFactory.create(file,endpoint.getEncoding(),endpoint.getMuleContext());
      muleMessage=finalMessage;
      ExecutionTemplate<MuleEvent> executionTemplate=createExecutionTemplate();
      executionTemplate.execute(new ExecutionCallback<MuleEvent>(){
        @Override public MuleEvent process() throws Exception {
          routeMessage(finalMessage);
          return null;
        }
      }
);
      postProcess(finalClient,file,finalMessage);
    }
 catch (    MessagingException e) {
      if (!e.causedRollback()) {
        try {
          postProcess(client,file,muleMessage);
        }
 catch (        Exception e1) {
          logger.error(e);
        }
      }
    }
catch (    Exception e) {
      getEndpoint().getMuleContext().getExceptionListener().handleException(e);
    }
 finally {
      lock.unlock();
      if (client != null) {
        try {
          connector.releaseFtp(endpoint.getEndpointURI(),client);
        }
 catch (        Exception e) {
          logger.error(e);
        }
      }
      currentFiles.remove(name);
      scheduledFiles.remove(name);
    }
  }
}
