{
  ConfigResource config=null;
  Document document=DocumentHelper.createDocument();
  Element rootElement=document.addElement("mule","http://www.mulesoft.org/schema/mule/core");
  Element parentElement=rootElement;
  addSchemaLocation(rootElement,element,callback);
  String flowName="flow-" + Integer.toString(element.hashCode());
  if (embedInFlow) {
    parentElement=rootElement.addElement("flow","http://www.mulesoft.org/schema/mule/core");
    parentElement.addAttribute("name",flowName);
  }
  try {
    parentElement.add(convert(element));
    for (int i=0; i < element.getAttributes().getLength(); i++) {
      String attributeName=element.getAttributes().item(i).getLocalName();
      if (attributeName != null && attributeName.endsWith("-ref")) {
        org.w3c.dom.Element dependentElement=callback.getGlobalElement(element.getAttributes().item(i).getNodeValue());
        if (dependentElement != null) {
          if ("http://www.springframework.org/schema/beans".equals(dependentElement.getNamespaceURI())) {
            String namespaceUri=dependentElement.getNamespaceURI();
            Namespace namespace=new Namespace(dependentElement.getPrefix(),namespaceUri);
            Element beans=rootElement.element(new QName("beans",namespace));
            if (beans == null) {
              beans=rootElement.addElement("beans",namespaceUri);
            }
            beans.add(convert(dependentElement));
          }
 else {
            rootElement.add(convert(dependentElement));
            addSchemaLocation(rootElement,dependentElement,callback);
          }
          addChildSchemaLocations(rootElement,dependentElement,callback);
        }
      }
    }
    config=new ConfigResource("",new StringBufferInputStream(document.asXML()));
  }
 catch (  Exception e) {
    throw new MuleArtifactFactoryException("Error parsing XML",e);
  }
  MuleContext muleContext=null;
  SpringXmlConfigurationBuilder builder=null;
  try {
    MuleContextFactory factory=new DefaultMuleContextFactory();
    builder=new SpringXmlConfigurationBuilder(new ConfigResource[]{config});
    muleContext=factory.createMuleContext(builder);
    muleContext.start();
    MuleArtifact artifact=null;
    if (embedInFlow) {
      Pipeline pipeline=(Pipeline)muleContext.getRegistry().lookupFlowConstruct(flowName);
      artifact=new DefaultMuleArtifact(pipeline.getMessageProcessors().get(0));
    }
 else {
      artifact=new DefaultMuleArtifact(muleContext.getRegistry().lookupObject(element.getAttribute("name")));
    }
    builders.put(artifact,builder);
    contexts.put(artifact,muleContext);
    return artifact;
  }
 catch (  Exception e) {
    dispose(builder,muleContext);
    throw new MuleArtifactFactoryException("Error initializing",e);
  }
}
