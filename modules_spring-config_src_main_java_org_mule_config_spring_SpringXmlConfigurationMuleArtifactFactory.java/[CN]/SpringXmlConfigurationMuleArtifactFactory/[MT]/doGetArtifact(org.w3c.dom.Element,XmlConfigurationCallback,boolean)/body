{
  ConfigResource config;
  Document document=DocumentHelper.createDocument();
  Element rootElement=document.addElement("mule","http://www.mulesoft.org/schema/mule/core");
  org.w3c.dom.Element[] placeholders=callback.getPropertyPlaceholders();
  for (  org.w3c.dom.Element placeholder : placeholders) {
    try {
      Element newPlaceHolder=convert(placeholder);
      rootElement.add(newPlaceHolder);
    }
 catch (    ParserConfigurationException e) {
      throw new MuleArtifactFactoryException("Error parsing XML",e);
    }
  }
  Element parentElement=rootElement;
  addSchemaLocation(rootElement,element,callback);
  String flowName="flow-" + Integer.toString(element.hashCode());
  if (embedInFlow) {
    parentElement=rootElement.addElement("flow","http://www.mulesoft.org/schema/mule/core");
    parentElement.addAttribute("name",flowName);
  }
  try {
    parentElement.add(convert(element));
    for (int i=0; i < element.getAttributes().getLength(); i++) {
      String attributeName=element.getAttributes().item(i).getLocalName();
      if (attributeName != null && attributeName.endsWith("-ref")) {
        org.w3c.dom.Element dependentElement=callback.getGlobalElement(element.getAttributes().item(i).getNodeValue());
        if (dependentElement != null) {
          if ("http://www.springframework.org/schema/beans".equals(dependentElement.getNamespaceURI())) {
            String namespaceUri=dependentElement.getNamespaceURI();
            Namespace namespace=new Namespace(dependentElement.getPrefix(),namespaceUri);
            Element beans=rootElement.element(new QName("beans",namespace));
            if (beans == null) {
              beans=rootElement.addElement("beans",namespaceUri);
            }
            beans.add(convert(dependentElement));
          }
 else {
            rootElement.add(convert(dependentElement));
            addSchemaLocation(rootElement,dependentElement,callback);
          }
          addChildSchemaLocations(rootElement,dependentElement,callback);
        }
      }
    }
    if (embedInFlow) {
      parentElement.addElement("logger","http://www.mulesoft.org/schema/mule/core");
    }
    config=new ConfigResource("",new StringBufferInputStream(document.asXML()));
  }
 catch (  Exception e) {
    throw new MuleArtifactFactoryException("Error parsing XML",e);
  }
  MuleContext muleContext=null;
  SpringXmlConfigurationBuilder builder=null;
  Map<String,String> environmentProperties=callback.getEnvironmentProperties();
  Properties systemProperties=System.getProperties();
  Map<Object,Object> originalSystemProperties=new HashMap<Object,Object>(systemProperties);
  try {
    if (environmentProperties != null) {
      systemProperties.putAll(environmentProperties);
    }
    MuleContextFactory factory=new DefaultMuleContextFactory();
    builder=new SpringXmlConfigurationBuilder(new ConfigResource[]{config});
    muleContext=factory.createMuleContext(builder);
    muleContext.start();
    MuleArtifact artifact=null;
    if (embedInFlow) {
      Pipeline pipeline=muleContext.getRegistry().lookupObject(flowName);
      if (pipeline.getMessageSource() == null) {
        if (pipeline.getMessageProcessors() != null && pipeline.getMessageProcessors().size() > 0) {
          artifact=new DefaultMuleArtifact(pipeline.getMessageProcessors().get(0));
        }
 else {
          throw new IllegalArgumentException("artifact is null");
        }
      }
 else {
        artifact=new DefaultMuleArtifact(pipeline.getMessageSource());
      }
    }
 else {
      artifact=new DefaultMuleArtifact(muleContext.getRegistry().lookupObject(element.getAttribute("name")));
    }
    builders.put(artifact,builder);
    contexts.put(artifact,muleContext);
    return artifact;
  }
 catch (  Exception e) {
    dispose(builder,muleContext);
    throw new MuleArtifactFactoryException("Error initializing",e);
  }
 finally {
    systemProperties.clear();
    systemProperties.putAll(originalSystemProperties);
  }
}
