{
  String mimeType=operationContext.getTypeSafeParameter(MIME_TYPE_PARAMETER_NAME,String.class);
  String encoding=operationContext.getTypeSafeParameter(ENCODING_PARAMETER_NAME,String.class);
  DataType dataType=null;
  Class<?> type=value != null ? value.getClass() : NullPayload.class;
  if (value instanceof MuleMessage) {
    dataType=((MuleMessage)value).getDataType();
    type=dataType.getType();
    if (encoding == null && mimeType == null) {
      return dataType;
    }
    if (encoding == null) {
      encoding=dataType.getEncoding();
    }
    if (mimeType == null) {
      mimeType=dataType.getMimeType();
    }
  }
  if (dataType != null && encoding == null && mimeType == null) {
    return dataType;
  }
  if (value == null || value instanceof NullPayload) {
    return null;
  }
  if (encoding == null) {
    encoding=muleContext.getConfiguration().getDefaultEncoding();
  }
  return DataTypeFactory.create(type,mimeType,encoding);
}
