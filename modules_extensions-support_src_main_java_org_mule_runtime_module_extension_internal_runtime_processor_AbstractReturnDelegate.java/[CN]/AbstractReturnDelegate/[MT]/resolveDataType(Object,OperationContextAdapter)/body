{
  if (value == null || value instanceof NullPayload) {
    return null;
  }
  Charset existingEncoding=getDefaultEncoding(muleContext);
  DataTypeParamsBuilder dataTypeBuilder;
  if (value instanceof MuleMessage) {
    DataType dataType=((MuleMessage)value).getDataType();
    if (dataType.getMediaType().getCharset().isPresent()) {
      existingEncoding=dataType.getMediaType().getCharset().get();
    }
    dataTypeBuilder=DataType.builder(dataType);
  }
 else {
    dataTypeBuilder=DataType.builder().type((Class)(value != null ? value.getClass() : Object.class));
  }
  if (operationContext.hasParameter(MIME_TYPE_PARAMETER_NAME)) {
    dataTypeBuilder=dataTypeBuilder.mediaType(operationContext.getTypeSafeParameter(MIME_TYPE_PARAMETER_NAME,String.class));
  }
  if (operationContext.hasParameter(ENCODING_PARAMETER_NAME)) {
    dataTypeBuilder=dataTypeBuilder.charset(operationContext.getTypeSafeParameter(ENCODING_PARAMETER_NAME,String.class));
  }
 else {
    dataTypeBuilder=dataTypeBuilder.charset(existingEncoding);
  }
  return dataTypeBuilder.build();
}
