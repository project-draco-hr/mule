{
  Charset existingEncoding=getDefaultEncoding(muleContext);
  MediaType mediaType;
  if (value instanceof MuleMessage) {
    DataType dataType=((MuleMessage)value).getDataType();
    if (dataType.getMediaType().getCharset().isPresent()) {
      existingEncoding=dataType.getMediaType().getCharset().get();
    }
    mediaType=dataType.getMediaType();
  }
 else {
    mediaType=MediaType.ANY;
  }
  if (operationContext.hasParameter(MIME_TYPE_PARAMETER_NAME)) {
    mediaType=MediaType.parse(operationContext.getTypeSafeParameter(MIME_TYPE_PARAMETER_NAME,String.class));
  }
  if (operationContext.hasParameter(ENCODING_PARAMETER_NAME)) {
    mediaType=mediaType.withCharset(Charset.forName(operationContext.getTypeSafeParameter(ENCODING_PARAMETER_NAME,String.class)));
  }
 else {
    mediaType=mediaType.withCharset(existingEncoding);
  }
  return mediaType;
}
