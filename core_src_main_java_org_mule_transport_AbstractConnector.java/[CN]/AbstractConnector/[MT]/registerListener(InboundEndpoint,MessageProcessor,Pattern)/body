{
  if (endpoint == null) {
    throw new IllegalArgumentException("The endpoint cannot be null when registering a listener");
  }
  if (listener == null) {
    throw new IllegalArgumentException("The listemer cannot be null when registering a listener");
  }
  Service service=null;
  if (pattern != null && pattern instanceof Service) {
    service=(Service)pattern;
  }
 else {
    throw new IllegalArgumentException("Only 'Service' pattern is currently supported");
  }
  EndpointURI endpointUri=endpoint.getEndpointURI();
  if (endpointUri == null) {
    throw new ConnectorException(CoreMessages.endpointIsNullForListener(),this);
  }
  logger.info("Registering listener: " + service.getName() + " on endpointUri: "+ endpointUri.toString());
  if (getReceiver(service,endpoint) != null) {
    throw new ConnectorException(CoreMessages.listenerAlreadyRegistered(endpointUri),this);
  }
  MessageReceiver receiver=createReceiver(service,endpoint);
  MessageProcessor endpointMessageProcessor=createInboundEndpointMessageProcessorChain(endpoint,listener);
  receiver.setListener(endpointMessageProcessor);
  Object receiverKey=getReceiverKey(service,endpoint);
  receiver.setReceiverKey(receiverKey.toString());
  receiver.initialise();
  receivers.put(receiverKey,receiver);
  patternByEndpoint.put(endpoint.getName(),pattern);
  if (endpoint instanceof InboundEndpointDecorator) {
    ((InboundEndpointDecorator)endpoint).onListenerAdded(service);
  }
  if (isConnected()) {
    receiver.connect();
  }
  if (isStarted()) {
    receiver.start();
  }
}
