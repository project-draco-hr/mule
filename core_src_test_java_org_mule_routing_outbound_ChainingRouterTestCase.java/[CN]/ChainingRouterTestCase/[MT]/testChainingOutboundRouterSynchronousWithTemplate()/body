{
  Endpoint endpoint3=getTestEndpoint("Test3Provider",Endpoint.ENDPOINT_TYPE_SENDER);
  assertNotNull(endpoint3);
  endpoint3.setEndpointURI(new MuleEndpointURI("test://foo?[barValue]"));
  router.addEndpoint(endpoint3);
  Map m=new HashMap();
  m.put("barValue","bar");
  MuleMessage message=new DefaultMuleMessage("test event",m);
  assertTrue(router.isMatch(message));
  ImmutableEndpoint ep=router.getEndpoint(2,message);
  assertEquals("test://foo?bar",ep.getEndpointURI().toString());
  session.expectAndReturn("sendEvent",C.eq(message,new DynamicEndpointURIEndpoint((ImmutableEndpoint)router.getEndpoints().get(0),new MuleEndpointURI("test://test"))),message);
  session.expectAndReturn("sendEvent",C.eq(message,new DynamicEndpointURIEndpoint((ImmutableEndpoint)router.getEndpoints().get(1),new MuleEndpointURI("test://test"))),message);
  session.expectAndReturn("sendEvent",C.eq(message,new DynamicEndpointURIEndpoint((ImmutableEndpoint)router.getEndpoints().get(2),new MuleEndpointURI("test://foo?bar"))),message);
  final MuleMessage result=router.route(message,(MuleSession)session.proxy(),true);
  assertNotNull("This is a sync call, we need a result returned.",result);
  assertEquals(message,result);
  session.verify();
}
