{
  List<MuleEvent> failedEvents=context.selectEventsWithExceptions();
  if (CollectionUtils.isEmpty(failedEvents)) {
    return this.resultsHandler.aggregateResults(context.getEvents(),context.getOriginalEvent(),this.muleContext);
  }
 else {
    Map<Integer,Exception> exceptions=new LinkedHashMap<Integer,Exception>(failedEvents.size());
    for (    MuleEvent event : failedEvents) {
      ExceptionPayload ep=event.getMessage().getExceptionPayload();
      Integer routeIndex=(Integer)ep.getInfo().get(MuleProperties.MULE_CORRELATION_SEQUENCE_PROPERTY);
      Throwable t=ep.getException();
      Exception e=t instanceof Exception ? (Exception)t : new DefaultMuleException(t);
      exceptions.put(routeIndex,e);
    }
    throw new CompositeRoutingException(context.getOriginalEvent(),exceptions);
  }
}
