{
  boolean checkFileAge=((FileConnector)connector).getCheckFileAge();
  if (checkFileAge) {
    long fileAge=((FileConnector)connector).getFileAge();
    long lastMod=sourceFile.lastModified();
    long now=System.currentTimeMillis();
    long thisFileAge=now - lastMod;
    if (thisFileAge < fileAge) {
      if (logger.isDebugEnabled()) {
        logger.debug("The file has not aged enough yet, will return nothing for: " + sourceFile);
      }
      return;
    }
  }
  if (!attemptFileLock(sourceFile)) {
    return;
  }
  File destinationFile=null;
  String sourceFileOriginalName=sourceFile.getName();
  UMOMessageAdapter msgAdapter=null;
  try {
    Object payload=new ReceiverFileInputStream(sourceFile,moveDir != null);
    msgAdapter=connector.getMessageAdapter(payload);
  }
 catch (  FileNotFoundException e) {
    logger.error("File being read disappeared!",e);
    return;
  }
  msgAdapter.setProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,sourceFileOriginalName);
  if (moveDir != null) {
    String destinationFileName=sourceFileOriginalName;
    if (moveToPattern != null) {
      destinationFileName=((FileConnector)connector).getFilenameParser().getFilename(msgAdapter,moveToPattern);
    }
    destinationFile=FileUtils.newFile(moveDir,destinationFileName);
  }
  boolean fileWasMoved=false;
  try {
    if (!(sourceFile.canRead() && sourceFile.exists() && sourceFile.isFile())) {
      throw new MuleException(FileMessages.fileDoesNotExist(sourceFileOriginalName));
    }
    if (destinationFile != null) {
      fileWasMoved=this.moveFile(sourceFile,destinationFile);
      if (!fileWasMoved) {
        throw new MuleException(FileMessages.failedToMoveFile(sourceFile.getAbsolutePath(),destinationFile.getAbsolutePath()));
      }
      Object payload=getPayload(destinationFile,true);
      msgAdapter=connector.getMessageAdapter(payload);
      msgAdapter.setProperty(FileConnector.PROPERTY_FILENAME,destinationFile.getName());
      msgAdapter.setProperty(FileConnector.PROPERTY_ORIGINAL_FILENAME,sourceFileOriginalName);
    }
    this.routeMessage(new MuleMessage(msgAdapter),endpoint.isSynchronous());
    if (!((FileConnector)connector).isStreamFiles()) {
      boolean moveTo=destinationFile != null;
      File current=moveTo ? destinationFile : sourceFile;
      delete(current,moveTo);
    }
  }
 catch (  Exception e) {
    boolean fileWasRolledBack=false;
    if (fileWasMoved) {
      fileWasRolledBack=this.rollbackFileMove(destinationFile,sourceFile.getAbsolutePath());
    }
    Exception ex=new RoutingException(FileMessages.exceptionWhileProcessing(sourceFile.getName(),(fileWasRolledBack ? "successful" : "unsuccessful")),new MuleMessage(msgAdapter),endpoint,e);
    this.handleException(ex);
  }
}
