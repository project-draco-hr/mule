{
  Connection con=null;
  Transaction tx=TransactionCoordination.getInstance().getTransaction();
  try {
    MuleMessage muleMessage=createMuleMessage(message,endpoint.getEncoding());
    MuleEvent result=routeMessage(muleMessage);
    if (hasAckStatement()) {
      con=this.connector.getConnection();
      if (aggregateResult) {
        List<MuleMessage> messages=createMuleMessages((List)message);
        int[] nbRows=executeBatchAckStatement(con,messages);
        if (nbRows[0] == 0) {
          logger.warn(".ack statement did not update any rows");
        }
        aggregateResult=false;
      }
 else {
        int nbRows=executeAckStatement(con,muleMessage);
        if (nbRows == 0) {
          logger.warn(".ack statement did not update any rows");
        }
      }
    }
    return result;
  }
 catch (  Exception ex) {
    if (tx != null) {
      tx.setRollbackOnly();
    }
    throw ex;
  }
 finally {
    if (tx == null) {
      JdbcUtils.close(con);
    }
  }
}
