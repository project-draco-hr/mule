{
  UMOEvent[] result=null;
  if (this.isMatch(event)) {
    boolean miss=false;
    final Object groupId=this.getEventGroupIdForEvent(event);
    while (true) {
      if (miss) {
        try {
          Thread.sleep(1);
        }
 catch (        InterruptedException interrupted) {
          Thread.currentThread().interrupt();
        }
      }
      EventGroup group=this.getEventGroup(groupId);
      if (group == null) {
        group=this.addEventGroup(this.createEventGroup(event,groupId));
      }
synchronized (group) {
        if (group != this.getEventGroup(groupId)) {
          miss=true;
          continue;
        }
        group.addEvent(event);
        if (this.shouldAggregateEvents(group)) {
          UMOMessage returnMessage=this.aggregateEvents(group);
          UMOImmutableEndpoint endpoint;
          try {
            UMOManagementContext managementContext=MuleServer.getManagementContext();
            UMOEndpointBuilder builder=new EndpointURIEndpointBuilder(event.getEndpoint(),managementContext);
            builder.setTransformers(new LinkedList());
            builder.setName(this.getClass().getName());
            endpoint=managementContext.getRegistry().lookupEndpointFactory().getInboundEndpoint(builder,managementContext);
          }
 catch (          UMOException e) {
            throw new MessagingException(e.getI18nMessage(),returnMessage,e);
          }
          UMOEvent returnEvent=new MuleEvent(returnMessage,endpoint,event.getComponent(),event);
          result=new UMOEvent[]{returnEvent};
          this.removeEventGroup(group);
        }
        break;
      }
    }
  }
  return result;
}
