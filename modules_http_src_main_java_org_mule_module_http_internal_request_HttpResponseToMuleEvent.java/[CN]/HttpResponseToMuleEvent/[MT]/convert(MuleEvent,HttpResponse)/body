{
  String responseContentType=response.getHeaderValue(CONTENT_TYPE.toLowerCase());
  InputStream responseInputStream=((InputStreamHttpEntity)response.getEntity()).getInputStream();
  String encoding=getEncoding(responseContentType);
  Map<String,Object> inboundProperties=getInboundProperties(response);
  Map<String,DataHandler> inboundAttachments=null;
  Object payload=responseInputStream;
  if (responseContentType != null && parseResponse.resolveBooleanValue(muleEvent)) {
    if (responseContentType.startsWith(MULTI_PART_PREFIX)) {
      try {
        inboundAttachments=getInboundAttachments(responseInputStream,responseContentType);
        payload=NullPayload.getInstance();
      }
 catch (      IOException e) {
        throw new MessagingException(muleEvent,e);
      }
    }
 else     if (responseContentType.startsWith(APPLICATION_X_WWW_FORM_URLENCODED.toLowerCase())) {
      payload=HttpParser.decodeString(IOUtils.toString(responseInputStream),encoding);
    }
  }
  MuleMessage message=new DefaultMuleMessage(muleEvent.getMessage().getPayload(),inboundProperties,null,inboundAttachments,muleContext);
  if (encoding != null) {
    message.setEncoding(encoding);
  }
  muleEvent.setMessage(message);
  setResponsePayload(payload,muleEvent);
}
