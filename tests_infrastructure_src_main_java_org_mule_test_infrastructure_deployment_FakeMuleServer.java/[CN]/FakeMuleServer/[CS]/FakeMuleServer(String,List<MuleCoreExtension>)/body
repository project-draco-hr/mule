{
  final ContainerClassLoaderFactory containerClassLoaderFactory=new ContainerClassLoaderFactory();
  containerClassLoader=containerClassLoaderFactory.createContainerClassLoader(getClass().getClassLoader());
  this.coreExtensions=intialCoreExtensions;
  for (  MuleCoreExtension extension : coreExtensions) {
    extension.setContainerClassLoader(containerClassLoader);
  }
  muleHome=new File(muleHomePath);
  muleHome.deleteOnExit();
  try {
    System.setProperty(MuleProperties.MULE_HOME_DIRECTORY_PROPERTY,getMuleHome().getCanonicalPath());
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  try {
    setMuleFolders();
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  deploymentService=new MuleDeploymentService(containerClassLoader);
  deploymentListener=mock(DeploymentListener.class);
  deploymentService.addDeploymentListener(deploymentListener);
  coreExtensionManager=new DefaultMuleCoreExtensionManagerServer(new MuleCoreExtensionDiscoverer(){
    @Override public List<MuleCoreExtension> discover() throws DefaultMuleException {
      return coreExtensions;
    }
  }
,new ReflectionMuleCoreExtensionDependencyResolver());
  coreExtensionManager.setDeploymentService(deploymentService);
}
