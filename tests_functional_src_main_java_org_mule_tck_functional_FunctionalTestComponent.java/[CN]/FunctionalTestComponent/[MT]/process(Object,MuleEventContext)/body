{
  if (enableMessageHistory) {
    messageHistory.add(data);
  }
  String msg=StringMessageUtils.getBoilerPlate("Message Received in service: " + context.getService().getName() + ". Content is: "+ StringMessageUtils.truncate(data.toString(),100,true),'*',80);
  logger.info(msg);
  if (isLogMessageDetails()) {
    logger.info("Full Message payload: \n" + context.getMessage().getPayload());
    logger.info(StringMessageUtils.headersToString(context.getMessage()));
  }
  if (eventCallback != null) {
    eventCallback.eventReceived(context,this);
  }
  Object replyMessage;
  if (returnData != null) {
    if (returnData instanceof String && muleContext.getExpressionManager().isValidExpression(returnData.toString())) {
      replyMessage=muleContext.getExpressionManager().parse(returnData.toString(),context.getMessage());
    }
 else {
      replyMessage=returnData;
    }
  }
 else {
    if (appendString != null) {
      replyMessage=append(data.toString(),context.getMessage());
    }
 else {
      replyMessage=data;
    }
  }
  if (isEnableNotifications()) {
    MuleContext muleContext=context.getMuleContext();
    if (muleContext == null) {
      logger.warn("No MuleContext available from MuleEventContext");
      muleContext=MuleServer.getMuleContext();
    }
    muleContext.fireNotification(new FunctionalTestNotification(context,replyMessage,FunctionalTestNotification.EVENT_RECEIVED));
  }
  if (waitTime > 0) {
    try {
      Thread.sleep(waitTime);
    }
 catch (    InterruptedException e) {
      logger.info("FunctionalTestComponent waitTime was interrupted");
    }
  }
  return replyMessage;
}
