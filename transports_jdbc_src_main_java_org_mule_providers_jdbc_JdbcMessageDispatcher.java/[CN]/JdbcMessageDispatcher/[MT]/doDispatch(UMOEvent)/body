{
  if (logger.isDebugEnabled()) {
    logger.debug("Dispatch event: " + event);
  }
  UMOImmutableEndpoint endpoint=event.getEndpoint();
  String writeStmt=endpoint.getEndpointURI().getAddress();
  String str;
  if ((str=this.connector.getQuery(endpoint,writeStmt)) != null) {
    writeStmt=str;
  }
  if (StringUtils.isBlank(writeStmt)) {
    throw new IllegalArgumentException("Missing a write statement");
  }
  if (!"insert".equalsIgnoreCase(writeStmt.substring(0,6)) && !"update".equalsIgnoreCase(writeStmt.substring(0,6)) && !"delete".equalsIgnoreCase(writeStmt.substring(0,6))) {
    throw new IllegalArgumentException("Write statement should be an insert / update / delete sql statement");
  }
  List paramNames=new ArrayList();
  writeStmt=connector.parseStatement(writeStmt,paramNames);
  Object[] paramValues=connector.getParams(endpoint,paramNames,new MuleMessage(event.getTransformedMessage()));
  UMOTransaction tx=TransactionCoordination.getInstance().getTransaction();
  Connection con=null;
  try {
    con=this.connector.getConnection();
    int nbRows=connector.createQueryRunner().update(con,writeStmt,paramValues);
    if (nbRows != 1) {
      logger.warn("Row count for write should be 1 and not " + nbRows);
    }
    if (tx == null) {
      JdbcUtils.commitAndClose(con);
    }
    logger.debug("Event dispatched succesfuly");
  }
 catch (  Exception e) {
    logger.debug("Error dispatching event: " + e.getMessage(),e);
    if (tx == null) {
      JdbcUtils.rollbackAndClose(con);
    }
    throw e;
  }
}
