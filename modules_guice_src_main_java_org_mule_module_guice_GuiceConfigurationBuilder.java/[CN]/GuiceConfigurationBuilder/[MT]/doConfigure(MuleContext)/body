{
  List<Module> allModules=getSystemModules(muleContext);
  Injector injector;
  if (basepath != null && basepath.startsWith("/")) {
    basepath=basepath.substring(1);
  }
  if (modules == null) {
    ClasspathScanner scanner=new ClasspathScanner(classLoader,basepath);
    Set<Class<Module>> classes=scanner.scanFor(Module.class);
    Set<Class<GuiceModuleFactory>> factories=scanner.scanFor(GuiceModuleFactory.class);
    if (classes.size() == 0 && factories.size() == 0) {
      try {
        basepath=getClass().getClassLoader().getResources(basepath).toString();
      }
 catch (      Exception e) {
        basepath=(basepath.equals("") ? "/" : basepath);
      }
      logger.warn(new ConfigurationException(CoreMessages.createStaticMessage("There are no Guice modules or module factories on the classpath under: " + basepath)));
      return;
    }
    for (    Class<Module> moduleClass : classes) {
      allModules.add(ClassUtils.instanciateClass(moduleClass,ClassUtils.NO_ARGS));
    }
    for (    Class<GuiceModuleFactory> factoryClass : factories) {
      GuiceModuleFactory factory=ClassUtils.instanciateClass(factoryClass,ClassUtils.NO_ARGS);
      allModules.add(factory.createModule());
    }
  }
 else {
    allModules.addAll(Arrays.asList(modules));
  }
  for (  Module module : allModules) {
    if (module instanceof AbstractMuleGuiceModule) {
      ((AbstractMuleGuiceModule)module).setMuleContext(muleContext);
    }
  }
  if (stage != null) {
    injector=Guice.createInjector(stage,allModules);
  }
 else {
    injector=Guice.createInjector(allModules);
  }
  GuiceRegistry registry=new GuiceRegistry(injector,muleContext);
  registry.initialise();
  muleContext.addRegistry(registry);
}
