{
  Injector injector;
  if (basepath != null && basepath.startsWith("/")) {
    basepath=basepath.substring(1);
  }
  if (modules == null) {
    ClasspathScanner scanner=new ClasspathScanner(classLoader,new String[]{basepath});
    Set<Class> classes=scanner.scanFor(Module.class);
    Set<Class> factories=scanner.scanFor(GuiceModuleFactory.class);
    classes.remove(AbstractMuleGuiceModule.class);
    if (classes.size() == 0 && factories.size() == 0) {
      try {
        basepath=getClass().getClassLoader().getResources(basepath).toString();
      }
 catch (      Exception e) {
        basepath=(basepath.equals("") ? "/" : basepath);
      }
      logger.warn(new ConfigurationException(CoreMessages.createStaticMessage("There are no Guice modules or module factories on the classpath under: " + basepath)));
      return;
    }
    modules=new Module[classes.size() + factories.size()];
    int i=0;
    for (    Class moduleClass : classes) {
      Module module=(Module)ClassUtils.instanciateClass(moduleClass,ClassUtils.NO_ARGS);
      modules[i++]=module;
    }
    for (    Class factoryClass : factories) {
      GuiceModuleFactory factory=(GuiceModuleFactory)ClassUtils.instanciateClass(factoryClass,ClassUtils.NO_ARGS);
      modules[i++]=factory.createModule();
    }
  }
  for (int i=0; i < modules.length; i++) {
    Module module=modules[i];
    if (module instanceof AbstractMuleGuiceModule) {
      ((AbstractMuleGuiceModule)module).setMuleContext(muleContext);
    }
  }
  if (stage != null) {
    injector=Guice.createInjector(stage,modules);
  }
 else {
    injector=Guice.createInjector(modules);
  }
  GuiceRegistry registry=new GuiceRegistry(injector);
  muleContext.addRegistry(registry);
  for (Iterator<Key<?>> iterator=injector.getBindings().keySet().iterator(); iterator.hasNext(); ) {
    Key key=iterator.next();
    if (Connector.class.isAssignableFrom(key.getTypeLiteral().getRawType())) {
      Connector c=(Connector)injector.getInstance(key);
      c.setName(new ObjectNameHelper(muleContext).getConnectorName(c));
      muleContext.getRegistry().registerConnector(c);
    }
 else     if (Agent.class.isAssignableFrom(key.getTypeLiteral().getRawType())) {
      Agent a=(Agent)injector.getInstance(key);
      muleContext.getRegistry().registerAgent(a);
    }
 else     if (Transformer.class.isAssignableFrom(key.getTypeLiteral().getRawType())) {
      Transformer t=(Transformer)injector.getInstance(key);
      muleContext.getRegistry().registerTransformer(t);
    }
  }
  registry.initialise();
}
