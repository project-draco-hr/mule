{
  long t0=System.currentTimeMillis();
  if (timeout < 0) {
    timeout=Long.MAX_VALUE;
  }
  do {
    if (hasMessages(folder)) {
      int count=getMessageCount(folder);
      if (count > 0) {
        Message message=getNextMessage(folder);
        flagMessage(folder,message);
        return new MuleMessage(connector.getMessageAdapter(message));
      }
 else       if (count == -1) {
        throw new MessagingException("Cannot monitor folder: " + folder.getFullName() + " as folder is closed");
      }
    }
    long sleep=Math.min(this.connector.getCheckFrequency(),timeout - (System.currentTimeMillis() - t0));
    if (sleep > 0) {
      if (logger.isDebugEnabled()) {
        logger.debug("No results, sleeping for " + sleep);
      }
      Thread.sleep(sleep);
    }
 else {
      logger.debug("Timeout");
      return null;
    }
  }
 while (true);
}
