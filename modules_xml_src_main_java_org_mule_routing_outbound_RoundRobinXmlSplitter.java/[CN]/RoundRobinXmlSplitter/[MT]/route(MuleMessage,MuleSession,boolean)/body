{
  try {
    String correlationId=(String)propertyExtractor.getProperty(MuleProperties.MULE_CORRELATION_ID_PROPERTY,message);
    initialise(message);
    OutboundEndpoint endpoint;
    MuleMessage result=null;
    Document part;
    List parts=(List)nodesContext.get();
    if (parts == null) {
      logger.error("There are no parts for current message. No events were routed: " + message);
      return null;
    }
    int correlationSequence=1;
    Counter epCounter=new Counter();
    Iterator iterator=parts.iterator();
    while (iterator.hasNext()) {
      part=(Document)iterator.next();
      Map theProperties=(Map)propertiesContext.get();
      message=new DefaultMuleMessage(part,new HashMap(theProperties));
      if (enableEndpointFiltering) {
        endpoint=getEndpointForMessage(message);
      }
 else {
        endpoint=(OutboundEndpoint)getEndpoints().get(epCounter.next());
      }
      if (endpoint == null) {
        logger.error("There was no matching endpoint for message part: " + part.asXML());
      }
 else {
        try {
          if (enableCorrelation != ENABLE_CORRELATION_NEVER) {
            boolean correlationSet=message.getCorrelationId() != null;
            if (!correlationSet && (enableCorrelation == ENABLE_CORRELATION_IF_NOT_SET)) {
              message.setCorrelationId(correlationId);
            }
            final int groupSize=message.getCorrelationGroupSize();
            message.setCorrelationGroupSize(groupSize);
            message.setCorrelationSequence(correlationSequence++);
          }
          if (synchronous) {
            result=send(session,message,endpoint);
          }
 else {
            dispatch(session,message,endpoint);
          }
        }
 catch (        MuleException e) {
          throw new CouldNotRouteOutboundMessageException(message,endpoint,e);
        }
      }
    }
    return result;
  }
  finally {
    this.cleanup();
  }
}
