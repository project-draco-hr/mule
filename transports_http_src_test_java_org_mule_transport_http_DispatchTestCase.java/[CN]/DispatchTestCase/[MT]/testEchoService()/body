{
  final int THREADS=10;
  final CountDownLatch latch=new CountDownLatch(THREADS);
  final MuleClient client=muleContext.getClient();
  final byte[] buf=new byte[8192];
  Arrays.fill(buf,(byte)'a');
  client.send(((InboundEndpoint)muleContext.getRegistry().lookupObject("inEchoService")).getAddress(),new DefaultMuleMessage(new ByteArrayInputStream(buf),muleContext));
  for (int i=0; i < THREADS; i++) {
    new Thread(new Runnable(){
      @Override public void run(){
        Map<String,Object> props=new HashMap<String,Object>();
        props.put(MuleProperties.MULE_REPLY_TO_PROPERTY,"vm://queue");
        try {
          for (int j=0; j < 20; j++) {
            client.dispatch(((InboundEndpoint)muleContext.getRegistry().lookupObject("inEchoService")).getAddress(),new DefaultMuleMessage(buf,muleContext),props);
          }
        }
 catch (        MuleException e) {
          e.printStackTrace();
        }
 finally {
          latch.countDown();
        }
      }
    }
).start();
  }
  latch.await(40,TimeUnit.SECONDS);
  int count=0;
  while (client.request("vm://queue",RECEIVE_TIMEOUT) != null) {
    count++;
  }
  assertEquals(200,count);
}
