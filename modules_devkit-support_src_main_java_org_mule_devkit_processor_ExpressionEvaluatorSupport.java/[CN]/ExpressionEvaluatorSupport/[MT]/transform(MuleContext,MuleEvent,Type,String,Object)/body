{
  if ((source != null) && (!isAssignableFrom(expectedType,source.getClass()))) {
    DataType sourceDataType=DataTypeFactory.create(source.getClass());
    DataType targetDataType=null;
    if (expectedType instanceof ParameterizedType) {
      expectedType=((ParameterizedType)expectedType).getRawType();
    }
    if (expectedMimeType != null) {
      targetDataType=DataTypeFactory.create(((Class)expectedType),expectedMimeType);
    }
 else {
      targetDataType=DataTypeFactory.create(((Class)expectedType));
    }
    Transformer t=muleContext.getRegistry().lookupTransformer(sourceDataType,targetDataType);
    if (t instanceof MessageTransformer) {
      return ((MessageTransformer)t).transform(source,event);
    }
 else {
      return t.transform(source);
    }
  }
 else {
    return source;
  }
}
