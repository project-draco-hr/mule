{
  try {
    final UMOEndpointURI uri=endpoint.getEndpointURI();
    String filename=getFilename(endpoint,message);
    final FTPClient client=getFtp(uri);
    try {
      enterActiveOrPassiveMode(client,endpoint);
      setupFileType(client,endpoint);
      if (!client.changeWorkingDirectory(uri.getPath())) {
        throw new IOException("Ftp error: " + client.getReplyCode());
      }
      OutputStream out=client.storeFileStream(filename);
      return new CallbackOutputStream(out,new CallbackOutputStream.Callback(){
        public void onClose() throws Exception {
          try {
            if (!client.completePendingCommand()) {
              client.logout();
              client.disconnect();
              throw new IOException("FTP Stream failed to complete pending request");
            }
          }
  finally {
            releaseFtp(uri,client);
          }
        }
      }
);
    }
 catch (    Exception e) {
      logger.debug("Error getting output stream: ",e);
      releaseFtp(uri,client);
      throw e;
    }
  }
 catch (  Exception e) {
    throw new DispatchException(CoreMessages.streamingFailedNoStream(),message,endpoint,e);
  }
}
