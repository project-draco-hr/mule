{
  assertThat(server.getReceivedMessages().length,is(equalTo(UNREAD_MESSAGES + initialReadMessages)));
  flowExecutionListener.waitUntilFlowIsComplete();
  Prober prober=new PollingProber(TIMEOUT_MILLIS,POLL_DELAY_MILLIS);
  prober.check(new Probe(){
    @Override public boolean isSatisfied(){
      return (retrievedMessages.size() == UNREAD_MESSAGES);
    }
    @Override public String describeFailure(){
      return "Expected email count was " + UNREAD_MESSAGES + " but actual one was "+ retrievedMessages.size();
    }
  }
);
  for (int i=0; i < UNREAD_MESSAGES; i++) {
    assertThat("Missing email " + i,retrievedMessages.contains(String.valueOf(i)),is(equalTo(true)));
  }
}
