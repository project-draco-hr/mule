{
  try {
    Flags flags=msg.getFlags();
    EmailAttributesBuilder builder=EmailAttributesBuilder.newAttributes().withId(msg.getMessageNumber()).withSubject(msg.getSubject()).fromAddresses(msg.getFrom()).toAddresses(msg.getRecipients(TO)).ccAddresses(msg.getRecipients(CC)).bccAddresses(msg.getRecipients(BCC)).seen(flags.contains(SEEN)).replyToAddress(msg.getReplyTo()).recent(flags.contains(RECENT)).sentDate(msg.getSentDate()).receivedDate(msg.getReceivedDate()).draft(flags.contains(DRAFT)).answered(flags.contains(ANSWERED)).deleted(flags.contains(DELETED));
    return withAttachments ? builder.withAttachments(process(msg).getAttachments()).build() : builder.build();
  }
 catch (  MessagingException mse) {
    throw new EmailException(mse.getMessage(),mse);
  }
}
