{
  try {
    Folder folder=connection.getFolder(folderName,READ_ONLY);
    List<Message> list=new LinkedList<>();
    for (    javax.mail.Message m : folder.getMessages()) {
      Object body="";
      EmailAttributes attributes=fromMessage(m);
      if (matcher.test(attributes)) {
        if (readContent) {
          body=EmailContentProcessor.process(m).getBody();
          final List<Message> attachmentParts=process(m).getAttachments();
          if (!attachmentParts.isEmpty()) {
            final List<Message> parts=new ArrayList<>();
            parts.add(Message.builder().payload(body).attributes(BODY_ATTRIBUTES).build());
            parts.addAll(attachmentParts);
            body=new DefaultMultiPartContent(parts);
          }
        }
        attributes=fromMessage(m);
        list.add(Message.builder().payload(body).attributes(attributes).build());
      }
    }
    return list;
  }
 catch (  MessagingException me) {
    throw new EmailRetrieverException(me);
  }
}
