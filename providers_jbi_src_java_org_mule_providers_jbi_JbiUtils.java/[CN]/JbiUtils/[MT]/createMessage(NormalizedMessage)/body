{
  Map properties=new HashMap();
  for (Iterator iterator=message.getPropertyNames().iterator(); iterator.hasNext(); ) {
    String s=(String)iterator.next();
    properties.put(s,message.getProperty(s));
  }
  if (message.getSecuritySubject() != null) {
    properties.put(MuleProperties.MULE_USER_PROPERTY,message.getSecuritySubject());
  }
  try {
    Source source=message.getContent();
    ByteArrayOutputStream baos=new ByteArrayOutputStream();
    StreamResult result=new StreamResult(baos);
    TransformerFactory.newInstance().newTransformer().transform(source,result);
    UMOMessage msg=new MuleMessage(baos.toByteArray(),properties);
    baos.close();
    return msg;
  }
 catch (  Exception e) {
    throw new MessagingException(e.getMessage(),e);
  }
}
