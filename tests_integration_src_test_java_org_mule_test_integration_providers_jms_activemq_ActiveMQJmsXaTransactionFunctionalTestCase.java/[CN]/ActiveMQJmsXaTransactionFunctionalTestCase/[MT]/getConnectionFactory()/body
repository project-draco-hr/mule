{
  if (factory == null) {
    factory=new ActiveMQXAConnectionFactory();
    factory.setBrokerContainerFactory(new BrokerContainerFactoryImpl(new VMPersistenceAdapter()));
    factory.setUseEmbeddedBroker(true);
    factory.setBrokerURL("vm://localhost");
    factory.start();
  }
  return factory;
}
