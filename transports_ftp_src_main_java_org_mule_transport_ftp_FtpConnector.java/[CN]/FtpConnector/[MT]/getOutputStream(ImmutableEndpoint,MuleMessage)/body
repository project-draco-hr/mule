{
  try {
    final EndpointURI uri=endpoint.getEndpointURI();
    String filename=getFilename(endpoint,message);
    final FTPClient client;
    try {
      client=this.createFtpClient(endpoint);
    }
 catch (    Exception e) {
      throw new ConnectException(e,this);
    }
    try {
      OutputStream out=client.storeFileStream(filename);
      if (out == null) {
        throw new IOException("FTP operation failed: " + client.getReplyString());
      }
      return new CallbackOutputStream(out,new CallbackOutputStream.Callback(){
        public void onClose() throws Exception {
          try {
            if (!client.completePendingCommand()) {
              client.logout();
              client.disconnect();
              throw new IOException("FTP Stream failed to complete pending request");
            }
          }
  finally {
            releaseFtp(uri,client);
          }
        }
      }
);
    }
 catch (    Exception e) {
      logger.debug("Error getting output stream: ",e);
      releaseFtp(uri,client);
      throw e;
    }
  }
 catch (  ConnectException ce) {
    throw ce;
  }
catch (  Exception e) {
    throw new DispatchException(CoreMessages.streamingFailedNoStream(),message,endpoint,e);
  }
}
