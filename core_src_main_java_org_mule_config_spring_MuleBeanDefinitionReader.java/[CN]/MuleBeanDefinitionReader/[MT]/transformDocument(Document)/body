{
  if (getXslResource() != null) {
    DOMResult result;
    try {
      Transformer transformer=createTransformer(createXslSource());
      result=new DOMResult();
      transformer.setParameter("firstContext",Boolean.valueOf(isFirstContext()));
      transformer.transform(new DOMSource(document),result);
    }
  finally {
      if (XslHelper.hasErrorReport()) {
        String report=XslHelper.getFullReport();
        XslHelper.clearReport();
        throw new IOException(report);
      }
 else       if (XslHelper.hasWarningReport()) {
        logger.warn(XslHelper.getWarningReport());
      }
    }
    try {
      printResult(result);
    }
 catch (    Exception e) {
      e.printStackTrace();
    }
    return (Document)result.getNode();
  }
 else {
    return document;
  }
}
