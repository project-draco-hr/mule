{
  ExceptionListener exceptionListener=service.getExceptionListener();
  MuleEvent resultEvent=null;
  try {
    Object replyTo=event.getMessage().getReplyTo();
    ReplyToHandler replyToHandler=getReplyToHandler(event.getMessage(),(InboundEndpoint)event.getEndpoint());
    resultEvent=service.getComponent().process(event);
    resultEvent=processNext(resultEvent);
    resultEvent=receiveAsyncReplyMessageProcessor.process(resultEvent);
    if (resultEvent != null) {
      String replyToStop=resultEvent.getMessage().getInvocationProperty(MuleProperties.MULE_REPLY_TO_STOP_PROPERTY);
      if (!event.getEndpoint().getExchangePattern().hasResponse() || !BooleanUtils.toBoolean(replyToStop)) {
        processReplyTo(event,resultEvent,replyToHandler,replyTo);
      }
    }
  }
 catch (  Exception e) {
    event.getSession().setValid(false);
    if (e instanceof MessagingException) {
      exceptionListener.exceptionThrown(e);
    }
 else {
      exceptionListener.exceptionThrown(new MessagingException(CoreMessages.eventProcessingFailedFor(service.getName()),event.getMessage(),e));
    }
    if (event.getEndpoint().getExchangePattern().hasResponse()) {
      if (resultEvent == null) {
        if (exceptionListener != null && exceptionListener instanceof AbstractExceptionListener && ((AbstractExceptionListener)exceptionListener).getReturnMessage() != null) {
          resultEvent=new DefaultMuleEvent(((AbstractExceptionListener)exceptionListener).getReturnMessage(),event);
        }
 else {
          resultEvent=new DefaultMuleEvent(new DefaultMuleMessage(NullPayload.getInstance(),event.getMessage(),event.getMuleContext()),event);
        }
      }
      ExceptionPayload exceptionPayload=event.getMessage().getExceptionPayload();
      if (exceptionPayload == null) {
        exceptionPayload=new DefaultExceptionPayload(e);
      }
      resultEvent.getMessage().setExceptionPayload(exceptionPayload);
    }
  }
  return resultEvent;
}
