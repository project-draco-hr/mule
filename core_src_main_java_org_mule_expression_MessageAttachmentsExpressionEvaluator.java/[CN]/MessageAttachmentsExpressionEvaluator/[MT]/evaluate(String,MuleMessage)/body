{
  boolean required;
  Map<String,DataHandler> result;
  if (expression.contains(ALL_ARGUMENT)) {
    WildcardFilter filter=new WildcardFilter(expression);
    result=new HashMap<String,DataHandler>(message.getAttachmentNames().size());
    for (    String name : message.getAttachmentNames()) {
      if (filter.accept(name)) {
        result.put(name,message.getAttachment(name));
      }
    }
  }
 else {
    StringTokenizer tokenizer=new StringTokenizer(expression,DELIM);
    result=new HashMap<String,DataHandler>(tokenizer.countTokens());
    while (tokenizer.hasMoreTokens()) {
      String s=tokenizer.nextToken();
      s=s.trim();
      if (s.endsWith(OPTIONAL_ARGUMENT)) {
        s=s.substring(0,s.length() - OPTIONAL_ARGUMENT.length());
        required=false;
      }
 else {
        required=true;
      }
      DataHandler val=message.getAttachment(s);
      if (val != null) {
        result.put(s,val);
      }
 else       if (required) {
        throw new RequiredValueException(CoreMessages.expressionEvaluatorReturnedNull(NAME,expression));
      }
    }
  }
  if (result.size() == 0) {
    return Collections.unmodifiableMap(Collections.<String,DataHandler>emptyMap());
  }
 else {
    return Collections.unmodifiableMap(result);
  }
}
