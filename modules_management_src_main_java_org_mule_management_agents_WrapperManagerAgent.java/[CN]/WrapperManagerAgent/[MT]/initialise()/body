{
  boolean launchedByWrapper;
  if (System.getProperty(WRAPPER_SYSTEM_PROPERTY_NAME) == null) {
    launchedByWrapper=false;
  }
 else {
    lazyInitWrapperManager();
    launchedByWrapper=((WrapperManagerMBean)wrapperManagerRef.get()).isControlledByNativeWrapper();
  }
  if (!launchedByWrapper) {
    logger.info("This JVM hasn't been launched by the wrapper, the agent will not run.");
    try {
      managementContext.getRegistry().unregisterAgent(this.getName());
    }
 catch (    UMOException e) {
    }
    return;
  }
  jmxSupport=jmxSupportFactory.getJmxSupport();
  final List servers=MBeanServerFactory.findMBeanServer(null);
  if (servers.isEmpty()) {
    throw new RuntimeException("no mbean servers found");
  }
  try {
    mBeanServer=(MBeanServer)servers.get(0);
    wrapperName=jmxSupport.getObjectName(jmxSupport.getDomainName(managementContext) + ":" + WRAPPER_OBJECT_NAME);
    unregisterMBeansIfNecessary();
    mBeanServer.registerMBean(wrapperManagerRef.get(),wrapperName);
  }
 catch (  Exception e) {
    throw new InitialisationException(CoreMessages.failedToStart("wrapper agent"),e,this);
  }
}
