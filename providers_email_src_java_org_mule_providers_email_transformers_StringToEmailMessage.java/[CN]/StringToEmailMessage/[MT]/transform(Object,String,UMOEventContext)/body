{
  String endpointAddress=endpoint.getEndpointURI().getAddress();
  SmtpConnector connector=(SmtpConnector)endpoint.getConnector();
  UMOMessage eventMsg=context.getMessage();
  String to=eventMsg.getStringProperty(MailProperties.TO_ADDRESSES_PROPERTY,endpointAddress);
  String cc=eventMsg.getStringProperty(MailProperties.CC_ADDRESSES_PROPERTY,connector.getCcAddresses());
  String bcc=eventMsg.getStringProperty(MailProperties.BCC_ADDRESSES_PROPERTY,connector.getBccAddresses());
  String from=eventMsg.getStringProperty(MailProperties.FROM_ADDRESS_PROPERTY,connector.getFromAddress());
  String replyTo=eventMsg.getStringProperty(MailProperties.REPLY_TO_ADDRESSES_PROPERTY,connector.getReplyToAddresses());
  String subject=eventMsg.getStringProperty(MailProperties.SUBJECT_PROPERTY,connector.getSubject());
  String contentType=eventMsg.getStringProperty(MailProperties.CONTENT_TYPE_PROPERTY,connector.getContentType());
  Properties headers=new Properties();
  if (connector.getCustomHeaders() != null) {
    headers.putAll(connector.getCustomHeaders());
  }
  Properties otherHeaders=(Properties)eventMsg.getProperty(MailProperties.CUSTOM_HEADERS_MAP_PROPERTY);
  if (otherHeaders != null) {
    Map props=new HashMap(MuleManager.getInstance().getProperties());
    for (Iterator iterator=context.getMessage().getPropertyNames(); iterator.hasNext(); ) {
      Object o=iterator.next();
      props.put(o,context.getMessage().getProperty(o));
    }
    headers.putAll(templateParser.parse(props,otherHeaders));
  }
  if (logger.isDebugEnabled()) {
    StringBuffer buf=new StringBuffer(256);
    buf.append("Constucting email using:\n");
    buf.append("To: ").append(to);
    buf.append("From: ").append(from);
    buf.append("CC: ").append(cc);
    buf.append("BCC: ").append(bcc);
    buf.append("Subject: ").append(subject);
    buf.append("ReplyTo: ").append(replyTo);
    buf.append("Content type: ").append(contentType);
    buf.append("Payload type: ").append(src.getClass().getName());
    buf.append("Custom Headers: ").append(PropertiesHelper.propertiesToString(headers,false));
    logger.debug(buf.toString());
  }
  try {
    Message msg=new MimeMessage((Session)endpoint.getConnector().getDispatcher(endpointAddress).getDelegateSession());
    msg.setRecipients(Message.RecipientType.TO,MailUtils.stringToInternetAddresses(to));
    msg.setSentDate(Calendar.getInstance().getTime());
    if (StringUtils.isNotBlank(from)) {
      msg.setFrom(MailUtils.stringToInternetAddresses(from)[0]);
    }
    if (StringUtils.isNotBlank(cc)) {
      msg.setRecipients(Message.RecipientType.CC,MailUtils.stringToInternetAddresses(cc));
    }
    if (StringUtils.isNotBlank(bcc)) {
      msg.setRecipients(Message.RecipientType.BCC,MailUtils.stringToInternetAddresses(bcc));
    }
    if (StringUtils.isNotBlank(replyTo)) {
      eventMsg.setReplyTo(MailUtils.stringToInternetAddresses(replyTo));
    }
    msg.setSubject(subject);
    Map.Entry entry;
    for (Iterator iterator=headers.entrySet().iterator(); iterator.hasNext(); ) {
      entry=(Map.Entry)iterator.next();
      msg.setHeader(entry.getKey().toString(),entry.getValue().toString());
    }
    setContent(src,msg,contentType,context);
    return msg;
  }
 catch (  Exception e) {
    throw new TransformerException(this,e);
  }
}
