{
  if (message == null) {
    servletResponse.setStatus(HttpServletResponse.SC_NO_CONTENT);
    if (feedback) {
      servletResponse.setStatus(HttpServletResponse.SC_OK);
      servletResponse.getWriter().write("Action was processed successfully. There was no result");
    }
  }
 else {
    HttpResponse httpResponse;
    if (message.getPayload() instanceof HttpResponse) {
      httpResponse=(HttpResponse)message.getPayload();
    }
 else {
      httpResponse=new HttpResponse();
      httpResponse.setBody(new ByteArrayInputStream(message.getAdapter().getPayloadAsBytes()));
      String ct=message.getStringProperty(HttpConstants.HEADER_CONTENT_TYPE,null);
      if (ct != null) {
        httpResponse.setHeader(new Header(HttpConstants.HEADER_CONTENT_TYPE,ct));
      }
      httpResponse.setStatusLine(httpResponse.getHttpVersion(),message.getIntProperty(HttpConnector.HTTP_STATUS_PROPERTY,HttpServletResponse.SC_OK));
    }
    Header contentTypeHeader=httpResponse.getFirstHeader(HttpConstants.HEADER_CONTENT_TYPE);
    String contentType=null;
    if (contentTypeHeader == null) {
      contentType=defaultContentType;
    }
 else {
      contentType=contentTypeHeader.getValue();
    }
    if (!servletResponse.isCommitted()) {
      servletResponse.setStatus(httpResponse.getStatusCode());
    }
    if (!contentType.startsWith("text")) {
      servletResponse.setContentType(contentType);
      servletResponse.getOutputStream().write(httpResponse.getBodyBytes());
    }
 else {
      servletResponse.setContentType(contentType);
      servletResponse.getWriter().write(httpResponse.getBodyString());
    }
  }
  servletResponse.flushBuffer();
}
