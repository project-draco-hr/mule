{
  Connection con;
  if (tx.hasResource(dataSource)) {
    if (logger.isDebugEnabled()) {
      logger.debug("Retrieving connection from current transaction: " + tx);
    }
    con=(Connection)tx.getResource(dataSource);
  }
 else {
    con=connectionFactory.create(dataSource);
    try {
      tx.bindResource(dataSource,con);
    }
 catch (    TransactionException e) {
      if (con != null && !con.isClosed()) {
        con.close();
      }
      throw new ConnectionBindingException("Could not bind connection to current transaction: " + tx,e);
    }
  }
  return con;
}
