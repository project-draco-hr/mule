{
  MuleMessage result=null;
  if (endpoints == null || endpoints.size() == 0) {
    throw new RoutePathNotFoundException(CoreMessages.noEndpointsForRouter(),message,null);
  }
  try {
    OutboundEndpoint ep=endpoints.get(0);
    String uri=ep.getEndpointURI().toString();
    if (logger.isDebugEnabled()) {
      logger.debug("Uri before parsing is: " + uri);
    }
    Map props=new HashMap();
    props.putAll(ep.getProperties());
    for (    String propertyKey : message.getPropertyNames()) {
      props.put(propertyKey,message.getProperty(propertyKey));
    }
    uri=parser.parse(props,uri);
    if (logger.isDebugEnabled()) {
      logger.debug("Uri after parsing is: " + uri);
    }
    EndpointURI newUri=new MuleEndpointURI(uri,muleContext);
    if (!newUri.getScheme().equalsIgnoreCase(ep.getEndpointURI().getScheme())) {
      throw new CouldNotRouteOutboundMessageException(CoreMessages.schemeCannotChangeForRouter(ep.getEndpointURI().getScheme(),newUri.getScheme()),message,ep);
    }
    ep=new DynamicURIOutboundEndpoint(ep,new MuleEndpointURI(uri,muleContext));
    if (ep.isSynchronous()) {
      result=send(session,message,ep);
    }
 else {
      dispatch(session,message,ep);
    }
  }
 catch (  MuleException e) {
    throw new CouldNotRouteOutboundMessageException(message,endpoints.get(0),e);
  }
  return result;
}
