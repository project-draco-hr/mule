{
  DataInputStream dis=new DataInputStream(socket.getInputStream());
  if (timeout >= 0) {
    socket.setSoTimeout(timeout);
  }
  ByteArrayOutputStream baos=new ByteArrayOutputStream(connector.getBufferSize());
  byte[] buffer=new byte[connector.getBufferSize()];
  int len=0;
  try {
    while ((len=dis.read(buffer,len,buffer.length)) != 0) {
      if (len == -1) {
        logger.debug("The socket is closed");
        return null;
      }
 else {
        baos.write(buffer,0,len);
        if (len != buffer.length)         break;
      }
    }
    baos.flush();
    return baos.toByteArray();
  }
  finally {
    try {
      if (baos != null)       baos.close();
    }
 catch (    IOException e) {
      logger.error("failed to close tcp stream: " + e);
    }
  }
}
