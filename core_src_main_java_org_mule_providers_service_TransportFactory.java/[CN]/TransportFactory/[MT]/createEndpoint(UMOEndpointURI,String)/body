{
  String scheme=uri.getFullScheme();
  UMOConnector connector;
  try {
    if (uri.getCreateConnector() == ALWAYS_CREATE_CONNECTOR) {
      connector=createConnector(uri);
    }
 else     if (uri.getCreateConnector() == NEVER_CREATE_CONNECTOR) {
      connector=getConnectorByProtocol(scheme);
    }
 else     if (uri.getConnectorName() != null) {
      connector=RegistryContext.getRegistry().lookupConnector(uri.getConnectorName());
      if (connector == null) {
        throw new TransportFactoryException(CoreMessages.objectNotRegistered("Connector",uri.getConnectorName()));
      }
    }
 else {
      connector=getConnectorByProtocol(scheme);
      if (connector == null) {
        connector=createConnector(uri);
      }
    }
  }
 catch (  Exception e) {
    throw new TransportFactoryException(e);
  }
  if (connector == null) {
    Message m=CoreMessages.failedToCreateObjectWith("Endpoint","Uri: " + uri);
    m.setNextMessage(CoreMessages.objectIsNull("connector"));
    throw new TransportFactoryException(m);
  }
  UMOEndpoint endpoint=new MuleEndpoint();
  endpoint.setConnector(connector);
  endpoint.setEndpointURI(uri);
  if (uri.getEndpointName() != null) {
    endpoint.setName(uri.getEndpointName());
  }
  if (type != null) {
    endpoint.setType(type);
    UMOTransformer trans=getTransformer(uri,connector,(UMOEndpoint.ENDPOINT_TYPE_RECEIVER.equals(type) ? 0 : 1));
    endpoint.setTransformer(trans);
    if (UMOEndpoint.ENDPOINT_TYPE_RECEIVER.equals(type)) {
      trans=getTransformer(uri,connector,2);
      endpoint.setResponseTransformer(trans);
    }
  }
  try {
    RegistryContext.getRegistry().registerEndpoint(endpoint);
  }
 catch (  UMOException e) {
    throw new TransportFactoryException(e);
  }
  return endpoint;
}
