{
  if (!isConnected()) {
    throw new JMSException("Not connected");
  }
  UMOTransaction tx=TransactionCoordination.getInstance().getTransaction();
  Session session=getCurrentSession();
  if (session != null) {
    logger.debug("Retrieving jms session from current transaction");
    return session;
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Retrieving new jms session from connection: topic=" + topic + ", transacted="+ (transacted || tx != null)+ ", ack mode="+ acknowledgementMode+ ", nolocal="+ noLocal);
  }
  session=jmsSupport.createSession(connection,topic,transacted || tx != null,acknowledgementMode,noLocal);
  if (tx != null) {
    logger.debug("Binding session to current transaction");
    try {
      tx.bindResource(connection,session);
    }
 catch (    TransactionException e) {
      throw new RuntimeException("Could not bind session to current transaction",e);
    }
  }
  return session;
}
