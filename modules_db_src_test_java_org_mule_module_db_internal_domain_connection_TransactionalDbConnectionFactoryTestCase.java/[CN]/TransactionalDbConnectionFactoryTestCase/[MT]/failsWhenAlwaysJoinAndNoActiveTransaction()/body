{
  Connection expectedConnection=mock(Connection.class);
  when(datasource.getConnection()).thenReturn(expectedConnection);
  factory=new TransactionalDbConnectionFactory(dbTransactionManager,null,null,datasource);
  factory.createConnection(TransactionalAction.ALWAYS_JOIN);
}
