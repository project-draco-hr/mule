{
  MuleMessage message=new DefaultMuleMessage("data",muleContext);
  MuleEvent event=new DefaultMuleEvent(message,getTestInboundEndpoint(""),getTestService());
  SensingNullMessageProcessor flowListener=new SensingNullMessageProcessor();
  List<MessageProcessor> processors=new ArrayList<MessageProcessor>();
  processors.add(new MessageProcessor(){
    public MuleEvent process(    MuleEvent event) throws MuleException {
      event.getMessage().setInvocationProperty("newKey","newValue");
      return event;
    }
  }
);
  processors.add(flowListener);
  Flow flow=new Flow("flow",muleContext);
  flow.setMessageProcessors(processors);
  flow.initialise();
  flow.start();
  Object nonSerializable=new Object();
  message.setInvocationProperty("key","value");
  message.setInvocationProperty("key2",nonSerializable);
  flow.process(event);
  flowListener.latch.await(RECEIVE_TIMEOUT,TimeUnit.MILLISECONDS);
  MuleEvent processedEvent=flowListener.event;
  assertNotSame(processedEvent,event);
  assertNotSame(processedEvent.getSession(),event.getSession());
  assertEquals("value",processedEvent.getMessage().getInvocationProperty("key"));
  assertEquals(nonSerializable,processedEvent.getMessage().getInvocationProperty("key2"));
  assertEquals("newValue",processedEvent.getMessage().getInvocationProperty("newKey"));
  assertNull(event.getMessage().getInvocationProperty("newKey"));
  flow.stop();
  flow.dispose();
}
