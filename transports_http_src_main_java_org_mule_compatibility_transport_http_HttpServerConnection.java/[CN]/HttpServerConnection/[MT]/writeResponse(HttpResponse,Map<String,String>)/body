{
  if (response == null) {
    return;
  }
  if (!response.isKeepAlive()) {
    Header header=new Header(HttpConstants.HEADER_CONNECTION,"close");
    response.setHeader(header);
  }
  setKeepAlive(response.isKeepAlive());
  addHeadersToHttpResponse(response,headers);
  ResponseWriter writer=new ResponseWriter(this.out,encoding);
  OutputStream outstream=this.out;
  writer.println(response.getStatusLine());
  Iterator item=response.getHeaderIterator();
  while (item.hasNext()) {
    Header header=(Header)item.next();
    writer.print(header.toExternalForm());
  }
  writer.println();
  writer.flush();
  OutputHandler content=response.getBody();
  if (content != null) {
    Header transferenc=response.getFirstHeader(HttpConstants.HEADER_TRANSFER_ENCODING);
    if (transferenc != null) {
      response.removeHeaders(HttpConstants.HEADER_CONTENT_LENGTH);
      if (transferenc.getValue().indexOf(HttpConstants.TRANSFER_ENCODING_CHUNKED) != -1) {
        outstream=new ChunkedOutputStream(outstream);
      }
    }
    content.write(RequestContext.getEvent(),outstream);
    if (outstream instanceof ChunkedOutputStream) {
      ((ChunkedOutputStream)outstream).finish();
    }
  }
  outstream.flush();
}
