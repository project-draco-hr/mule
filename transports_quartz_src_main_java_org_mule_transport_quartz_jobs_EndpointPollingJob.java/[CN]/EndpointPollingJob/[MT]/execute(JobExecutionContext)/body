{
  MuleContext muleContext;
  try {
    muleContext=(MuleContext)jobExecutionContext.getScheduler().getContext().get(MuleProperties.MULE_CONTEXT_PROPERTY);
  }
 catch (  SchedulerException e) {
    throw new JobExecutionException("Failed to retrieve Mulecontext from the Scheduler Context: " + e.getMessage(),e);
  }
  final JobDataMap jobDataMap=jobExecutionContext.getJobDetail().getJobDataMap();
  String receiverKey=(String)jobDataMap.get(QuartzMessageReceiver.QUARTZ_RECEIVER_PROPERTY);
  if (receiverKey == null) {
    throw new JobExecutionException(QuartzMessages.receiverNotInJobDataMap().getMessage());
  }
  String connectorName=(String)jobDataMap.get(QuartzMessageReceiver.QUARTZ_CONNECTOR_PROPERTY);
  if (connectorName == null) {
    throw new JobExecutionException(QuartzMessages.connectorNotInJobDataMap().getMessage());
  }
  final QuartzConnector connector=(QuartzConnector)muleContext.getRegistry().lookupConnector(connectorName);
  if (connector == null) {
    throw new JobExecutionException(QuartzMessages.noConnectorFound(connectorName).getMessage());
  }
  final AbstractMessageReceiver receiver=(AbstractMessageReceiver)connector.lookupReceiver(receiverKey);
  if (receiver == null) {
    throw new JobExecutionException(QuartzMessages.noReceiverInConnector(receiverKey,connectorName).getMessage());
  }
  final EndpointPollingJobConfig jobConfig=(EndpointPollingJobConfig)jobDataMap.get(QuartzConnector.PROPERTY_JOB_CONFIG);
  if (jobConfig == null) {
    throw new JobExecutionException(QuartzMessages.missingJobDetail(QuartzConnector.PROPERTY_JOB_CONFIG).getMessage());
  }
  try {
    logger.debug("Attempting to receive event on: " + jobConfig.getEndpointRef());
    final EndpointBuilder epBuilder=muleContext.getRegistry().lookupEndpointBuilder(jobConfig.getEndpointRef());
    final boolean pollGlobalEndpoint=epBuilder != null;
    InboundEndpoint endpoint=null;
    TransactionTemplate tt;
    if (pollGlobalEndpoint) {
      endpoint=epBuilder.buildInboundEndpoint();
      tt=new TransactionTemplate(endpoint.getTransactionConfig(),endpoint.getConnector().getExceptionListener(),muleContext);
    }
 else {
      tt=new TransactionTemplate(new MuleTransactionConfig(),connector.getExceptionListener(),muleContext);
    }
    final InboundEndpoint finalEndpoint=endpoint;
    TransactionCallback cb=new TransactionCallback(){
      public Object doInTransaction() throws Exception {
        Transaction tx=TransactionCoordination.getInstance().getTransaction();
        if (tx != null) {
          tx.begin();
        }
        MuleMessage result=null;
        if (pollGlobalEndpoint) {
          result=finalEndpoint.getConnector().request(finalEndpoint,jobConfig.getTimeout());
        }
 else {
          MuleClient client=new MuleClient(connector.getMuleContext());
          result=client.request(jobConfig.getEndpointRef(),jobConfig.getTimeout());
        }
        if (result != null) {
          if (logger.isDebugEnabled()) {
            logger.debug("Received event on: " + jobConfig.getEndpointRef());
          }
          if (pollGlobalEndpoint) {
            result.applyTransformers(finalEndpoint.getTransformers());
          }
          result=(MuleMessage)((ThreadSafeAccess)result).newThreadCopy();
          result.addProperties(jobDataMap,PropertyScope.INVOCATION);
          receiver.routeMessage(result);
        }
        return null;
      }
    }
;
    tt.execute(cb);
  }
 catch (  RuntimeException rex) {
    throw rex;
  }
catch (  Exception e) {
    throw new JobExecutionException(e);
  }
}
