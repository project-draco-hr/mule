{
  try {
    dataIn=new DataInputStream(new BufferedInputStream(socket.getInputStream()));
    dataOut=new DataOutputStream(new BufferedOutputStream(socket.getOutputStream()));
    int counter=0;
    while (!socket.isClosed() && !disposing.get()) {
      if (isServerSide() && ++counter > 500) {
        counter=0;
        Thread.yield();
      }
      byte[] b=protocol.read(dataIn);
      if (b == null) {
        break;
      }
      byte[] result=processData(b);
      if (result != null) {
        protocol.write(dataOut,result);
      }
      dataOut.flush();
    }
  }
 catch (  Exception e) {
    handleException(e);
  }
 finally {
    dispose();
  }
}
