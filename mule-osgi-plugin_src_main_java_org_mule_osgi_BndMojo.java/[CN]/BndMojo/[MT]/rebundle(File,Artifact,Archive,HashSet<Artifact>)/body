{
  Properties properties=new Properties();
  properties.putAll(getDefaultProperties(project));
  properties.putAll(transformDirectives(instructions,archive));
  if (archive.getInstructions() != null) {
    properties.putAll(transformDirectives(archive.getInstructions(),archive));
  }
  header(properties,Analyzer.BUNDLE_NAME,artifact.getArtifactId());
  header(properties,Analyzer.BUNDLE_VERSION,archive.getVersion());
  File bundle=new File(jarFile.getAbsolutePath() + ".osgi");
  Builder builder=buildOSGiBundle(jarFile,bundle,dependencies,properties);
  List errors=builder.getErrors();
  List warnings=builder.getWarnings();
  for (Iterator w=warnings.iterator(); w.hasNext(); ) {
    String msg=(String)w.next();
    getLog().warn("Warning building bundle " + artifact + " : "+ msg);
  }
  for (Iterator e=errors.iterator(); e.hasNext(); ) {
    String msg=(String)e.next();
    getLog().error("Error building bundle " + artifact + " : "+ msg);
  }
  if (errors.size() > 0) {
    String failok=properties.getProperty("-failok");
    if (null == failok || "false".equalsIgnoreCase(failok)) {
      jarFile.delete();
      throw new MojoFailureException("Error(s) found in bundle configuration");
    }
  }
  return bundle;
}
