{
  Service s=new SedaService();
  s.setName("moveDeleteBridgeService");
  String url=fileToUrl(inFile.getParentFile()) + "?connector=moveDeleteConnector";
  org.mule.api.transformer.Transformer transformer=null;
  if (streaming) {
    if (filePayload) {
      fail("Inconsistant test case: streaming and file payload are not compatible");
    }
 else {
      transformer=new FileMessageAdaptorAssertingTransformer(FileMessageAdapter.class,ReceiverFileInputStream.class);
    }
  }
 else {
    if (filePayload) {
      transformer=new FileMessageAdaptorAssertingTransformer(FileMessageAdapter.class,File.class);
    }
 else {
      transformer=new FileMessageAdaptorAssertingTransformer(FileContentsMessageAdapter.class,byte[].class);
    }
  }
  EndpointBuilder endpointBuilder=new EndpointURIEndpointBuilder(new URIBuilder(url),muleContext);
  endpointBuilder.addTransformer(transformer);
  if (filePayload) {
    endpointBuilder.addTransformer(new NoActionTransformer());
  }
  endpointBuilder.setSynchronous(true);
  s.getInboundRouter().addEndpoint(muleContext.getRegistry().lookupEndpointFactory().getInboundEndpoint(endpointBuilder));
  final Latch latch=new Latch();
  FunctionalTestComponent component=new FunctionalTestComponent();
  component.setEventCallback(new EventCallback(){
    public void eventReceived(    final MuleEventContext context,    final Object message) throws Exception {
      assertEquals(1,latch.getCount());
      latch.countDown();
      assertEquals(TEST_MESSAGE,context.transformMessageToString());
    }
  }
);
  component.initialise();
  s.setComponent(new DefaultJavaComponent(new SingletonObjectFactory(component)));
  s.setModel(muleContext.getRegistry().lookupSystemModel());
  muleContext.getRegistry().registerService(s);
  s.start();
  return latch;
}
