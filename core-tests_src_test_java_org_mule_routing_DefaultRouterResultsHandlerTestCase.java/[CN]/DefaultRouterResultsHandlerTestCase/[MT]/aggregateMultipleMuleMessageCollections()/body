{
  MuleMessage message1=new DefaultMuleMessage("test event A",muleContext);
  MuleEvent event1=new DefaultMuleEvent(message1,flow);
  event1.setFlowVariable("key1","value1");
  MuleMessage message2=new DefaultMuleMessage("test event B",muleContext);
  MuleMessage message3=new DefaultMuleMessage("test event C",muleContext);
  MuleMessage message4=new DefaultMuleMessage("test event D",muleContext);
  MuleMessage message5=new DefaultMuleMessage("test event E",muleContext);
  List<MuleMessage> list=new ArrayList<>();
  list.add(message2);
  list.add(message3);
  MuleMessage messageCollection=new DefaultMuleMessage(list,muleContext);
  MuleEvent event2=new DefaultMuleEvent(messageCollection,flow);
  event2.setFlowVariable("key2","value2");
  List<MuleMessage> list2=new ArrayList<>();
  list.add(message4);
  list.add(message5);
  MuleMessage messageCollection2=new DefaultMuleMessage(list2,muleContext);
  MuleEvent event3=new DefaultMuleEvent(messageCollection2,flow);
  event3.setFlowVariable("key3","value3");
  List<MuleEvent> events=new ArrayList<MuleEvent>();
  events.add(event2);
  events.add(event3);
  MuleEvent result=resultsHandler.aggregateResults(events,event1,muleContext);
  assertNotNull(result);
  assertEquals(2,((List<MuleMessage>)result.getMessage().getPayload()).size());
  assertTrue(result.getMessage().getPayload() instanceof List<?>);
  assertEquals(messageCollection,((List<MuleMessage>)result.getMessage().getPayload()).get(0));
  assertEquals(messageCollection2,((List<MuleMessage>)result.getMessage().getPayload()).get(1));
  assertEquals("value1",result.getFlowVariable("key1"));
  assertNull(result.getFlowVariable("key2"));
  assertNull(result.getFlowVariable("key3"));
  assertEquals(event1.getMessage().getMessageRootId(),result.getMessage().getMessageRootId());
}
