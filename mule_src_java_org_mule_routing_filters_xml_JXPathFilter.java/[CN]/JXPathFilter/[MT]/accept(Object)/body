{
  if (obj == null) {
    logger.warn("Applying JXPathFilter to null object.");
    return false;
  }
  if (expression == null) {
    logger.warn("Expression for JXPathFilter is not set.");
    return false;
  }
  if (expectedValue == null) {
    if (expression.endsWith("= null") || expression.endsWith("=null")) {
      expectedValue="null";
      expression=expression.substring(0,expression.lastIndexOf("="));
    }
 else {
      logger.info("Expected value for JXPathFilter is not set, using 'true' by default");
      expectedValue=Boolean.TRUE.toString();
    }
  }
  Object xpathResult=null;
  boolean accept=false;
  if (obj instanceof Document) {
    xpathResult=((Document)obj).valueOf(expression);
  }
 else   if (obj instanceof String) {
    try {
      Document doc=DocumentHelper.parseText((String)obj);
      xpathResult=doc.valueOf(expression);
    }
 catch (    DocumentException e) {
      logger.warn("JXPathFilter unable to parse XML document: " + e.getMessage(),e);
      logger.debug("XML = " + StringMessageUtils.truncate((String)obj,200,false));
      return false;
    }
  }
 else {
    logger.debug("Passing object of type " + obj.getClass().getName() + " to JXPathContext");
    JXPathContext context=JXPathContext.newContext(obj);
    initialise(context);
    xpathResult=context.getValue(expression);
  }
  logger.debug("JXPathFilter Expression result = '" + xpathResult + "' -  Expected value = '"+ expectedValue+ "'");
  if (xpathResult != null) {
    accept=xpathResult.toString().equals(expectedValue);
  }
 else {
    if (expectedValue.equals("null")) {
      accept=true;
    }
 else {
      logger.warn("JXPathFilter expression evaluates to null: " + expression);
    }
  }
  logger.debug("JXPathFilter accept object  : " + accept);
  return accept;
}
