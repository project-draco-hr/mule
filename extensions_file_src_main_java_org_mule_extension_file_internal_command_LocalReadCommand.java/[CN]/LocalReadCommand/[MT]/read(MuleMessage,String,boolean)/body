{
  Path path=resolveExistingPath(filePath);
  if (Files.isDirectory(path)) {
    throw cannotReadDirectoryException(path);
  }
  FilePayload filePayload;
  if (lock) {
    filePayload=new LocalFilePayload(path,fileSystem.lock(path));
  }
 else {
    fileSystem.verifyNotLocked(path);
    filePayload=new LocalFilePayload(path);
  }
  DataType<FilePayload> updatedDataType=fileSystem.updateDataType(message.getDataType(),filePayload);
  return new DefaultMuleMessage(filePayload,updatedDataType);
}
