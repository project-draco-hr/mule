{
  Path path=resolveExistingPath(filePath);
  if (Files.isDirectory(path)) {
    throw cannotReadDirectoryException(path);
  }
  FilePayload filePayload;
  if (lock) {
    filePayload=new LocalFilePayload(path,fileSystem.lock(path));
  }
 else {
    fileSystem.verifyNotLocked(path);
    filePayload=new LocalFilePayload(path);
  }
  fileSystem.updateContentMetadata(filePayload,contentMetadata);
  return filePayload;
}
