{
  MuleEvent oldEvent=getCurrentEvent();
  MuleEvent event=getTestEvent(MuleMessage.builder().payload("a").addInboundProperty(AUTHORIZATION,"Basic a").build());
  setCurrentEvent(event);
  HttpBasicAuthenticationFilter filter=new HttpBasicAuthenticationFilter();
  SecurityManager manager=mock(SecurityManager.class);
  filter.setSecurityManager(manager);
  doThrow(new UnauthorisedException(null,event)).when(manager).authenticate(anyObject());
  try {
    filter.authenticate(event);
    fail("An UnauthorisedException should be thrown");
  }
 catch (  UnauthorisedException e) {
    assertThat(e.getEvent().getMessage().getOutboundProperty(WWW_AUTHENTICATE),is("Basic realm="));
    verify(manager);
  }
  setCurrentEvent(oldEvent);
}
