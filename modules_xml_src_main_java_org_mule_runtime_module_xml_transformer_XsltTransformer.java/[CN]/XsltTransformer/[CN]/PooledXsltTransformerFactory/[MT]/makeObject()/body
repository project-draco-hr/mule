{
  StreamSource source=XsltTransformer.this.getStreamSource();
  String factoryClassName=XsltTransformer.this.getXslTransformerFactory();
  TransformerFactory factory;
  if (PREFERRED_TRANSFORMER_FACTORY.equals(factoryClassName) && !ClassUtils.isClassOnPath(factoryClassName,getClass())) {
    logger.warn("Preferred Transfomer Factory " + PREFERRED_TRANSFORMER_FACTORY + " not on classpath and no default is set, defaulting to JDK");
    factoryClassName=null;
  }
  if (StringUtils.isNotEmpty(factoryClassName)) {
    factory=(TransformerFactory)ClassUtils.instanciateClass(factoryClassName,ClassUtils.NO_ARGS,this.getClass());
  }
 else {
    try {
      factory=TransformerFactory.newInstance();
    }
 catch (    TransformerFactoryConfigurationError e) {
      System.setProperty("javax.xml.transform.TransformerFactory",XMLUtils.TRANSFORMER_FACTORY_JDK5);
      factory=TransformerFactory.newInstance();
    }
  }
  factory.setURIResolver(getUriResolver());
  return factory.newTransformer(source);
}
