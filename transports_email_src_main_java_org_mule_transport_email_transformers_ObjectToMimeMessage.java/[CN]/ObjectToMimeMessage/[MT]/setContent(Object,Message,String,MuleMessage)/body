{
  boolean transformInboundAttachments=useInboundAttachments && message.getInboundAttachmentNames().size() > 0;
  boolean transformOutboundAttachments=useOutboundAttachments && message.getOutboundAttachmentNames().size() > 0;
  if (transformInboundAttachments || transformOutboundAttachments) {
    MimeMultipart multipart=new MimeMultipart("mixed");
    multipart.addBodyPart(getPayloadBodyPart(message.getPayload(),contentType));
    if (transformInboundAttachments) {
      for (      String name : message.getInboundAttachmentNames()) {
        if (!transformOutboundAttachments || message.getOutboundAttachment(name) == null) {
          BodyPart part=getBodyPartForAttachment(message.getInboundAttachment(name),name);
          addBodyPartHeaders(part,name,message);
          multipart.addBodyPart(part);
        }
      }
    }
    if (transformOutboundAttachments) {
      for (      String name : message.getOutboundAttachmentNames()) {
        BodyPart part=getBodyPartForAttachment(message.getOutboundAttachment(name),name);
        addBodyPartHeaders(part,name,message);
        multipart.addBodyPart(part);
      }
    }
    payload=multipart;
    contentType=multipart.getContentType();
  }
  super.setContent(payload,msg,contentType,message);
}
