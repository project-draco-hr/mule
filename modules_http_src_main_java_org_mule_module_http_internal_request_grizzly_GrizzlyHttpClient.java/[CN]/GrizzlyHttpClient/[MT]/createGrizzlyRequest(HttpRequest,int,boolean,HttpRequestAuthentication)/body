{
  RequestBuilder builder=new RequestBuilder();
  builder.setMethod(request.getMethod());
  builder.setUrl(request.getUri());
  builder.setFollowRedirects(followRedirects);
  for (  String headerName : request.getHeaderNames()) {
    for (    String headerValue : request.getHeaderValues(headerName)) {
      builder.addHeader(headerName,headerValue);
    }
  }
  if (!usePersistentConnections) {
    String connectionHeaderValue=request.getHeaderValue(CONNECTION);
    if (connectionHeaderValue != null && !CLOSE.equals(connectionHeaderValue) && logger.isDebugEnabled()) {
      logger.debug("Persistent connections are disabled in the HTTP requester configuration, but the request already " + "contains a Connection header with value {}. This header will be ignored, and a Connection: close header " + "will be sent instead.",connectionHeaderValue);
    }
    builder.setHeader(CONNECTION,CLOSE);
  }
  DefaultHttpRequest defaultHttpRequest=(DefaultHttpRequest)request;
  for (  String queryParamName : defaultHttpRequest.getQueryParams().keySet()) {
    for (    String queryParamValue : defaultHttpRequest.getQueryParams().getAll(queryParamName)) {
      builder.addQueryParam(queryParamName,queryParamValue);
    }
  }
  if (authentication != null) {
    Realm.RealmBuilder realmBuilder=new Realm.RealmBuilder().setPrincipal(authentication.getUsername()).setPassword(authentication.getPassword()).setUsePreemptiveAuth(authentication.isPreemptive());
    if (authentication.getType() == HttpAuthenticationType.BASIC) {
      realmBuilder.setScheme(Realm.AuthScheme.BASIC);
    }
 else     if (authentication.getType() == HttpAuthenticationType.DIGEST) {
      realmBuilder.setScheme(Realm.AuthScheme.DIGEST);
    }
 else     if (authentication.getType() == HttpAuthenticationType.NTLM) {
      String domain=authentication.getDomain();
      if (domain != null) {
        realmBuilder.setNtlmDomain(domain);
      }
      String workstation=authentication.getWorkstation();
      String ntlmHost=workstation != null ? workstation : InetAddress.getLocalHost().getHostName();
      realmBuilder.setNtlmHost(ntlmHost).setScheme(Realm.AuthScheme.NTLM);
    }
    builder.setRealm(realmBuilder.build());
  }
  if (request.getEntity() != null) {
    if (request.getEntity() instanceof InputStreamHttpEntity) {
      builder.setBody(new InputStreamBodyGenerator(((InputStreamHttpEntity)request.getEntity()).getInputStream()));
    }
 else     if (request.getEntity() instanceof ByteArrayHttpEntity) {
      builder.setBody(((ByteArrayHttpEntity)request.getEntity()).getContent());
    }
 else     if (request.getEntity() instanceof MultipartHttpEntity) {
      MultipartHttpEntity multipartHttpEntity=(MultipartHttpEntity)request.getEntity();
      for (      HttpPart part : multipartHttpEntity.getParts()) {
        if (part.getFileName() != null) {
          builder.addBodyPart(new ByteArrayPart(part.getName(),IOUtils.toByteArray(part.getInputStream()),part.getContentType(),null,part.getFileName()));
        }
 else {
          byte[] content=IOUtils.toByteArray(part.getInputStream());
          builder.addBodyPart(new ByteArrayPart(part.getName(),content,part.getContentType(),null));
        }
      }
    }
  }
  builder.setRequestTimeout(responseTimeout);
  return builder.build();
}
