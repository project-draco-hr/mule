{
  DefaultMessageProcessorChainBuilder builder=new DefaultMessageProcessorChainBuilder();
  final ResponseMessageProcessorAdapter innerResponseMessageProcessorAdapter=new ResponseMessageProcessorAdapter(getAppendingMP("4"));
  final ResponseMessageProcessorAdapter responseMessageProcessorAdapter=new ResponseMessageProcessorAdapter(newChain(innerResponseMessageProcessorAdapter,getAppendingMP("3")));
  builder.chain(getAppendingMP("1"),responseMessageProcessorAdapter,getAppendingMP("2"));
  process(builder.build(),getTestEventUsingFlow("0"));
  assertThat(process(builder.build(),getTestEventUsingFlow("0")).getMessage().getPayload().getValue(),equalTo("01234"));
  assertEquals(isMultipleThreadsUsed() ? 9 : 1,threads);
}
