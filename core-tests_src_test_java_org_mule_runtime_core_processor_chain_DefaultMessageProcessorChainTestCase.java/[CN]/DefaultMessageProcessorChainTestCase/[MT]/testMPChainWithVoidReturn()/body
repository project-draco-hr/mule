{
  DefaultMessageProcessorChainBuilder builder=new DefaultMessageProcessorChainBuilder(muleContext);
  AppendingMP mp1=getAppendingMP("1");
  AppendingMP mp2=getAppendingMP("2");
  ReturnVoidMP voidmp=new ReturnVoidMP();
  AppendingMP mp3=getAppendingMP("3");
  builder.chain(mp1,mp2,voidmp,mp3);
  MuleEvent requestEvent=getTestEventUsingFlow("0");
  assertEquals("0123",process(builder.build(),requestEvent).getMessage().getPayload());
  assertNotSame(mp1.event,mp1.resultEvent);
  assertNotSame(mp2.event,mp2.resultEvent);
  assertEquals(mp2.resultEvent.getMessage(),voidmp.event.getMessage());
  assertNotSame(mp3.event,mp2.resultEvent);
  assertThat(mp3.event.getMessage().getPayload(),equalTo(mp2.resultEvent.getMessage().getPayload()));
  assertEquals(mp3.event.getMessage().getPayload(),"012");
  assertEquals(isMultipleThreadsUsed() ? 4 : 1,threads);
}
