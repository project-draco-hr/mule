{
  logger.info("in doDispatch()");
  initialize(event.getEndpoint().getEndpointURI());
  try {
    Message message=(Message)event.getTransformedMessage();
    if (logger.isDebugEnabled()) {
      logger.debug("Transformed message: " + message.toXML());
    }
    while (!xmppConnection.isConnected() && !initialized.get()) {
      initialize(null);
      Thread.sleep(150);
    }
    try {
      xmppConnection.createChat(message.getTo()).sendMessage(message);
      logger.debug("message successfully sent");
    }
 catch (    IllegalStateException ex) {
      connector.exceptionThrown(ex);
    }
  }
 catch (  ClassCastException ex) {
    connector.handleException(ex);
  }
}
