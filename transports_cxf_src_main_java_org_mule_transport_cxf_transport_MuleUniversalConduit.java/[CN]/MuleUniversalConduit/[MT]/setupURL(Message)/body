{
  String value=(String)message.get(Message.ENDPOINT_ADDRESS);
  String pathInfo=(String)message.get(Message.PATH_INFO);
  String queryString=(String)message.get(Message.QUERY_STRING);
  String username=(String)message.get(BindingProvider.USERNAME_PROPERTY);
  String password=(String)message.get(BindingProvider.PASSWORD_PROPERTY);
  String result=value != null ? value : getTargetOrEndpoint();
  if (username != null) {
    int slashIdx=result.indexOf("//");
    if (slashIdx != -1) {
      result=result.substring(0,slashIdx + 2) + username + ":"+ password+ "@"+ result.substring(slashIdx + 2);
    }
  }
  if (null != pathInfo && !result.endsWith(pathInfo)) {
    result=result + pathInfo;
  }
  if (queryString != null) {
    result=result + "?" + queryString;
  }
  return result;
}
