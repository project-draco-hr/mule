{
  if (endpoints == null || endpoints.size() == 0) {
    throw new RoutePathNotFoundException(CoreMessages.noEndpointsForRouter(),message,null);
  }
  final int endpointsCount=endpoints.size();
  if (enableCorrelation != ENABLE_CORRELATION_NEVER) {
    boolean correlationSet=message.getCorrelationId() != null;
    if (correlationSet && (enableCorrelation == ENABLE_CORRELATION_IF_NOT_SET)) {
      logger.debug("CorrelationId is already set, not setting Correlation group size");
    }
 else {
      message.setCorrelationGroupSize(endpointsCount);
    }
  }
  MuleMessage result=null;
  ImmutableEndpoint endpoint=null;
  boolean success=false;
synchronized (endpoints) {
    for (int i=0; i < endpointsCount; i++) {
      endpoint=getEndpoint(i,message);
      boolean lastEndpoint=(i == endpointsCount - 1);
      if (!lastEndpoint) {
        logger.info("Sync mode will be forced for " + endpoint.getEndpointURI() + ", as there are more endpoints available.");
      }
      if (!lastEndpoint || synchronous) {
        try {
          result=send(session,message,endpoint);
          if (!exceptionPayloadAvailable(result)) {
            if (logger.isDebugEnabled()) {
              logger.debug("Successful invocation detected, stopping further processing.");
            }
            success=true;
            break;
          }
        }
 catch (        MuleException e) {
          logger.warn("Failed to send to endpoint: " + endpoint.getEndpointURI().toString() + ". Error was: "+ ExceptionHelper.getRootException(e)+ ". Trying next endpoint");
        }
      }
 else {
        try {
          dispatch(session,message,endpoint);
          success=true;
          break;
        }
 catch (        MuleException e) {
          logger.info("Failed to dispatch to endpoint: " + endpoint.getEndpointURI().toString() + ". Error was: "+ e.getMessage()+ ". Trying next endpoint");
        }
      }
    }
  }
  if (!success) {
    throw new CouldNotRouteOutboundMessageException(message,endpoint);
  }
  return result;
}
