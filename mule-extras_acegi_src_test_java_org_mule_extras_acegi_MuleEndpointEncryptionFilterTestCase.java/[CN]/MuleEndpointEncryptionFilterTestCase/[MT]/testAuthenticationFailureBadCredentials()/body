{
  MuleClient client=new MuleClient();
  Map props=new HashMap();
  UMOEncryptionStrategy strategy=MuleManager.getInstance().getSecurityManager().getEncryptionStrategy("PBE");
  String user=new MuleCredentials("anonX","anonX".toCharArray()).getToken();
  user=new String(strategy.encrypt(user.getBytes(),null));
  props.put(MuleProperties.MULE_USER_PROPERTY,user);
  UMOMessage m=client.send("vm://my.queue","foo",props);
  assertNotNull(m);
  assertNotNull(m.getExceptionPayload());
  assertEquals(ExceptionHelper.getErrorCode(UnauthorisedException.class),m.getExceptionPayload().getCode());
}
