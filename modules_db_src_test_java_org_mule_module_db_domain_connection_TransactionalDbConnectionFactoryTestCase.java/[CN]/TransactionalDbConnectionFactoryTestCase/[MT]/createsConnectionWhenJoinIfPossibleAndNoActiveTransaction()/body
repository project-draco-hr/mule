{
  Connection expectedConnection=mock(Connection.class);
  when(datasource.getConnection()).thenReturn(expectedConnection);
  DbConfig dbConfig=mock(DbConfig.class);
  when(dbConfig.getDataSource()).thenReturn(datasource);
  factory=new TransactionalDbConnectionFactory(dbConfig,dbTransactionManager);
  DbConnection connection=factory.createConnection(TransactionalAction.JOIN_IF_POSSIBLE);
  assertEquals(expectedConnection,connection.getDelegate());
}
