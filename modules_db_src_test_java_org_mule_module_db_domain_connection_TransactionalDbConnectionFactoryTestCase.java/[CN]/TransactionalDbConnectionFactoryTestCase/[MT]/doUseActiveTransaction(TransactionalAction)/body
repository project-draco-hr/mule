{
  Connection expectedConnection=mock(Connection.class);
  Transaction transaction=mock(Transaction.class);
  when(transaction.hasResource(datasource)).thenReturn(true);
  when(transaction.getResource(datasource)).thenReturn(expectedConnection);
  when(dbTransactionManager.getTransaction()).thenReturn(transaction);
  DbConfig dbConfig=mock(DbConfig.class);
  when(dbConfig.getDataSource()).thenReturn(datasource);
  factory=new TransactionalDbConnectionFactory(dbConfig,dbTransactionManager,null);
  DbConnection connection=factory.createConnection(transactionalAction);
  assertEquals(expectedConnection,connection.getDelegate());
  verify(datasource,times(0)).getConnection();
}
