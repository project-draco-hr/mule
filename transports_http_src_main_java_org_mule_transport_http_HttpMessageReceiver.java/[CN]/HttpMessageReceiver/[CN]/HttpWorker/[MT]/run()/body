{
  long keepAliveTimeout=((TcpConnector)connector).getKeepAliveTimeout();
  try {
    do {
      conn.setKeepAlive(false);
      if (keepAliveTimeout > 0) {
        ((HttpConnector)connector).getKeepAliveMonitor().addExpirable(keepAliveTimeout,TimeUnit.MILLISECONDS,this);
      }
      HttpRequest request=conn.readRequest();
      if (request == null) {
        break;
      }
      ((HttpConnector)connector).getKeepAliveMonitor().removeExpirable(this);
      conn.writeResponse(processRequest(request));
      if (request.getBody() != null) {
        request.getBody().close();
      }
    }
 while (conn.isKeepAlive());
  }
 catch (  Exception e) {
    getFlowConstruct().getExceptionListener().exceptionThrown(e);
  }
 finally {
    logger.debug("Closing HTTP connection.");
    if (conn.isOpen()) {
      conn.close();
      conn=null;
      ((HttpConnector)connector).getKeepAliveMonitor().removeExpirable(this);
    }
  }
}
