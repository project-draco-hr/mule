{
  final FlowConstruct testSedaService=muleContext.getRegistry().lookupFlowConstruct("testComponent");
  FunctionalTestComponent testComponent=(FunctionalTestComponent)getComponent(testSedaService);
  assertNotNull(testComponent);
  final AtomicBoolean callbackMade=new AtomicBoolean(false);
  EventCallback callback=new EventCallback(){
    @Override public void eventReceived(    MuleEventContext context,    Object component) throws Exception {
      assertTrue(callbackMade.compareAndSet(false,true));
      MuleMessage msg=context.getMessage();
      assertEquals(TEST_MESSAGE,getPayloadAsString(msg));
    }
  }
;
  testComponent.setEventCallback(callback);
  MuleClient client=muleContext.getClient();
  Map<String,Object> props=new HashMap<String,Object>();
  props.put(HttpConstants.HEADER_CONTENT_TYPE,"text/plain;charset=UTF-8");
  MuleMessage result=client.send("clientEndpoint",TEST_MESSAGE,props);
  assertNotNull(result);
  assertEquals(TEST_MESSAGE + " Received",getPayloadAsString(result));
  assertTrue("Callback never fired",callbackMade.get());
}
