{
  if (threadingProfile == null) {
    threadingProfile=muleContext.getDefaultServiceThreadingProfile();
  }
  final MuleConfiguration config=muleContext.getConfiguration();
  final boolean containerMode=config.isContainerMode();
  final String threadPrefix=containerMode ? String.format("[%s].flow.%s",config.getId(),getName()) : String.format("flow.%s",getName());
  builder.chain(new ProcessIfStartedMessageProcessor(this,getLifecycleState()));
  builder.chain(new ProcessingTimeInterceptor());
  builder.chain(new LoggingInterceptor());
  builder.chain(new FlowConstructStatisticsMessageProcessor());
  if (messageSource != null) {
    builder.chain(new OptionalAsyncInterceptingMessageProcessor(threadingProfile,threadPrefix,muleContext.getConfiguration().getShutdownTimeout()));
  }
  for (  Object processor : messageProcessors) {
    if (processor instanceof MessageProcessor) {
      builder.chain((MessageProcessor)processor);
    }
 else     if (processor instanceof MessageProcessorBuilder) {
      builder.chain((MessageProcessorBuilder)processor);
    }
 else {
      throw new IllegalArgumentException("MessageProcessorBuilder should only have MessageProcessor's or MessageProcessorBuilder's configured");
    }
  }
  builder.chain(new ReplyToPropertyRequestReplyReplier());
}
