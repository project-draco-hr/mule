{
  Service fc=getTestService();
  MuleSession session=getTestSession(fc,muleContext);
  Map<String,Object> inboundProps=new HashMap<String,Object>();
  inboundProps.put("inbound1","1");
  inboundProps.put("inbound2",2);
  inboundProps.put("inbound3",session);
  Map<String,Object> outboundProps=new HashMap<String,Object>();
  outboundProps.put("outbound1","3");
  outboundProps.put("outbound2",4);
  outboundProps.put("outbound3",session);
  Map<String,Object> invocationProps=new HashMap<String,Object>();
  invocationProps.put("invoke1","5");
  invocationProps.put("invoke2",6);
  invocationProps.put("invoke3",session);
  Set<Integer> expectedSequences=new HashSet<Integer>();
  for (int i=1; i <= count; i++) {
    expectedSequences.add(i);
  }
  MuleMessage toSplit=new DefaultMuleMessage(payload,inboundProps,outboundProps,null,muleContext);
  for (  Map.Entry<String,Object> entry : invocationProps.entrySet()) {
    toSplit.setInvocationProperty(entry.getKey(),entry.getValue());
  }
  CollectionSplitter splitter=new CollectionSplitter();
  splitter.setMuleContext(muleContext);
  Grabber grabber=new Grabber();
  splitter.setListener(grabber);
  DefaultMuleEvent event=new DefaultMuleEvent(toSplit,getTestInboundEndpoint("ep"),session);
  splitter.process(event);
  List<MuleMessage> splits=grabber.getMessages();
  assertEquals(count,splits.size());
  Set<Object> actualSequences=new HashSet<Object>();
  for (  MuleMessage msg : splits) {
    assertTrue(msg.getPayload() instanceof String);
    assertEquals(counted ? count : -1,msg.getOutboundProperty(MuleProperties.MULE_CORRELATION_GROUP_SIZE_PROPERTY));
    actualSequences.add(msg.getOutboundProperty(MuleProperties.MULE_CORRELATION_SEQUENCE_PROPERTY));
    String str=(String)msg.getPayload();
    assertTrue(TEST_LIST.contains(str));
    for (    String key : inboundProps.keySet()) {
      assertEquals(msg.getInboundProperty(key),inboundProps.get(key));
    }
    for (    String key : outboundProps.keySet()) {
      assertEquals(msg.getOutboundProperty(key),outboundProps.get(key));
    }
    for (    String key : invocationProps.keySet()) {
      assertEquals(msg.getInvocationProperty(key),invocationProps.get(key));
    }
  }
  assertEquals(expectedSequences,actualSequences);
}
