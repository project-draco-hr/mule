{
  BPMS bpms=muleContext.getRegistry().lookupObject(BPMS.class);
  assertNotNull(bpms);
  MuleMessage response=muleContext.getClient().send("vm://fork","data",null);
  ProcessInstance process=(ProcessInstance)response.getPayload();
  String state=(String)bpms.getState(process);
  assertTrue(state.contains("waitForResponseA"));
  assertTrue(state.contains("waitForResponseB"));
  Thread.sleep(2000);
  process=(ProcessInstance)bpms.lookupProcess(process.getId());
  assertEquals("waitForResponseA",bpms.getState(process));
  Flow flow=muleContext.getRegistry().lookupObject("ServiceA");
  flow.start();
  Thread.sleep(2000);
  process=(ProcessInstance)bpms.lookupProcess(process.getId());
  assertTrue("Process should have ended, but is in state " + bpms.getState(process),bpms.hasEnded(process));
}
