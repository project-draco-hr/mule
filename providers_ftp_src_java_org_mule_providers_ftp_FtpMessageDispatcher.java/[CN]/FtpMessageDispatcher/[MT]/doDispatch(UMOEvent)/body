{
  FTPClient client=null;
  final UMOEndpoint endpoint=event.getEndpoint();
  UMOEndpointURI uri=endpoint.getEndpointURI();
  try {
    String filename=(String)event.getProperty(FtpConnector.PROPERTY_FILENAME);
    if (filename == null) {
      String outPattern=(String)event.getProperty(FtpConnector.PROPERTY_OUTPUT_PATTERN);
      if (outPattern == null) {
        outPattern=connector.getOutputPattern();
      }
      filename=generateFilename(event,outPattern);
    }
    if (filename == null) {
      throw new IOException("Filename is null");
    }
    byte[] buf;
    Object data=event.getTransformedMessage();
    if (data instanceof byte[]) {
      buf=(byte[])data;
    }
 else {
      buf=data.toString().getBytes();
    }
    client=connector.getFtp(uri);
    connector.enterActiveOrPassiveMode(client,endpoint.getProperties());
    if (!client.changeWorkingDirectory(uri.getPath())) {
      throw new IOException("Ftp error: " + client.getReplyCode());
    }
    if (!client.storeFile(filename,new ByteArrayInputStream(buf))) {
      throw new IOException("Ftp error: " + client.getReplyCode());
    }
  }
  finally {
    connector.releaseFtp(uri,client);
  }
}
