{
  Object requestBody;
  Object request=event.getMessage().getPayload();
  String tempUrl=serviceUrl;
  if (muleContext.getExpressionManager().isExpression(serviceUrl)) {
    muleContext.getExpressionManager().validateExpression(serviceUrl);
    tempUrl=muleContext.getExpressionManager().parse(serviceUrl,event,true);
  }
  StringBuilder urlBuffer=new StringBuilder(tempUrl);
  if (GET.equalsIgnoreCase(this.httpMethod) || DELETE.equalsIgnoreCase(this.httpMethod)) {
    requestBody=NullPayload.getInstance();
    setRESTParams(urlBuffer,event,request,requiredParams,false,null);
    setRESTParams(urlBuffer,event,request,optionalParams,true,null);
  }
 else {
    if (MediaType.ANY.matches(event.getMessage().getDataType().getMediaType())) {
      event.setMessage(MuleMessage.builder(event.getMessage()).mediaType(MediaType.parse(CONTENT_TYPE_VALUE)).build());
    }
    StringBuilder requestBodyBuffer=new StringBuilder();
    setRESTParams(urlBuffer,event,request,requiredParams,false,requestBodyBuffer);
    setRESTParams(urlBuffer,event,request,optionalParams,true,requestBodyBuffer);
    requestBody=requestBodyBuffer.toString();
  }
  tempUrl=urlBuffer.toString();
  logger.info("Invoking REST service: " + tempUrl);
  event.setMessage(MuleMessage.builder(event.getMessage()).addOutboundProperty(HTTP_METHOD_PROPERTY,httpMethod).build());
  EndpointBuilder endpointBuilder=new EndpointURIEndpointBuilder(tempUrl,muleContext);
  endpointBuilder.setExchangePattern(REQUEST_RESPONSE);
  OutboundEndpoint outboundEndpoint=endpointBuilder.buildOutboundEndpoint();
  MuleEventContext eventContext=new DefaultMuleEventContext(event);
  MuleEvent result=new DefaultMuleEvent(eventContext.sendEvent(MuleMessage.builder(event.getMessage()).payload(requestBody).build(),outboundEndpoint.getEndpointURI().toString()),flowConstruct);
  if (isErrorPayload(result)) {
    handleException(new RestServiceException(CoreMessages.failedToInvokeRestService(tempUrl),event,this),result.getMessage());
  }
  return result.getMessage();
}
