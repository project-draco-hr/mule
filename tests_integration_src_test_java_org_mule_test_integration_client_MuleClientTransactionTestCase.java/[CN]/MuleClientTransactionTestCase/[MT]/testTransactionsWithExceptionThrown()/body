{
  final MuleClient client=new MuleClient(muleContext);
  final Map<String,Object> props=new HashMap<String,Object>();
  props.put("JMSReplyTo","replyTo.queue");
  props.put(MuleProperties.MULE_REMOTE_SYNC_PROPERTY,"false");
  while (client.request("jms://replyTo.queue",2000) != null) {
  }
  MuleTransactionConfig tc=new MuleTransactionConfig();
  tc.setFactory(new JmsTransactionFactory());
  tc.setAction(TransactionConfig.ACTION_ALWAYS_BEGIN);
  EndpointBuilder endpointBuilder=new EndpointURIEndpointBuilder(new URIBuilder("jms://test.queue",muleContext));
  endpointBuilder.setTransactionConfig(tc);
  endpointBuilder.setName("TransactedTest.Queue");
  ImmutableEndpoint inboundEndpoint=muleContext.getRegistry().lookupEndpointFactory().getOutboundEndpoint(endpointBuilder);
  client.getMuleContext().getRegistry().registerEndpoint(inboundEndpoint);
  TransactionTemplate<Void> tt=new TransactionTemplate<Void>(tc,null,muleContext);
  try {
    tt.execute(new TransactionCallback<Void>(){
      public Void doInTransaction() throws Exception {
        for (int i=0; i < 100; i++) {
          client.send("jms://test.queue","Test Client Dispatch message " + i,props);
        }
        throw new Exception();
      }
    }
);
    fail();
  }
 catch (  Exception e) {
  }
  MuleMessage result=client.request("jms://replyTo.queue",2000);
  assertNull(result);
}
