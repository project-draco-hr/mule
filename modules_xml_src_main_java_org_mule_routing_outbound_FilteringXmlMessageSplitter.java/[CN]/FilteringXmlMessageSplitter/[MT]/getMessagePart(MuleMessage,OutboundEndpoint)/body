{
  List nodes=(List)nodesContext.get();
  if (nodes == null) {
    logger.error("Error: nodes are null");
    return null;
  }
  for (Iterator i=nodes.iterator(); i.hasNext(); ) {
    Document doc=(Document)i.next();
    try {
      Map theProperties=(Map)propertiesContext.get();
      MuleMessage result=new DefaultMuleMessage(doc,new HashMap(theProperties));
      if (endpoint.getFilter() == null || endpoint.getFilter().accept(result)) {
        if (logger.isDebugEnabled()) {
          logger.debug("Endpoint filter matched for node " + i + " of "+ nodes.size()+ ". Routing message over: "+ endpoint.getEndpointURI().toString());
        }
        i.remove();
        return result;
      }
 else {
        if (logger.isDebugEnabled()) {
          logger.debug("Endpoint filter did not match, returning null");
        }
      }
    }
 catch (    Exception e) {
      logger.error("Unable to create message for node at position " + i,e);
      return null;
    }
  }
  return null;
}
