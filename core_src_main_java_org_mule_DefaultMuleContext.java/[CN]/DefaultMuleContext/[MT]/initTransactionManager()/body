{
  TransactionManager innerTxMgr=null;
  Collection temp=registryBroker.lookupObjects(TransactionManagerFactory.class);
  if (temp.size() > 1) {
    throw new MuleRuntimeException(CoreMessages.createStaticMessage("More than one TX manager has been configured - Only one TX manager can be defined per application. " + "Validate your app configuration or if your app belongs to a domain and the domains defines a TX manager then you should use that one."));
  }
  if (temp.size() > 0) {
    try {
      innerTxMgr=(((TransactionManagerFactory)temp.iterator().next()).create(config));
      registryBroker.registerObject(MuleProperties.OBJECT_TRANSACTION_MANAGER,innerTxMgr);
    }
 catch (    Exception e) {
      throw new MuleRuntimeException(CoreMessages.failedToCreate("transaction manager"),e);
    }
  }
 else {
    temp=registryBroker.lookupObjects(TransactionManager.class);
    if (temp.size() > 0) {
      innerTxMgr=(((TransactionManager)temp.iterator().next()));
    }
  }
  transactionManager=innerTxMgr;
}
