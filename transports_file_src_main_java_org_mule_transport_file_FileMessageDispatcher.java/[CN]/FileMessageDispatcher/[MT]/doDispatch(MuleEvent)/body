{
  Object data=event.transformMessage();
  MuleMessage message=new DefaultMuleMessage(data,event.getMessage(),event.getMuleContext());
  FileOutputStream fos=(FileOutputStream)connector.getOutputStream(event.getEndpoint(),message);
  try {
    if (event.getMessage().getStringProperty(FileConnector.PROPERTY_FILENAME,null) == null) {
      event.getMessage().setStringProperty(FileConnector.PROPERTY_FILENAME,message.getStringProperty(FileConnector.PROPERTY_FILENAME,""));
    }
    if (data instanceof byte[]) {
      fos.write((byte[])data);
    }
 else     if (data instanceof String) {
      fos.write(data.toString().getBytes(event.getEncoding()));
    }
 else     if (data instanceof OutputHandler) {
      ((OutputHandler)data).write(event,fos);
    }
 else {
      InputStream is=(InputStream)event.transformMessage(InputStream.class);
      IOUtils.copyLarge(is,fos);
      is.close();
    }
  }
  finally {
    logger.debug("Closing file");
    fos.close();
  }
}
