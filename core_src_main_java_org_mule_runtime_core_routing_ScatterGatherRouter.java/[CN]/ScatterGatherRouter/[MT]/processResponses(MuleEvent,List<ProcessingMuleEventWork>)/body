{
  List<MuleEvent> responses=new ArrayList<>(works.size());
  long remainingTimeout=timeout;
  for (int routeIndex=0; routeIndex < works.size(); routeIndex++) {
    MuleEvent response=null;
    Exception exception=null;
    ProcessingMuleEventWork work=works.get(routeIndex);
    MessageProcessor route=routes.get(routeIndex);
    long startedAt=System.currentTimeMillis();
    try {
      response=work.getResult(remainingTimeout,TimeUnit.MILLISECONDS);
    }
 catch (    ResponseTimeoutException e) {
      exception=e;
    }
catch (    InterruptedException e) {
      throw new DefaultMuleException(MessageFactory.createStaticMessage(String.format("Was interrupted while waiting for route %d",routeIndex)),e);
    }
catch (    MessagingException e) {
      exception=wrapInDispatchException(e.getEvent(),routeIndex,route,e);
    }
catch (    Exception e) {
      exception=wrapInDispatchException(event,routeIndex,route,e);
    }
    remainingTimeout-=System.currentTimeMillis() - startedAt;
    if (exception != null) {
      if (logger.isDebugEnabled()) {
        logger.debug(String.format("route %d generated exception for MuleEvent %s",routeIndex,event.getId()),exception);
      }
      if (exception instanceof MessagingException) {
        MuleEvent event1=((MessagingException)exception).getEvent();
        response=MuleEvent.builder(event1).session(new DefaultMuleSession(event1.getSession())).build();
      }
 else {
        response=MuleEvent.builder(event).session(new DefaultMuleSession(event.getSession())).build();
      }
      if (response.getError() == null) {
        event=MuleEvent.builder(event).error(response.getError()).build();
      }
    }
 else {
      if (logger.isDebugEnabled()) {
        logger.debug(String.format("route %d executed successfully for event %s",routeIndex,event.getId()));
      }
    }
    responses.add(response);
  }
  return aggregationStrategy.aggregate(new AggregationContext(event,responses));
}
