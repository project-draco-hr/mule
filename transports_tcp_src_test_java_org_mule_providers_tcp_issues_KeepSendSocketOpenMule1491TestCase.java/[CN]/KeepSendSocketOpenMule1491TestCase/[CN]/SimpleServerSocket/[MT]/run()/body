{
  try {
    LengthProtocol protocol=new LengthProtocol();
    while (true) {
      Socket socket=server.accept();
      logger.debug("have connection " + count);
      count.incrementAndGet();
      try {
        while (true) {
          String msg=new String((byte[])protocol.read(new BufferedInputStream(socket.getInputStream())));
          logger.debug("read: " + msg);
          logger.debug("writing reply");
          protocol.write(socket.getOutputStream(),"ok");
        }
      }
 catch (      Exception e) {
        logger.debug(e);
      }
    }
  }
 catch (  Exception e) {
    if (running.get()) {
      throw new RuntimeException(e);
    }
  }
}
