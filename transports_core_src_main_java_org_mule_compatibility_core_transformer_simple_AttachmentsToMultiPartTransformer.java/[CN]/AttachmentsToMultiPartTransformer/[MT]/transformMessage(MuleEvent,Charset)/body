{
  final MuleMessage message=event.getMessage();
  try {
    final Builder builder=MuleMessage.builder(message);
    List<org.mule.runtime.api.message.MuleMessage> parts=new ArrayList<>();
    if (message.getPayload() != null) {
      parts.add(MuleMessage.builder().payload(message.getPayload()).attributes(BODY_ATTRIBUTES).build());
    }
    for (    String attachmentName : message.getInboundAttachmentNames()) {
      DataHandler attachment=message.getInboundAttachment(attachmentName);
      parts.add(MuleMessage.builder().payload(attachment.getInputStream()).mediaType(MediaType.parse(attachment.getContentType())).attributes(new PartAttributes(attachmentName)).build());
    }
    event.setMessage(builder.payload(new DefaultMultiPartPayload(parts)).build());
  }
 catch (  Exception e) {
    throw new TransformerException(this,e);
  }
  return event.getMessage();
}
