{
  String parentMessageProp=rootMessageVariableName != null ? rootMessageVariableName : ROOT_MESSAGE_PROPERTY;
  Object previousCounterVar=null;
  Object previousRootMessageVar=null;
  if (event.getFlowVariableNames().contains(counterVariableName)) {
    previousCounterVar=event.getFlowVariable(counterVariableName);
  }
  if (event.getFlowVariableNames().contains(parentMessageProp)) {
    previousRootMessageVar=event.getFlowVariable(parentMessageProp);
  }
  MuleMessage message=event.getMessage();
  boolean transformed=false;
  if (xpathCollection) {
    transformed=transformPayloadIfNeeded(message);
  }
  message.setInvocationProperty(parentMessageProp,message);
  try {
    ownedMessageProcessor.process(event);
  }
 catch (  MessagingException e) {
    if (splitter.equals(e.getFailingMessageProcessor()) || filter.equals(e.getFailingMessageProcessor())) {
      e.getInfo().remove(INFO_LOCATION_KEY);
      throw new MessagingException(event,e,this);
    }
  }
  if (transformed) {
    transformBack(message);
  }
  if (previousCounterVar != null) {
    event.setFlowVariable(counterVariableName,previousCounterVar);
  }
 else {
    event.removeFlowVariable(counterVariableName);
  }
  if (previousRootMessageVar != null) {
    event.setFlowVariable(parentMessageProp,previousRootMessageVar);
  }
 else {
    event.removeFlowVariable(parentMessageProp);
  }
  return event;
}
