{
  Exception lastExecutionException=null;
  Event retryEvent=copyEventForRetry(event);
  try {
    for (int i=0; i <= getUntilSuccessfulConfiguration().getMaxRetries(); i++) {
      try {
        Event successEvent=processResponseThroughAckResponseExpression(processEvent(retryEvent));
        if (successEvent == null) {
          return null;
        }
        Event finalEvent;
        Builder builder=Event.builder(event).message(successEvent.getMessage());
        for (        String flowVar : successEvent.getVariableNames()) {
          builder.addVariable(flowVar,successEvent.getVariable(flowVar).getValue());
        }
        finalEvent=builder.build();
        setCurrentEvent(finalEvent);
        return finalEvent;
      }
 catch (      Exception e) {
        logger.info("Exception thrown inside until-successful " + e.getMessage());
        if (logger.isDebugEnabled()) {
          logger.debug("Exception thrown inside until-successful ",e);
        }
        lastExecutionException=e;
        if (i < getUntilSuccessfulConfiguration().getMaxRetries()) {
          Thread.sleep(getUntilSuccessfulConfiguration().getMillisBetweenRetries());
          retryEvent=copyEventForRetry(event);
        }
      }
    }
    throw new RoutingException(getUntilSuccessfulConfiguration().getRouter(),lastExecutionException);
  }
 catch (  Exception e) {
    throw new RoutingException(getUntilSuccessfulConfiguration().getRouter(),e);
  }
}
