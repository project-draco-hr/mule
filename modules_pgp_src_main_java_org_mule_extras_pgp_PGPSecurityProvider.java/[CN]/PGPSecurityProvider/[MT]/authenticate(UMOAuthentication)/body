{
  PGPAuthentication auth=(PGPAuthentication)authentication;
  String userId=(String)auth.getPrincipal();
  if (userId == null) {
    throw new UnauthorisedException(CoreMessages.objectIsNull("UserId"));
  }
  KeyBundle userKeyBundle=keyManager.getKeyBundle(userId);
  if (userKeyBundle == null) {
    throw new UnauthorisedException(PGPMessages.noPublicKeyForUser(userId));
  }
  Message msg=(Message)auth.getCredentials();
  if (!((msg != null) && msg instanceof SignedMessage)) {
    throw new UnauthorisedException(PGPMessages.noSignedMessageFound());
  }
  try {
    if (!((SignedMessage)msg).verify(userKeyBundle)) {
      throw new UnauthorisedException(PGPMessages.invalidSignature());
    }
  }
 catch (  MessageException e) {
    throw new UnauthorisedException(PGPMessages.errorVerifySignature(),e);
  }
  auth.setAuthenticated(true);
  auth.setDetails(userKeyBundle);
  return auth;
}
