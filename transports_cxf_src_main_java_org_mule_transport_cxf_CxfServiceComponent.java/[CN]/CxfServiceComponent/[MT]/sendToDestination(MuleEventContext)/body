{
  try {
    final MessageImpl m=new MessageImpl();
    final MuleMessage muleReqMsg=ctx.getMessage();
    String method=(String)muleReqMsg.getProperty(HttpConnector.HTTP_METHOD_PROPERTY);
    String ct=(String)muleReqMsg.getProperty(HttpConstants.HEADER_CONTENT_TYPE);
    if (ct != null) {
      m.put(Message.CONTENT_TYPE,ct);
    }
    String path=(String)muleReqMsg.getProperty(HttpConnector.HTTP_REQUEST_PROPERTY);
    if (path == null) {
      path="";
    }
    if (method != null) {
      m.put(Message.HTTP_REQUEST_METHOD,method);
      m.put(Message.PATH_INFO,path);
      m.put(Message.BASE_PATH,ctx.getEndpointURI().getPath());
      method=method.toUpperCase();
    }
    if (!"GET".equals(method)) {
      Object payload=ctx.transformMessage();
      setPayload(ctx,m,payload);
    }
    String soapAction=getSoapAction(ctx.getMessage());
    m.put(org.mule.transport.soap.SoapConstants.SOAP_ACTION_PROPERTY_CAPS,soapAction);
    Server server=receiver.getServer();
    org.apache.cxf.transport.Destination d=server.getDestination();
    m.put(LocalConduit.DIRECT_DISPATCH,Boolean.TRUE);
    m.put(MuleProperties.MULE_EVENT_PROPERTY,RequestContext.getEvent());
    m.setDestination(d);
    OutputHandler outputHandler=new OutputHandler(){
      public void write(      MuleEvent event,      OutputStream out) throws IOException {
        Message outFaultMessage=m.getExchange().getOutFaultMessage();
        Message outMessage=m.getExchange().getOutMessage();
        Message contentMsg=null;
        if (outFaultMessage != null) {
          contentMsg=outFaultMessage;
        }
 else         if (outMessage != null) {
          contentMsg=outMessage;
        }
        if (contentMsg == null) {
          return;
        }
        DelegatingOutputStream delegate=(DelegatingOutputStream)contentMsg.getContent(OutputStream.class);
        out.write(((ByteArrayOutputStream)delegate.getOutputStream()).toByteArray());
        delegate.setOutputStream(out);
        contentMsg.getInterceptorChain().resume();
        out.flush();
      }
    }
;
    DefaultMuleMessage muleResMsg=new DefaultMuleMessage(outputHandler);
    ExchangeImpl exchange=new ExchangeImpl();
    exchange.setInMessage(m);
    m.put(CxfConstants.MULE_MESSAGE,muleReqMsg);
    exchange.put(CxfConstants.MULE_MESSAGE,muleResMsg);
    d.getMessageObserver().onMessage(m);
    Message faultMsg=m.getExchange().getOutFaultMessage();
    if (faultMsg != null) {
      Exception ex=faultMsg.getContent(Exception.class);
      if (ex != null) {
        ExceptionPayload exceptionPayload=new DefaultExceptionPayload(new Exception(""));
        ctx.getMessage().setExceptionPayload(exceptionPayload);
      }
    }
    return muleResMsg;
  }
 catch (  MuleException e) {
    logger.warn("Could not dispatch message to XFire!",e);
    throw e;
  }
}
