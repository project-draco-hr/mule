{
  List endpoints;
  String endpointName;
  String prop=expressionConfig.getFullExpression();
  if (!ExpressionEvaluatorManager.isValidExpression(prop)) {
    throw new CouldNotRouteOutboundMessageException(CoreMessages.expressionInvalidForProperty("expression",prop),message,null);
  }
  Object property=ExpressionEvaluatorManager.evaluate(prop,message);
  if (property == null) {
    throw new CouldNotRouteOutboundMessageException(CoreMessages.expressionResultWasNull(expressionConfig.getFullExpression()),message,null);
  }
  if (property instanceof String) {
    endpoints=new ArrayList(1);
    endpoints.add(property);
  }
 else   if (property instanceof List) {
    endpoints=(List)property;
  }
 else {
    throw new CouldNotRouteOutboundMessageException(CoreMessages.propertyIsNotSupportedType(expressionConfig.getFullExpression(),new Class[]{String.class,List.class},property.getClass()),message,null);
  }
  MuleMessage result=null;
  List results=new ArrayList(endpoints.size());
  for (Iterator iterator=endpoints.iterator(); iterator.hasNext(); ) {
    endpointName=iterator.next().toString();
    if (StringUtils.isEmpty(endpointName)) {
      throw new CouldNotRouteOutboundMessageException(CoreMessages.objectIsNull("Endpoint Name: " + expressionConfig.getFullExpression()),message,null);
    }
    OutboundEndpoint ep=null;
    try {
      ep=lookupEndpoint(endpointName);
      if (ep == null) {
        throw new CouldNotRouteOutboundMessageException(CoreMessages.objectNotFound("Endpoint",endpointName),message,ep);
      }
      if (ep.isSynchronous()) {
        results.add(send(session,message,ep));
      }
 else {
        dispatch(session,message,ep);
      }
    }
 catch (    MuleException e) {
      throw new CouldNotRouteOutboundMessageException(message,ep,e);
    }
  }
  return resultsHandler.aggregateResults(results,message);
}
