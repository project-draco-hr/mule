{
  if (initialized.get()) {
    return LifecycleTransitionResult.OK;
  }
  if (mBeanServer == null && !locateServer && !createServer) {
    throw new InitialisationException(ManagementMessages.createOrLocateShouldBeSet(),this);
  }
  if (mBeanServer == null && locateServer) {
    List l=MBeanServerFactory.findMBeanServer(null);
    if (l != null && l.size() > 0) {
      mBeanServer=(MBeanServer)l.get(0);
    }
  }
  if (mBeanServer == null && createServer) {
    mBeanServer=MBeanServerFactory.createMBeanServer();
    serverCreated.set(true);
  }
  if (mBeanServer == null) {
    throw new InitialisationException(ManagementMessages.cannotLocateOrCreateServer(),this);
  }
  MuleContextNotificationListener l=new MuleContextNotificationListener(){
    public void onNotification(    ServerNotification notification){
      if (notification.getAction() == MuleContextNotification.CONTEXT_STARTED_MODELS) {
        try {
          registerWrapperService();
          registerStatisticsService();
          registerMuleService();
          registerConfigurationService();
          registerModelServices();
          registerServiceServices();
          registerEndpointServices();
          registerConnectorServices();
        }
 catch (        Exception e) {
          throw new MuleRuntimeException(CoreMessages.objectFailedToInitialise("MBeans"),e);
        }
      }
    }
  }
;
  if (StringUtils.isBlank(muleContext.getConfiguration().getId())) {
    throw new IllegalArgumentException("Manager ID is mandatory when running with JmxAgent. Give your Mule configuration a valid ID.");
  }
  try {
    muleContext.registerListener(l);
  }
 catch (  NotificationException e) {
    throw new InitialisationException(e,this);
  }
  initialized.compareAndSet(false,true);
  return LifecycleTransitionResult.OK;
}
