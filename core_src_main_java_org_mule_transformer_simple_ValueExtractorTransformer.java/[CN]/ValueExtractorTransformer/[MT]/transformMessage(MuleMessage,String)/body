{
  String valueToMatch=getValueToMatch(message);
  for (  ValueExtractorTemplate valueExtractorTemplate : valueExtractorTemplates) {
    Matcher matcher=valueExtractorTemplate.compiledPattern.matcher(valueToMatch);
    if (matcher.matches()) {
      if (matcher.groupCount() < 1) {
        throw new IllegalStateException("Matched regular expression does not contain the expected capture group");
      }
      muleContext.getExpressionManager().enrich(valueExtractorTemplate.getTarget(),message,matcher.group(1));
    }
 else     if (valueExtractorTemplate.failIfNoMatch) {
      throw new IllegalStateException(String.format("Source value '%s' does not math pattern '%s'",valueToMatch,valueExtractorTemplate.getPattern()));
    }
  }
  return message;
}
