{
  String valueToMatch=getValueToMatch(message);
  for (  ValueExtractorTemplate valueExtractorTemplate : valueExtractorTemplates) {
    Matcher matcher=valueExtractorTemplate.compiledPattern.matcher(valueToMatch);
    if (matcher.matches()) {
      if (matcher.groupCount() != 1) {
        throw new IllegalStateException("Matched regular expression must contain one capture group but contains " + matcher.groupCount());
      }
      muleContext.getExpressionManager().enrich(valueExtractorTemplate.getTarget(),message,matcher.group(1));
    }
 else {
      if (valueExtractorTemplate.failIfNoMatch) {
        throw new IllegalStateException(String.format("Source value '%s' does not math pattern '%s'",valueToMatch,valueExtractorTemplate.getPattern()));
      }
 else {
        if (valueExtractorTemplate.defaultValue != null) {
          muleContext.getExpressionManager().enrich(valueExtractorTemplate.getTarget(),message,valueExtractorTemplate.defaultValue);
        }
      }
    }
  }
  return message;
}
