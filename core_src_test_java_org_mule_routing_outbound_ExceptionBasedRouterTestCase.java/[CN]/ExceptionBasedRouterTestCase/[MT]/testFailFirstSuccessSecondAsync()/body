{
  Mock mockSession=MuleTestUtils.getMockSession();
  Endpoint endpoint1=getTestEndpoint("TestFailEndpoint",Endpoint.ENDPOINT_TYPE_SENDER);
  endpoint1.setEndpointURI(new MuleEndpointURI("test://Failure"));
  Endpoint endpoint2=getTestEndpoint("TestSuccessEndpoint",Endpoint.ENDPOINT_TYPE_SENDER);
  endpoint2.setEndpointURI(new MuleEndpointURI("test://Success"));
  ExceptionBasedRouter router=new ExceptionBasedRouter();
  router.addEndpoint(endpoint1);
  router.addEndpoint(endpoint2);
  MuleMessage message=new DefaultMuleMessage("test event");
  MuleMessage expectedResultMessage=new DefaultMuleMessage("Return event");
  assertTrue(router.isMatch(message));
  final MuleSession session=(MuleSession)mockSession.proxy();
  MuleException rex=new RoutingException(message,endpoint1);
  mockSession.expectAndThrow("sendEvent",C.args(C.eq(message),C.eq(endpoint1)),rex);
  mockSession.expectAndReturn("dispatchEvent",C.args(C.eq(message),C.eq(endpoint2)),expectedResultMessage);
  MuleMessage actualResultMessage=router.route(message,session,false);
  assertNull("Async call should not return any results.",actualResultMessage);
  mockSession.verify();
}
