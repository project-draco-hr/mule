{
  int numberOfBatches=0;
  boolean ok=false;
  while (!ok && numberOfBatches < MAX_NUMBER_OF_BATCHES) {
    numberOfBatches=0 == numberOfBatches ? 1 : numberOfBatches * 2;
    ok=doTestSome(TOTAL_MESSAGE_COUNT,TOTAL_MESSAGE_COUNT / numberOfBatches);
    if (!ok) {
      logger.warn("UDP failed to send " + TOTAL_MESSAGE_COUNT + " messages in "+ numberOfBatches+ " batches");
      try {
synchronized (this) {
          this.wait(BETWEEN_BATCH_PAUSE);
        }
      }
 catch (      InterruptedException e) {
      }
      MuleClient client=muleContext.getClient();
      int dropped=0;
      while (null != client.request("vm://foo",MAX_PAUSE_PERIOD)) {
        dropped++;
      }
      logger.info("Cleaned out " + dropped + " messages");
    }
  }
  if (!ok) {
    fail("Couldn't get UDP to 100% with a batch size of " + TOTAL_MESSAGE_COUNT / numberOfBatches);
  }
 else {
    logger.info("Required " + numberOfBatches + " batches before UDP 100% OK ("+ TOTAL_MESSAGE_COUNT+ " messages)");
  }
}
