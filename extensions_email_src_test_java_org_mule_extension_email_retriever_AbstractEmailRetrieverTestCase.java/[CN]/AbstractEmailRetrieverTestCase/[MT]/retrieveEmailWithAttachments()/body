{
  server.purgeEmailFromAllMailboxes();
  user.deliver(getMultipartTestMessage());
  List<OperationResult> messages=runFlowAndGetMessages(RETRIEVE_WITH_ATTACHMENTS);
  assertThat(messages,hasSize(1));
  assertThat(messages.get(0).getOutput(),instanceOf(MultiPartPayload.class));
  List<Message> emailAttachments=((MultiPartPayload)messages.get(0).getOutput()).getParts();
  assertThat(emailAttachments,hasSize(3));
  assertThat(((DefaultMultiPartPayload)messages.get(0).getOutput()).hasBodyPart(),is(true));
  assertThat(((MultiPartPayload)messages.get(0).getOutput()).getPartNames(),hasItems(EMAIL_JSON_ATTACHMENT_NAME,EMAIL_TEXT_PLAIN_ATTACHMENT_NAME));
  assertAttachmentContent(emailAttachments,EMAIL_JSON_ATTACHMENT_NAME,EMAIL_JSON_ATTACHMENT_CONTENT);
  assertAttachmentContent(emailAttachments,EMAIL_TEXT_PLAIN_ATTACHMENT_NAME,EMAIL_TEXT_PLAIN_ATTACHMENT_CONTENT);
}
