{
  server.purgeEmailFromAllMailboxes();
  user.deliver(getMultipartTestMessage());
  ConsumerIterator<Result> messages=runFlowAndGetMessages(RETRIEVE_WITH_ATTACHMENTS);
  Result message=messages.next();
  assertThat(messages.hasNext(),is(false));
  assertThat(message.getOutput(),instanceOf(MultiPartPayload.class));
  List<Message> emailAttachments=((MultiPartPayload)message.getOutput()).getParts();
  assertThat(emailAttachments,hasSize(3));
  assertThat(((DefaultMultiPartPayload)message.getOutput()).hasBodyPart(),is(true));
  assertThat(((MultiPartPayload)message.getOutput()).getPartNames(),hasItems(EMAIL_JSON_ATTACHMENT_NAME,EMAIL_TEXT_PLAIN_ATTACHMENT_NAME));
  assertAttachmentContent(emailAttachments,EMAIL_JSON_ATTACHMENT_NAME,EMAIL_JSON_ATTACHMENT_CONTENT.getBytes());
  assertAttachmentContent(emailAttachments,EMAIL_TEXT_PLAIN_ATTACHMENT_NAME,EMAIL_TEXT_PLAIN_ATTACHMENT_CONTENT.getBytes());
}
