{
  if (!(service.getMessageSource() instanceof ServiceCompositeMessageSource)) {
    throw new IllegalStateException("Only 'CompositeMessageSource' is supported with MuleClient.sendDirect() and MuleClient.dispatchDirect()");
  }
  InboundEndpoint endpoint=((ServiceCompositeMessageSource)service.getMessageSource()).getEndpoints().get(0);
  if (endpoint != null) {
    List<Transformer> transformers=endpoint.getTransformers();
    if (transformers != null && !transformers.isEmpty()) {
      if (TransformerUtils.isSourceTypeSupportedByFirst(transformers,payload.getClass())) {
        return endpoint;
      }
 else {
        EndpointBuilder builder=new EndpointURIEndpointBuilder(endpoint);
        builder.setTransformers(new LinkedList());
        builder.setExchangePattern(MessageExchangePattern.REQUEST_RESPONSE);
        return muleContext.getEndpointFactory().getInboundEndpoint(builder);
      }
    }
 else {
      return endpoint;
    }
  }
 else {
    EndpointBuilder builder=new EndpointURIEndpointBuilder("vm://mule.client",muleContext);
    builder.setName("muleClientProvider");
    endpoint=muleContext.getEndpointFactory().getInboundEndpoint(builder);
  }
  return endpoint;
}
