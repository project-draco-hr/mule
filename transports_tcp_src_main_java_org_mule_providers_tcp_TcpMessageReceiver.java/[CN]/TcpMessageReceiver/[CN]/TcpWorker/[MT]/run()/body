{
  try {
    dataIn=new DataInputStream(new BufferedInputStream(socket.getInputStream()));
    dataOut=new DataOutputStream(new BufferedOutputStream(socket.getOutputStream()));
    while (!socket.isClosed() && !disposing.get()) {
      byte[] b;
      try {
        b=protocol.read(dataIn);
        if (b == null) {
          break;
        }
        byte[] result=processData(b);
        if (result != null) {
          protocol.write(dataOut,result);
        }
        dataOut.flush();
      }
 catch (      SocketTimeoutException e) {
        if (!socket.getKeepAlive()) {
          break;
        }
      }
    }
  }
 catch (  Exception e) {
    handleException(e);
  }
 finally {
    dispose();
  }
}
