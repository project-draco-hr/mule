{
  try {
    dataIn=new DataInputStream(new BufferedInputStream(socket.getInputStream()));
    dataOut=new DataOutputStream(new BufferedOutputStream(socket.getOutputStream()));
    while (!socket.isClosed() && !disposing.get()) {
      try {
        if (endpoint.isStreaming()) {
          UMOMessageAdapter adapter=connector.getStreamMessageAdapter(dataIn,dataOut);
          routeMessage(new MuleMessage(adapter),endpoint.isSynchronous(),null);
        }
 else {
          Serializable readMsg=protocol.read(dataIn);
          if (readMsg == null) {
            break;
          }
          Serializable result=processData(readMsg);
          if (result != null) {
            protocol.write(dataOut,result);
          }
          dataOut.flush();
        }
      }
 catch (      SocketTimeoutException e) {
        if (!socket.getKeepAlive()) {
          break;
        }
      }
    }
  }
 catch (  Exception e) {
    handleException(e);
  }
 finally {
    dispose();
  }
}
