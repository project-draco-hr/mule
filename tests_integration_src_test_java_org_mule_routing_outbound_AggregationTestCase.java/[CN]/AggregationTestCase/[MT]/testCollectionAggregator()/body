{
  MuleClient client=muleContext.getClient();
  String payload="Long string that wil be broken uop into multiple messages";
  client.dispatch("vm://in",payload,null);
  MuleMessage msg=client.request("vm://collectionCreated",5000);
  assertNotNull(msg);
  assertTrue(msg instanceof MuleMessageCollection);
  MuleMessageCollection collection=(MuleMessageCollection)msg;
  @SuppressWarnings("unchecked") List<byte[]> chunks=(List<byte[]>)collection.getPayload();
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  for (  byte[] chunk : chunks) {
    baos.write(chunk);
  }
  String aggregated=baos.toString();
  assertEquals(payload,aggregated);
}
