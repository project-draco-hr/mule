{
  try {
    MessageContext context=new MessageContext();
    XFire xfire=(XFire)ctx.getComponent().getProperties().get(XFireConnector.XFIRE_PROPERTY);
    context.setService(xfire.getServiceRegistry().getService(getService(ctx)));
    context.setXFire(xfire);
    ByteArrayOutputStream resultStream=new ByteArrayOutputStream();
    context.setProperty(Channel.BACKCHANNEL_URI,resultStream);
    XMLStreamReader reader;
    Object payload=ctx.transformMessage();
    if (payload instanceof InputStream) {
      reader=STAXUtils.createXMLStreamReader((InputStream)payload,ctx.getEncoding(),context);
    }
 else     if (payload instanceof Reader) {
      reader=STAXUtils.createXMLStreamReader((Reader)payload,context);
    }
 else {
      InputStream i=(InputStream)ctx.transformMessage(InputStream.class);
      reader=STAXUtils.createXMLStreamReader(i,ctx.getEncoding(),context);
    }
    InMessage in=new InMessage(reader,getUri());
    String soapAction=getSoapAction(ctx.getMessage());
    in.setProperty(SoapConstants.SOAP_ACTION,soapAction);
    try {
      receive(context,in);
      Object result=null;
      AbstractMessage fault=context.getExchange().getFaultMessage();
      if (fault != null && fault.getBody() != null) {
        result=resultStream.toString(fault.getEncoding());
        ExceptionPayload exceptionPayload=new ExceptionPayload(new Exception(result.toString()));
        ctx.getMessage().setExceptionPayload(exceptionPayload);
      }
 else       if (context.getExchange().hasOutMessage()) {
        result=resultStream.toString(context.getExchange().getOutMessage().getEncoding());
      }
      return result;
    }
 catch (    UnsupportedEncodingException e1) {
      throw new MuleException(e1);
    }
 finally {
      if (reader != null) {
        try {
          reader.close();
        }
 catch (        XMLStreamException e) {
          logger.warn("Could not close XMLStreamReader.",e);
        }
      }
    }
  }
 catch (  UMOException e) {
    logger.warn("Could not dispatch message to XFire!",e);
    throw e;
  }
}
