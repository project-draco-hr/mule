{
  Map<String,Fruit> map=new HashMap<String,Fruit>();
  final Apple apple=new Apple();
  final Banana banana=new Banana();
  final Orange orange=new Orange();
  map.put("apple",apple);
  map.put("banana",banana);
  map.put("orange",orange);
  MuleEvent result=flowRunner("split-aggregate-map").withPayload(map).run();
  assertNotNull(result);
  assertTrue(result.getMessage().getPayload() instanceof List);
  final MuleMessage[] results=new MuleMessage[3];
  ((List<MuleMessage>)result.getMessage().getPayload()).toArray(results);
  assertEquals(3,results.length);
  assertTrue(apple.isBitten());
  assertTrue(banana.isBitten());
  assertTrue(orange.isBitten());
  assertNotNull(results[0].getProperty("key",PropertyScope.INVOCATION));
  assertNotNull(results[1].getProperty("key",PropertyScope.INVOCATION));
  assertNotNull(results[2].getProperty("key",PropertyScope.INVOCATION));
}
