{
  final Builder builder=MuleMessage.builder(event.getMessage());
  if (dataType == null) {
    final TypedValue typedValue=resolveTypedValue(event);
    if (typedValue.getDataType().getMediaType().getCharset().isPresent()) {
      builder.payload(typedValue.getValue() != null ? typedValue.getValue() : NullPayload.getInstance()).mediaType(typedValue.getDataType().getMediaType());
    }
 else {
      builder.payload(typedValue.getValue() != null ? typedValue.getValue() : NullPayload.getInstance()).mediaType(DataType.builder(typedValue.getDataType()).charset(getDefaultEncoding(muleContext)).build().getMediaType());
    }
  }
 else {
    Object value=resolveValue(event);
    final DataTypeParamsBuilder dataTypeBuilder=DataType.builder(dataType).type((value == null || value instanceof NullPayload) ? Object.class : value.getClass());
    if (dataType.getMediaType().getCharset().isPresent()) {
      builder.payload(value != null ? value : NullPayload.getInstance()).mediaType(dataTypeBuilder.build().getMediaType());
    }
 else {
      builder.payload(value != null ? value : NullPayload.getInstance()).mediaType(dataTypeBuilder.charset(getDefaultEncoding(muleContext)).build().getMediaType());
    }
  }
  event.setMessage(builder.build());
  return event;
}
