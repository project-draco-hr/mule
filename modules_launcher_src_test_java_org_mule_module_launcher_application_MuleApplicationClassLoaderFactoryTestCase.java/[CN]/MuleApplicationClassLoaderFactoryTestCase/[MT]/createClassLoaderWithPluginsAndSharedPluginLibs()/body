{
  final DomainClassLoaderRepository domainClassLoaderRepository=mock(DomainClassLoaderRepository.class);
  when(domainClassLoaderRepository.getDomainClassLoader(DOMAIN_NAME)).thenReturn(domainCL);
  final NativeLibraryFinderFactory nativeLibraryFinderFactory=mock(NativeLibraryFinderFactory.class);
  MuleApplicationClassLoaderFactory classLoaderFactory=new MuleApplicationClassLoaderFactory(domainClassLoaderRepository,nativeLibraryFinderFactory);
  final PackageDiscoverer packageDiscoverer=mock(PackageDiscoverer.class);
  final Set<String> packages=new HashSet<>();
  packages.add("org.foo");
  when(packageDiscoverer.findPackages(any())).thenReturn(packages);
  classLoaderFactory.setPackageDiscoverer(packageDiscoverer);
  final ClassLoaderLookupPolicy sharedLibLookupPolicy=mock(ClassLoaderLookupPolicy.class);
  when(domainLookupPolicy.extend(anyMap())).thenReturn(sharedLibLookupPolicy);
  final ClassLoaderLookupPolicy pluginLookupPolicy=mock(ClassLoaderLookupPolicy.class);
  when(sharedLibLookupPolicy.extend(anyMap())).thenReturn(pluginLookupPolicy);
  final ApplicationDescriptor descriptor=new ApplicationDescriptor();
  descriptor.setName(APP_NAME);
  descriptor.setDomain(DOMAIN_NAME);
  final Set<ApplicationPluginDescriptor> plugins=new HashSet<>();
  final ApplicationPluginDescriptor pluginDescriptor=new ApplicationPluginDescriptor();
  pluginDescriptor.setName("plugin1");
  plugins.add(pluginDescriptor);
  descriptor.setPlugins(plugins);
  descriptor.setSharedPluginLibs(new URL[]{jarFile.toURI().toURL()});
  final MuleApplicationClassLoader artifactClassLoader=(MuleApplicationClassLoader)classLoaderFactory.create(descriptor);
  assertThat(artifactClassLoader.getURLs(),is(equalTo(artifactClassLoader.getURLs())));
  assertThat(artifactClassLoader.getParent(),is(instanceOf(CompositeClassLoader.class)));
  assertThat(artifactClassLoader.getParent().getParent(),is(instanceOf(FineGrainedControlClassLoader.class)));
  assertThat(((FineGrainedControlClassLoader)artifactClassLoader.getParent().getParent()).getClassLoaderLookupPolicy(),is(sharedLibLookupPolicy));
  assertThat(artifactClassLoader.getParent().getParent().getParent(),is(domainCL));
}
