{
  if (transactionConfig.getAction() == ACTION_NOT_SUPPORTED) {
    return getTransactionlessConnectionHandler(operationContext);
  }
  final ExtensionTransactionKey txKey=new ExtensionTransactionKey(operationContext.getConfiguration());
  final Transaction currentTx=TransactionCoordination.getInstance().getTransaction();
  if (currentTx != null) {
    if (currentTx.hasResource(txKey)) {
      return new TransactionalConnectionHandler((ExtensionTransactionalResource)currentTx.getResource(txKey));
    }
    ConnectionHandler<T> connectionHandler=getTransactionlessConnectionHandler(operationContext);
    T connection=connectionHandler.getConnection();
    ExtensionTransactionalResource<T> txResource=new ExtensionTransactionalResource<>(connection,connectionHandler,currentTx);
    boolean bound=false;
    try {
      if (currentTx.supports(txKey,txResource)) {
        currentTx.bindResource(txKey,txResource);
        bound=true;
        return new TransactionalConnectionHandler(txResource);
      }
 else       if (transactionConfig.isTransacted()) {
        throw new TransactionException(createStaticMessage(format("Operation '%s' of extension '%s' is transactional but current transaction doesn't " + "support connections of type '%s'",operationContext.getOperationModel().getName(),operationContext.getConfiguration().getModel().getExtensionModel().getName(),connectionHandler.getClass().getName())));
      }
    }
  finally {
      if (!bound) {
        connectionHandler.release();
      }
    }
  }
  return getTransactionlessConnectionHandler(operationContext);
}
