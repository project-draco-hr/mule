{
  targetMessageProcessor.setNumberOfFailuresToSimulate(Integer.MAX_VALUE);
  EndpointBuilder dlqEndpointBuilder=mock(EndpointBuilder.class);
  OutboundEndpoint dlqEndpoint=mock(OutboundEndpoint.class);
  when(dlqEndpointBuilder.buildOutboundEndpoint()).thenReturn(dlqEndpoint);
  untilSuccessful.setDlqEndpoint(dlqEndpointBuilder);
  untilSuccessful.initialise();
  untilSuccessful.start();
  final MuleEvent testEvent=getTestEvent("ERROR");
  assertNull(untilSuccessful.process(testEvent));
  ponderUntilEventAborted(testEvent);
  verify(dlqEndpoint).process(any(MuleEvent.class));
}
