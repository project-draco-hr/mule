{
  if (logger.isDebugEnabled()) {
    logger.debug("Update OAuth Context for resourceOwnerId %s",stateForUser.getResourceOwnerId());
  }
  final TokenResponseProcessor tokenResponseProcessor=TokenResponseProcessor.createAuthorizationCodeProcessor(tokenResponseConfiguration,getMuleContext().getExpressionManager());
  tokenResponseProcessor.process(tokenUrlResponse);
  stateForUser.setAccessToken(tokenResponseProcessor.getAccessToken());
  stateForUser.setRefreshToken(tokenResponseProcessor.getRefreshToken());
  stateForUser.setExpiresIn(tokenResponseProcessor.getExpiresIn());
  if (decodedState != null) {
    stateForUser.setState(decodedState);
  }
  for (  NameValuePair parameter : tokenResponseProcessor.getCustomResponseParameters()) {
    if (parameter.getValue() != null) {
      stateForUser.getTokenResponseParameters().put(parameter.getName(),parameter.getValue());
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debug("New OAuth State for resourceOwnerId %s is: accessToken(%s), refreshToken(%s), expiresIn(%s), state(%s)",stateForUser.getResourceOwnerId(),stateForUser.getAccessToken(),stateForUser.getRefreshToken(),stateForUser.getExpiresIn(),stateForUser.getState());
  }
}
