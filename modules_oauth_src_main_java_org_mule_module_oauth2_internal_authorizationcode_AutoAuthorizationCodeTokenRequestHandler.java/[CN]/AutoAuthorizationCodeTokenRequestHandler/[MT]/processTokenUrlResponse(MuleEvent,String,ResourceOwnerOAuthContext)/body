{
  if (logger.isDebugEnabled()) {
    logger.debug("Update OAuth Context for resourceOwnerId %s",stateForUser.getResourceOwnerId());
  }
  final TokenResponseProcessor tokenResponseProcessor=TokenResponseProcessor.createAuthorizationCodeProcessor(tokenResponseConfiguration,getMuleContext().getExpressionManager());
  tokenResponseProcessor.process(tokenUrlResponse);
  stateForUser.setAccessToken(tokenResponseProcessor.getAccessToken());
  stateForUser.setRefreshToken(tokenResponseProcessor.getRefreshToken());
  stateForUser.setExpiresIn(tokenResponseProcessor.getExpiresIn());
  if (decodedState != null) {
    stateForUser.setState(decodedState);
  }
  final Map<String,Object> customResponseParameters=tokenResponseProcessor.getCustomResponseParameters();
  for (  String paramName : customResponseParameters.keySet()) {
    final Object paramValue=customResponseParameters.get(paramName);
    if (paramValue != null) {
      stateForUser.getTokenResponseParameters().put(paramName,paramValue);
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debug("New OAuth State for resourceOwnerId %s is: accessToken(%s), refreshToken(%s), expiresIn(%s), state(%s)",stateForUser.getResourceOwnerId(),stateForUser.getAccessToken(),stateForUser.getRefreshToken(),stateForUser.getExpiresIn(),stateForUser.getState());
  }
}
