{
  Session session=null;
  try {
    Message result;
    if (src instanceof Message) {
      result=(Message)src;
      result.clearProperties();
    }
 else {
      session=this.getSession();
      result=JmsMessageUtils.toMessage(src,session);
    }
    UMOEventContext ctx=RequestContext.getEventContext();
    if (ctx == null) {
      logger.warn("There is no current event context");
      return result;
    }
    this.setJmsProperties(ctx.getMessage(),result);
    return result;
  }
 catch (  TransformerException tex) {
    throw tex;
  }
catch (  Exception e) {
    throw new TransformerException(this,e);
  }
 finally {
    if (session != null && endpoint != null) {
      UMOTransaction muleTx=TransactionCoordination.getInstance().getTransaction();
      final JmsConnector connector=(JmsConnector)endpoint.getConnector();
      if (muleTx == null) {
        if (logger.isDebugEnabled()) {
          logger.debug("Closing non-transacted jms session: " + session);
        }
        connector.closeQuietly(session);
      }
 else       if (!muleTx.hasResource(connector.getConnection())) {
        if (logger.isDebugEnabled()) {
          logger.debug("Closing an orphaned, but transacted jms session: " + session + ", transaction: "+ muleTx);
        }
        connector.closeQuietly(session);
      }
    }
    session=null;
  }
}
