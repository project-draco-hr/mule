{
  List<MuleEvent> messageParts=new ArrayList<>();
  byte[] data;
  try {
    data=event.getMessageAsBytes();
  }
 catch (  Exception e) {
    throw new RoutingException(CoreMessages.failedToReadPayload(),event,next,e);
  }
  MuleMessage message=event.getMessage();
  int parts=data.length / messageSize;
  if ((parts * messageSize) < data.length) {
    parts++;
  }
  int len=messageSize;
  int count=0;
  int pos=0;
  byte[] buffer;
  for (; count < parts; count++) {
    if ((pos + len) > data.length) {
      len=data.length - pos;
    }
    buffer=new byte[len];
    System.arraycopy(data,pos,buffer,0,buffer.length);
    pos+=len;
    final DefaultMuleEvent childEvent=new DefaultMuleEvent(MuleMessage.builder(message).payload(buffer).build(),event);
    childEvent.setParent(event);
    childEvent.setCorrelation(new Correlation(event.getExecutionContext().getCorrelationId(),parts,count));
    messageParts.add(childEvent);
  }
  return messageParts;
}
