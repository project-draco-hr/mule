{
  logger.debug("Trying to receive a message with a timeout of " + timeout);
  String[] stmts=connector.getReadAndAckStatements(endpoint);
  String readStmt=stmts[0];
  String ackStmt=stmts[1];
  List<String> readParams=new ArrayList<String>();
  List<String> ackParams=new ArrayList<String>();
  readStmt=connector.parseStatement(readStmt,readParams);
  ackStmt=connector.parseStatement(ackStmt,ackParams);
  long t0=System.currentTimeMillis();
  if (timeout < 0) {
    timeout=Long.MAX_VALUE;
  }
  Object result;
  do {
    Object[] params=connector.getParams(endpoint,readParams,event != null ? event.getMessage() : null,endpoint.getEndpointURI().getAddress());
    if (logger.isDebugEnabled()) {
      logger.debug("SQL QUERY: " + readStmt + ", params = "+ ArrayUtils.toString(params));
    }
    result=connector.getQueryRunnerFor(endpoint).query(connection,readStmt,connector.getResultSetHandler(),params);
    if (result != null) {
      if (logger.isDebugEnabled()) {
        logger.debug("SQL query received a result: " + result);
      }
 else       if (logger.isInfoEnabled()) {
        logger.info("SQL query received a result");
      }
      break;
    }
    long sleep=Math.min(connector.getPollingFrequency(),timeout - (System.currentTimeMillis() - t0));
    if (sleep > 0) {
      if (logger.isDebugEnabled()) {
        logger.debug("No results, sleeping for " + sleep);
      }
      Thread.sleep(sleep);
    }
 else {
      logger.debug("Timeout");
      JdbcUtils.rollbackAndClose(connection);
      return null;
    }
  }
 while (true);
  if (ackStmt != null) {
    Object[] params=connector.getParams(endpoint,ackParams,new DefaultMuleMessage(result,(Map)null,endpoint.getMuleContext()),ackStmt);
    if (logger.isDebugEnabled()) {
      logger.debug("SQL UPDATE: " + ackStmt + ", params = "+ ArrayUtils.toString(params));
    }
    int nbRows=connector.getQueryRunnerFor(endpoint).update(connection,ackStmt,params);
    if (nbRows != 1) {
      logger.warn("Row count for ack should be 1 and not " + nbRows);
    }
  }
  MuleMessage message=null;
  if (event != null) {
    message=new DefaultMuleMessage(result,event.getMessage(),endpoint.getMuleContext());
  }
 else {
    message=new DefaultMuleMessage(result,endpoint.getMuleContext());
  }
  return message;
}
