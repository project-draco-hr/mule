{
  try {
    if (requireNewSession || getEndpoint() != null) {
      session=(Session)getEndpoint().getConnector().getDispatcher("transformerSession").getDelegateSession();
      requireNewSession=session == null;
    }
    Message msg=null;
    if (src instanceof Message) {
      msg=(Message)src;
      msg.clearProperties();
    }
 else {
      msg=JmsMessageUtils.getMessageForObject(src,session);
    }
    UMOEventContext ctx=RequestContext.getEventContext();
    if (ctx == null) {
      logger.warn("There is no current event context");
      return msg;
    }
    Map props=ctx.getProperties();
    props=PropertiesHelper.getPropertiesWithoutPrefix(props,"JMS");
    Map.Entry entry;
    String key;
    for (Iterator iterator=props.entrySet().iterator(); iterator.hasNext(); ) {
      entry=(Map.Entry)iterator.next();
      key=entry.getKey().toString();
      if (MuleProperties.MULE_CORRELATION_ID_PROPERTY.equals(key)) {
        msg.setJMSCorrelationID(entry.getValue().toString());
      }
      if (!(MuleProperties.MULE_REPLY_TO_PROPERTY.equals(key) && entry.getValue() instanceof Destination)) {
        try {
          msg.setObjectProperty(encodeHeader(key),entry.getValue());
        }
 catch (        JMSException e) {
          if (logger.isDebugEnabled())           logger.debug("Unable to set property '" + encodeHeader(key) + "' of type "+ entry.getValue().getClass().getName()+ "': "+ e.getMessage());
        }
      }
    }
    return msg;
  }
 catch (  Exception e) {
    throw new TransformerException(this,e);
  }
}
