{
  try {
    if (session == null || getEndpoint() != null) {
      session=(Session)getEndpoint().getConnector().getDispatcher("transformerSession").getDelegateSession();
    }
    Message msg=null;
    if (src instanceof Message) {
      msg=(Message)src;
      msg.clearProperties();
    }
 else {
      msg=JmsMessageUtils.getMessageForObject(src,session);
    }
    UMOEventContext ctx=RequestContext.getEventContext();
    if (ctx == null) {
      logger.warn("There is no current event context");
      return msg;
    }
    Map props=ctx.getProperties();
    props=PropertiesHelper.getPropertiesWithoutPrefix(props,"JMS");
    Map.Entry entry;
    String key;
    for (Iterator iterator=props.entrySet().iterator(); iterator.hasNext(); ) {
      entry=(Map.Entry)iterator.next();
      key=entry.getKey().toString();
      if (MuleProperties.MULE_CORRELATION_ID_PROPERTY.equals(key)) {
        msg.setJMSCorrelationID(entry.getValue().toString());
      }
      msg.setObjectProperty(key,entry.getValue());
    }
    return msg;
  }
 catch (  Exception e) {
    throw new TransformerException("Failed to transform message: " + e,e);
  }
}
