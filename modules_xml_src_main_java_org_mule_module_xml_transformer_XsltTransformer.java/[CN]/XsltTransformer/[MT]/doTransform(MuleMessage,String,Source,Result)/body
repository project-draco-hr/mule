{
  DefaultErrorListener errorListener=new DefaultErrorListener(this);
  javax.xml.transform.Transformer transformer=null;
  try {
    transformer=(javax.xml.transform.Transformer)transformerPool.borrowObject();
    transformer.setErrorListener(errorListener);
    transformer.setOutputProperty(OutputKeys.ENCODING,encoding);
    if (contextProperties != null) {
      for (Iterator i=contextProperties.entrySet().iterator(); i.hasNext(); ) {
        Map.Entry parameter=(Entry)i.next();
        String key=(String)parameter.getKey();
        transformer.setParameter(key,evaluateTransformParameter(key,parameter.getValue(),message));
      }
    }
    transformer.transform(sourceDoc,result);
    if (errorListener.isError()) {
      throw errorListener.getException();
    }
  }
  finally {
    if (transformer != null) {
      transformer.clearParameters();
      transformerPool.returnObject(transformer);
    }
  }
}
