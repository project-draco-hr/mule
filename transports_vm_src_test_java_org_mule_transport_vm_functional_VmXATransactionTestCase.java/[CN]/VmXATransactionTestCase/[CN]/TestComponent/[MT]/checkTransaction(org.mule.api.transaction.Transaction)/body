{
  if (!(transaction instanceof XaTransaction)) {
    return false;
  }
  Transaction tx=((XaTransaction)transaction).getTransaction();
  TestResource testResource=new TestResource();
  transaction.bindResource("TestReource",testResource);
  tx.enlistResource(testResource);
  Field field=transaction.getClass().getDeclaredField("resources");
  field.setAccessible(true);
  Map<?,?> resources=(Map<?,?>)field.get(transaction);
  if (resources == null) {
    return false;
  }
  logger.debug("Mule XATransaction :: registered " + resources.size());
  Iterator<?> i=resources.entrySet().iterator();
  boolean result=true;
  while (i.hasNext()) {
    Map.Entry<?,?> entry=(Map.Entry<?,?>)i.next();
    XAResource xaResource=getXAResource(entry.getValue());
    logger.debug("XAResource " + xaResource);
    boolean enlisted=isXAResourceEnlisted(tx,xaResource);
    result=result && enlisted;
    if (xaResource instanceof TestResource) {
      logger.debug("Check status for TestResource " + enlisted);
      if (!enlisted) {
        wouldBeDisabled=true;
        throw new IllegalStateException("Test is wrong, and must be disabled");
      }
    }
  }
  return result;
}
