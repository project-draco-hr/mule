{
  if (connector.getMaxRedelivery() <= 0) {
    return;
  }
  String id=message.getJMSMessageID();
  Integer i=(Integer)messages.remove(id);
  if (i == null) {
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + id + " has been redelivered for the first time");
    }
    messages.put(id,new Integer(1));
    return;
  }
 else   if (i.intValue() == connector.getMaxRedelivery()) {
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + id + " has been redelivered "+ (i.intValue() + 1)+ " times, which exceeds the maxRedelivery setting on the connector");
    }
    JmsMessageAdapter adapter=(JmsMessageAdapter)connector.getMessageAdapter(message);
    throw new MessageRedeliveredException(JmsMessages.tooManyRedeliveries(id,String.valueOf(i.intValue() + 1)),adapter);
  }
 else {
    messages.put(id,new Integer(i.intValue() + 1));
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + id + " has been redelivered "+ i.intValue()+ " times");
    }
  }
}
