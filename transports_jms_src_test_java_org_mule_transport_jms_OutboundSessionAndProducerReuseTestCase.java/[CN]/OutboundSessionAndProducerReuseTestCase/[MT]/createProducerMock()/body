{
  MessageProducer mock=mock(MessageProducer.class);
  doAnswer(new Answer<Object>(){
    @Override public Object answer(    InvocationOnMock invocation) throws Throwable {
      messageSentLatch.countDown();
      return null;
    }
  }
).when(mock).send(any(Message.class),anyInt(),anyInt(),anyLong());
  return mock;
}
