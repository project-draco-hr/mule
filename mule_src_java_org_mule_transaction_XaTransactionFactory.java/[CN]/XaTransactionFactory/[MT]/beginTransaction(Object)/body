{
  XaTransaction tx=null;
  if (session instanceof XAResource) {
    tx=getTransaction((XAResource)session);
  }
 else {
    Method method=ClassHelper.getMethod("getXAResource",session.getClass());
    if (method == null) {
      throw new IllegalTransactionStateException("Failed to obtain XA resource from session: " + session.getClass().getName());
    }
 else {
      Object resource=null;
      try {
        resource=method.invoke(session,(Object[])null);
      }
 catch (      Exception e) {
        throw new IllegalTransactionStateException("Could not obtain XAResource from session calling getXAResource: " + session.getClass().getName());
      }
      if (resource != null && resource instanceof XAResource) {
        tx=getTransaction((XAResource)resource);
      }
 else {
        throw new IllegalTransactionStateException("Could not obtain XAResource from session: " + session.getClass().getName());
      }
    }
  }
  tx.begin();
  return tx;
}
