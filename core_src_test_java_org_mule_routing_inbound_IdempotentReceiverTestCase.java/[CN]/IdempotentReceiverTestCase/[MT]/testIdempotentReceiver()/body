{
  IdempotentReceiver router=new IdempotentReceiver();
  Mock session=MuleTestUtils.getMockSession();
  Component testComponent=getTestComponent("test",Apple.class);
  InboundRouterCollection messageRouter=new DefaultInboundRouterCollection();
  messageRouter.addRouter(router);
  messageRouter.setCatchAllStrategy(new LoggingCatchAllStrategy());
  MuleMessage message=new DefaultMuleMessage("test event");
  Endpoint endpoint=getTestEndpoint("Test1Provider",Endpoint.ENDPOINT_TYPE_SENDER);
  MuleEvent event=new DefaultMuleEvent(message,endpoint,(MuleSession)session.proxy(),false);
  session.expectAndReturn("getComponent",testComponent);
  assertTrue(router.isMatch(event));
  session.expect("dispatchEvent",C.eq(event));
  session.expectAndReturn("getComponent",testComponent);
  session.expectAndReturn("getComponent",testComponent);
  messageRouter.route(event);
  session.verify();
  message=new DefaultMuleMessage("test event");
  event=new DefaultMuleEvent(message,endpoint,(MuleSession)session.proxy(),true);
  session.expectAndReturn("sendEvent",C.eq(event),message);
  session.expectAndReturn("getComponent",testComponent);
  session.expectAndReturn("getComponent",testComponent);
  MuleMessage result=messageRouter.route(event);
  assertNotNull(result);
  assertEquals(message,result);
  session.verify();
  session.expect("toString");
  session.expectAndReturn("getComponent",testComponent);
  event=new DefaultMuleEvent(message,endpoint,(MuleSession)session.proxy(),false);
  assertTrue(!router.isMatch(event));
  messageRouter.route(event);
  session.verify();
}
