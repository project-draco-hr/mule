{
  UMOExceptionStrategy es=new DefaultExceptionStrategy(){
    public Throwable handleException(    Object message,    Throwable t){
      if (t instanceof MessageRedeliveredException) {
        try {
          TextMessage msg=(TextMessage)message;
          assertNotNull(msg);
          assertTrue(msg.getJMSRedelivered());
          assertTrue(msg instanceof TextMessage);
          eventCount++;
          assertEquals(DEFAULT_MESSAGE + eventCount,msg.getText());
          if (eventCount == 2) {
synchronized (lock) {
              lock.notify();
            }
          }
        }
 catch (        Exception e) {
          fail(e.getMessage());
        }
 finally {
          try {
            ((MessageRedeliveredException)t).getSession().commit();
          }
 catch (          JMSException e) {
            fail("Failed to commit rolled back message");
          }
        }
        return null;
      }
 else {
        return super.handleException(message,t);
      }
    }
  }
;
  UMODescriptor descriptor=getTestDescriptor("testComponent",FunctionalTestComponent.class.getName());
  EventCallback callback=new EventCallback(){
    public void eventReceived(    UMOEventContext context,    Object Component) throws Exception {
      callbackCalled=true;
      currentTx=context.getCurrentTransaction();
      assertNotNull(currentTx);
      assertTrue(currentTx.isBegun());
      incEventCount();
      if (eventCount == 2) {
        currentTx.setRollbackOnly();
        eventCount=0;
      }
    }
  }
;
  initialiseComponent(descriptor,UMOTransactionConfig.ACTION_ALWAYS_BEGIN,UMOTransactionConfig.ACTION_ALWAYS_COMMIT,callback);
  List constraints=new ArrayList();
  BatchConstraint c=new BatchConstraint();
  c.setBatchSize(2);
  constraints.add(c);
  descriptor.getInboundEndpoint().getTransactionConfig().setConstraint(c);
  UMOManager manager=MuleManager.getInstance();
  UMOConnector umoCnn=manager.lookupConnector(CONNECTOR_NAME);
  umoCnn.setExceptionStrategy(es);
  manager.start();
  send(DEFAULT_MESSAGE + "1",false,Session.AUTO_ACKNOWLEDGE);
  send(DEFAULT_MESSAGE + "2",false,Session.AUTO_ACKNOWLEDGE);
  afterInitialise();
synchronized (lock) {
    lock.wait(5000);
  }
  Message msg=receive();
  assertNull(msg);
  assertTrue(callbackCalled);
  assertEquals(2,eventCount);
  assertTrue(currentTx.isRolledBack());
}
