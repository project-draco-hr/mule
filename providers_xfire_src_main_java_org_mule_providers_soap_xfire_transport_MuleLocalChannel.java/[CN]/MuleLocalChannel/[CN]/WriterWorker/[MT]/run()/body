{
  try {
    final XMLStreamWriter writer=STAXUtils.createXMLStreamWriter(stream,message.getEncoding(),context);
    message.getSerializer().writeMessage(message,writer,context);
    writer.close();
    stream.close();
  }
 catch (  Exception e) {
    throw new XFireRuntimeException("Couldn't write stream.",e);
  }
 finally {
    semaphore.release();
  }
}
