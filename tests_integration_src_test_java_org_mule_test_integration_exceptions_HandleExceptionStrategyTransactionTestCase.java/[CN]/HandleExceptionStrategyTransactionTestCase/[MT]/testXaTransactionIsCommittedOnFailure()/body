{
  LocalMuleClient client=muleContext.getClient();
  muleContext.registerListener(new ExceptionNotificationListener(){
    @Override public void onNotification(    ServerNotification notification){
      messageConsumed.release();
    }
  }
);
  client.dispatch("jms://in2?connector=activeMq",MESSAGE,null);
  messageConsumed.await(TIMEOUT,TimeUnit.MILLISECONDS);
  stopFlowConstruct("xaTransactionBehavior");
  MuleMessage outMessage=client.request("jms://out2?connector=activeMq",TIMEOUT);
  assertThat(outMessage,IsNull.<Object>notNullValue());
  assertThat(outMessage.getPayloadAsString(),is(MESSAGE));
  MuleMessage inMessage=client.request("jms://in2?connector=activeMq",TIMEOUT);
  assertThat(inMessage,IsNull.<Object>nullValue());
  MuleMessage inVmMessage=client.request("vm://vmIn2",TIMEOUT);
  assertThat(inVmMessage,IsNull.<Object>notNullValue());
  assertThat(inVmMessage.getPayloadAsString(),is(MESSAGE));
}
