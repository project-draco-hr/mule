{
  DomainClassLoaderFactory domainClassLoaderFactory=new DomainClassLoaderFactory(containerClassLoader.getClassLoader());
  MuleApplicationClassLoaderFactory applicationClassLoaderFactory=new MuleApplicationClassLoaderFactory(new DefaultNativeLibraryFinderFactory());
  DefaultDomainFactory domainFactory=new DefaultDomainFactory(domainClassLoaderFactory,domainManager,containerClassLoader);
  domainFactory.setDeploymentListener(domainDeploymentListener);
  final ArtifactPluginFactory artifactPluginFactory=new DefaultArtifactPluginFactory(new ArtifactPluginClassLoaderFactory());
  final ArtifactPluginDescriptorFactory artifactPluginDescriptorFactory=new ArtifactPluginDescriptorFactory(new DefaultArtifactClassLoaderFilterFactory());
  artifactPluginRepository=new DefaultArtifactPluginRepository(artifactPluginDescriptorFactory);
  ArtifactPluginDescriptorLoader artifactPluginDescriptorLoader=new ArtifactPluginDescriptorLoader(artifactPluginDescriptorFactory);
  final ApplicationDescriptorFactory applicationDescriptorFactory=new ApplicationDescriptorFactory(artifactPluginDescriptorLoader,artifactPluginRepository);
  ApplicationClassLoaderBuilderFactory applicationClassLoaderBuilderFactory=new ApplicationClassLoaderBuilderFactory(applicationClassLoaderFactory,artifactPluginRepository,artifactPluginFactory,artifactPluginDescriptorLoader);
  DefaultApplicationFactory applicationFactory=new DefaultApplicationFactory(applicationClassLoaderBuilderFactory,applicationDescriptorFactory,artifactPluginRepository,domainManager,serviceManager);
  applicationFactory.setDeploymentListener(applicationDeploymentListener);
  ArtifactDeployer<Application> applicationMuleDeployer=new DefaultArtifactDeployer<>();
  ArtifactDeployer<Domain> domainMuleDeployer=new DefaultArtifactDeployer<>();
  this.applicationDeployer=new DefaultArchiveDeployer<>(applicationMuleDeployer,applicationFactory,applications,deploymentLock,NOP_ARTIFACT_DEPLOYMENT_TEMPLATE);
  this.applicationDeployer.setDeploymentListener(applicationDeploymentListener);
  this.domainDeployer=new DomainArchiveDeployer(new DefaultArchiveDeployer<>(domainMuleDeployer,domainFactory,domains,deploymentLock,new DomainDeploymentTemplate(applicationDeployer,this)),applicationDeployer,this);
  this.domainDeployer.setDeploymentListener(domainDeploymentListener);
  this.deploymentDirectoryWatcher=new DeploymentDirectoryWatcher(domainDeployer,applicationDeployer,domains,applications,deploymentLock);
}
