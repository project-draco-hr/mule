{
  EventCallback callback=new EventCallback(){
    public synchronized void eventReceived(    UMOEventContext context,    Object component) throws Exception {
      currentTx=context.getCurrentTransaction();
      assertNotNull(currentTx);
      assertTrue(currentTx.isBegun());
      logger.info("@@@@ Rolling back transaction @@@@");
      currentTx.setRollbackOnly();
      callbackCalled.countDown();
    }
  }
;
  Object ftc=getPojoServiceForComponent("component3");
  assertTrue("FunctionalTestComponent expected",ftc instanceof FunctionalTestComponent);
  ((FunctionalTestComponent)ftc).setEventCallback(callback);
  send(TEST_MESSAGE,"component3In");
  assertTrue(callbackCalled.await(LOCK_TIMEOUT,TimeUnit.MILLISECONDS));
  assertEquals(TEST_MESSAGE,((FunctionalTestComponent)ftc).getLastReceivedMessage());
  assertTrue(currentTx.isBegun());
  Thread.sleep(1000);
  assertTrue(currentTx.isRolledBack());
  assertNull("Transaction was rolled back, but message got delivered anyways.",receive("component3Out",1000));
  Message dl=receive("dead.letter");
  assertNotNull(dl);
  assertTrue(dl instanceof TextMessage);
  assertEquals(TEST_MESSAGE_RESPONSE,((TextMessage)dl).getText());
  String dest=dl.getStringProperty(MuleProperties.MULE_ENDPOINT_PROPERTY);
  assertNotNull(dest);
  assertEquals("jms://dead.letter",dest);
}
