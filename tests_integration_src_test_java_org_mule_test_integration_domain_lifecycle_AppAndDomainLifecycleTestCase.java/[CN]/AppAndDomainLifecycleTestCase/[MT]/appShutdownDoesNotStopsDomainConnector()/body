{
  MuleContext domainContext=null;
  MuleContext firstAppContext=null;
  MuleContext secondAppContext=null;
  try {
    domainContext=new DomainContextBuilder().setDomainConfig("domain/http/http-shared-listener-config.xml").build();
    firstAppContext=new ApplicationContextBuilder().setApplicationResources(new String[]{"domain/http/http-hello-mule-app.xml"}).setDomainContext(domainContext).build();
    ApplicationContextBuilder secondApp=new ApplicationContextBuilder();
    secondAppContext=secondApp.setApplicationResources(new String[]{"domain/http/http-hello-world-app.xml"}).setDomainContext(domainContext).build();
    firstAppContext.stop();
    MuleMessage response=secondAppContext.getClient().send("http://localhost:" + dynamicPort.getNumber() + "/service/helloWorld",new DefaultMuleMessage("test",firstAppContext));
    assertThat(response,notNullValue());
    assertThat(secondAppContext.getTransformationService().getPayloadAsString(response),is("hello world"));
    assertThat((domainContext.getRegistry().<DefaultHttpListenerConfig>get("sharedListenerConfig")).isStarted(),is(true));
  }
  finally {
    closeQuietly(domainContext);
    closeQuietly(firstAppContext);
    closeQuietly(secondAppContext);
  }
}
