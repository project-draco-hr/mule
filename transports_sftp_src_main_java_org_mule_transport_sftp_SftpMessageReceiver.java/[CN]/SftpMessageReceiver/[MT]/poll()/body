{
  if (logger.isDebugEnabled()) {
    logger.debug("Polling. Called at endpoint " + endpoint.getEndpointURI());
  }
  try {
    if (!connected.get()) {
      if (logger.isDebugEnabled()) {
        logger.debug("Skipping poll since message receiver is not yet connected");
      }
      return;
    }
    String[] files;
    try {
      files=sftpRRUtil.getAvailableFiles(false);
    }
 catch (    Exception e) {
      connected.set(false);
      throw new ConnectException(e,this);
    }
    if (files.length == 0) {
      if (logger.isDebugEnabled()) {
        logger.debug("Polling. No matching files found at endpoint " + endpoint.getEndpointURI());
      }
    }
 else {
      if (logger.isDebugEnabled()) {
        logger.debug("Polling. " + files.length + " files found at "+ endpoint.getEndpointURI()+ ":"+ Arrays.toString(files));
      }
      for (      String file : files) {
        if (getLifecycleState().isStopping()) {
          break;
        }
        Lock fileLock=lockFactory.createLock(createLockId(file));
        if (fileLock.tryLock(10,TimeUnit.MILLISECONDS)) {
          try {
            routeFile(file);
          }
  finally {
            fileLock.unlock();
          }
        }
      }
      if (logger.isDebugEnabled()) {
        logger.debug("Polling. Routed all " + files.length + " files found at "+ endpoint.getEndpointURI());
      }
    }
  }
 catch (  MessagingException e) {
  }
catch (  Exception e) {
    logger.error("Error in poll",e);
    getEndpoint().getMuleContext().getExceptionListener().handleException(e);
    throw e;
  }
}
