{
  File file=FileUtils.newFile(endpoint.getEndpointURI().getAddress());
  File result=null;
  FilenameFilter filenameFilter=null;
  String filter=(String)endpoint.getProperty("filter");
  if (filter != null) {
    filter=URLDecoder.decode(filter,RegistryContext.getConfiguration().getDefaultEncoding());
    filenameFilter=new FilenameWildcardFilter(filter);
  }
  if (file.exists()) {
    if (file.isFile()) {
      result=file;
    }
 else     if (file.isDirectory()) {
      result=getNextFile(endpoint.getEndpointURI().getAddress(),filenameFilter);
    }
    if (result != null) {
      boolean checkFileAge=connector.getCheckFileAge();
      if (checkFileAge) {
        long fileAge=connector.getFileAge();
        long lastMod=result.lastModified();
        long now=System.currentTimeMillis();
        long thisFileAge=now - lastMod;
        if (thisFileAge < fileAge) {
          if (logger.isDebugEnabled()) {
            logger.debug("The file has not aged enough yet, will return nothing for: " + result.getCanonicalPath());
          }
          return null;
        }
      }
      MuleMessage message=new MuleMessage(connector.getMessageAdapter(result));
      File destinationFile=null;
      if (connector.getMoveToDirectory() != null) {
        destinationFile=FileUtils.newFile(connector.getMoveToDirectory(),result.getName());
        if (!result.renameTo(destinationFile)) {
          logger.error("Failed to move file: " + result.getAbsolutePath() + " to "+ destinationFile.getAbsolutePath());
        }
      }
      if (connector.isAutoDelete()) {
        if (destinationFile == null) {
          if (!result.delete()) {
            throw new MuleException(FileMessages.failedToDeleteFile(result.getAbsolutePath()));
          }
        }
      }
      return message;
    }
  }
  return null;
}
