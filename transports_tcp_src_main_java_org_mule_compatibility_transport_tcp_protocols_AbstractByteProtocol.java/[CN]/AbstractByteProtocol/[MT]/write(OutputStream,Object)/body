{
  if (data instanceof InputStream) {
    if (streamOk) {
      InputStream is=(InputStream)data;
      IOUtils.copyLarge(is,os);
      os.flush();
      os.close();
      is.close();
    }
 else {
      throw new IOException("TCP protocol " + ClassUtils.getSimpleName(getClass()) + " cannot handle streaming");
    }
  }
 else   if (data instanceof InternalMessage) {
    write(os,((InternalMessage)data).getPayload().getValue());
  }
 else   if (data instanceof byte[]) {
    writeByteArray(os,(byte[])data);
  }
 else   if (data instanceof String) {
    writeByteArray(os,((String)data).getBytes());
  }
 else   if (data instanceof Serializable) {
    writeByteArray(os,objectSerializer.serialize(data));
  }
 else {
    throw new IllegalArgumentException("Cannot serialize data: " + data);
  }
}
