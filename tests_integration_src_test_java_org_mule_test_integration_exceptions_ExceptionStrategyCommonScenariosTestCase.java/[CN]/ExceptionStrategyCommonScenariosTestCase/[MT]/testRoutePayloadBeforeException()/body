{
  final Latch messageProcessedLatch=new Latch();
  FunctionalTestComponent ftc=getFunctionalTestComponent("LastMessageStateRouting");
  ftc.setEventCallback(new EventCallback(){
    public void eventReceived(    MuleEventContext context,    Object component) throws Exception {
      messageProcessedLatch.release();
      throw new RuntimeException();
    }
  }
);
  LocalMuleClient client=muleContext.getClient();
  client.dispatch("jms://in1?connector=jmsConnector",MESSAGE_TO_SEND,null);
  if (!messageProcessedLatch.await(TIMEOUT,TimeUnit.MILLISECONDS)) {
    fail("Message never received by mule");
  }
  MuleMessage response=client.request("jms://dead.letter1?connector=jmsConnector",TIMEOUT);
  assertThat(response,IsNull.<Object>notNullValue());
  assertThat(getPayloadAsString(response),is(MESSAGE_MODIFIED));
}
