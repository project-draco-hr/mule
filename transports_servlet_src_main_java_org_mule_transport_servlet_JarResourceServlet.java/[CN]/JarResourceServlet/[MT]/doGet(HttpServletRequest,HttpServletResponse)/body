{
  String file=getFile(request);
  InputStream in=IOUtils.getResourceAsStream(file,getClass(),false,false);
  if (in == null) {
    response.setStatus(HttpServletResponse.SC_NOT_FOUND);
    response.getWriter().write("Unable to find file: " + request.getPathInfo());
    return;
  }
  try {
    ByteArrayOutputStream baos=new ByteArrayOutputStream();
    IOUtils.copyLarge(in,baos);
    byte[] buffer=baos.toByteArray();
    String mimetype=determineMimeType(file);
    buffer=expandTemplates(buffer,mimetype);
    response.setContentType(mimetype);
    response.setContentLength(buffer.length);
    if (mimetype.equals(DEFAULT_MIME_TYPE)) {
      response.setHeader("Content-Disposition","attachment; filename=\"" + request.getPathInfo() + "\"");
    }
    response.getOutputStream().write(buffer);
  }
  finally {
    in.close();
    response.getOutputStream().flush();
  }
}
