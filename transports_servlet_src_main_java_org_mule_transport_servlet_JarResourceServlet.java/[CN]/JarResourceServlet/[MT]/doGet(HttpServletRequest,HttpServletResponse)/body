{
  String file=getBasepath() + req.getPathInfo();
  if (file.startsWith("/")) {
    file=file.substring(1);
  }
  InputStream in=IOUtils.getResourceAsStream(file,getClass(),false,false);
  if (in == null) {
    resp.setStatus(HttpServletResponse.SC_NOT_FOUND);
    resp.getWriter().write("Unable to find file: " + req.getPathInfo());
    return;
  }
  byte[] buffer;
  try {
    ByteArrayOutputStream baos=new ByteArrayOutputStream();
    IOUtils.copyLarge(in,baos);
    buffer=baos.toByteArray();
    String mimetype=DEFAULT_MIME_TYPE;
    if (getServletContext() != null) {
      String temp=getServletContext().getMimeType(file);
      if (temp != null) {
        mimetype=temp;
      }
    }
    resp.setContentType(mimetype);
    resp.setContentLength(buffer.length);
    resp.setHeader("Content-Disposition","attachment; filename=\"" + req.getPathInfo() + "\"");
    for (    String extension : templateExtensions) {
      if (mimetype.endsWith(extension)) {
        buffer=parser.parse(props,new String(buffer)).getBytes();
        break;
      }
    }
    resp.getOutputStream().write(buffer);
  }
  finally {
    in.close();
    resp.getOutputStream().flush();
  }
}
