{
  Message result=null;
  try {
    result=new Message(context.getMessageAsString(encoding));
  }
 catch (  UMOException e) {
    throw new TransformerException(this,e);
  }
  UMOMessage msg=context.getMessage();
  if (msg.getExceptionPayload() != null) {
    result.setError(new XMPPError(503,context.getMessage().getExceptionPayload().getMessage()));
  }
  for (Iterator iterator=msg.getPropertyNames().iterator(); iterator.hasNext(); ) {
    String name=(String)iterator.next();
    if (name.equals(XmppConnector.XMPP_THREAD)) {
      result.setThread((String)msg.getProperty(name));
    }
 else     if (name.equals(XmppConnector.XMPP_SUBJECT)) {
      result.setSubject((String)msg.getProperty(name));
    }
 else     if (name.equals(XmppConnector.XMPP_FROM)) {
      result.setFrom((String)msg.getProperty(name));
    }
 else     if (name.equals(XmppConnector.XMPP_TO)) {
      result.setTo((String)msg.getProperty(name));
    }
 else {
      result.setProperty(name,msg.getProperty(name));
    }
  }
  return result;
}
