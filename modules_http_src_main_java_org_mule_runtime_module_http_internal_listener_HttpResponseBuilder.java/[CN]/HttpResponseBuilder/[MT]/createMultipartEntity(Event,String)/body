{
  if (logger.isDebugEnabled()) {
    logger.debug("Message contains outbound attachments. Ignoring payload and trying to generate multipart response");
  }
  final HashMap<String,DataHandler> parts=new HashMap<>();
  for (  String outboundAttachmentName : event.getMessage().getOutboundAttachmentNames()) {
    parts.put(outboundAttachmentName,event.getMessage().getOutboundAttachment(outboundAttachmentName));
  }
  try {
    if (event.getMessage().getPayload().getValue() instanceof MultiPartContent) {
      for (      org.mule.runtime.api.message.Message part : ((MultiPartContent)event.getMessage().getPayload().getValue()).getParts()) {
        final String partName=((PartAttributes)part.getAttributes()).getName();
        parts.put(partName,toDataHandler(partName,part.getPayload().getValue(),part.getPayload().getDataType().getMediaType()));
      }
    }
    final MultipartHttpEntity multipartEntity=new MultipartHttpEntity(HttpPartDataSource.createFrom(parts));
    return new ByteArrayHttpEntity(HttpMultipartEncoder.createMultipartContent(multipartEntity,contentType));
  }
 catch (  Exception e) {
    throw new MessagingException(event,e);
  }
}
