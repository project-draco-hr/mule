{
  Object payload;
  if (wrapper.isApplyTransformersToProtocol()) {
    payload=event.getMessage().getPayload();
  }
 else {
    payload=event.transformMessage();
  }
  if (wrapper.isProxy()) {
    return new Object[]{event.getMessage()};
  }
  Object[] args=payloadToArguments.payloadToArrayOfArguments(payload);
  MuleMessage message=event.getMessage();
  Set<?> attachmentNames=message.getAttachmentNames();
  if (attachmentNames != null && !attachmentNames.isEmpty()) {
    List<DataHandler> attachments=new ArrayList<DataHandler>();
    for (Iterator<?> i=attachmentNames.iterator(); i.hasNext(); ) {
      attachments.add(message.getAttachment((String)i.next()));
    }
    List<Object> temp=new ArrayList<Object>(Arrays.asList(args));
    temp.add(attachments.toArray(new DataHandler[0]));
    args=temp.toArray();
  }
  if (args.length == 0) {
    return null;
  }
  return args;
}
