{
  final int connectorRedelivery=connector.getMaxRedelivery();
  if (connectorRedelivery == JmsConnector.REDELIVERY_IGNORE || connectorRedelivery < 0) {
    if (logger.isDebugEnabled()) {
      logger.debug("We were asked to ignore the redelivery count, nothing to do here.");
    }
    return;
  }
  String id=message.getJMSMessageID();
  if (id == null) {
    if (logger.isDebugEnabled()) {
      logger.debug("Message doesn't have a JMSMessageID set, Mule can't handle redelivery for it. " + message);
    }
    return;
  }
  Integer redeliveryCount=messages.remove(id);
  if (redeliveryCount != null) {
    redeliveryCount+=1;
  }
  if (redeliveryCount == null) {
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + id + " has been redelivered for the first time");
    }
    messages.put(id,1);
  }
 else   if (redeliveryCount == 1) {
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + id + " has been redelivered for the first time");
    }
    if (connectorRedelivery == JmsConnector.REDELIVERY_FAIL_ON_FIRST) {
      MuleMessage msg=createMuleMessage(message);
      throw new MessageRedeliveredException(JmsMessages.tooManyRedeliveries(id,String.valueOf(redeliveryCount),connectorRedelivery,connector.getName()),msg);
    }
  }
 else   if (redeliveryCount > connectorRedelivery) {
    if (logger.isDebugEnabled()) {
      logger.debug(MessageFormat.format("Message with id: {0} has been redelivered {1} times, which exceeds the maxRedelivery setting " + "of {2} on the connector {3}",id,redeliveryCount,connectorRedelivery,connector.getName()));
    }
    MuleMessage msg=createMuleMessage(message);
    throw new MessageRedeliveredException(JmsMessages.tooManyRedeliveries(id,"" + redeliveryCount,connectorRedelivery,connector.getName()),msg);
  }
 else {
    messages.put(id,redeliveryCount);
    if (logger.isDebugEnabled()) {
      logger.debug("Message with id: " + id + " has been redelivered "+ redeliveryCount+ " times");
    }
  }
}
