{
  String xForwardedFor=muleMessage.getInboundProperty(HttpConstants.HEADER_X_FORWARDED_FOR);
  if (StringUtils.isEmpty(xForwardedFor)) {
    muleMessage.setProperty(MuleProperties.MULE_REMOTE_CLIENT_ADDRESS,httpServerConnection.getRemoteClientAddress(),PropertyScope.INBOUND);
    return;
  }
  String[] xForwardedForItems=StringUtils.splitAndTrim(xForwardedFor,",");
  if (!ArrayUtils.isEmpty(xForwardedForItems)) {
    muleMessage.setProperty(MuleProperties.MULE_REMOTE_CLIENT_ADDRESS,xForwardedForItems[0],PropertyScope.INBOUND);
    if (xForwardedForItems.length > 1) {
      muleMessage.setProperty(MuleProperties.MULE_PROXY_ADDRESS,xForwardedForItems[xForwardedForItems.length - 1],PropertyScope.INBOUND);
    }
 else {
      muleMessage.setProperty(MuleProperties.MULE_PROXY_ADDRESS,httpServerConnection.getRemoteClientAddress(),PropertyScope.INBOUND);
    }
  }
}
