{
  String xForwardedFor=muleMessage.getInboundProperty(HEADER_X_FORWARDED_FOR);
  if (StringUtils.isEmpty(xForwardedFor)) {
    muleMessage.setInboundProperty(MULE_REMOTE_CLIENT_ADDRESS,httpServerConnection.getRemoteClientAddress());
    return;
  }
  String[] xForwardedForItems=StringUtils.splitAndTrim(xForwardedFor,",");
  if (!ArrayUtils.isEmpty(xForwardedForItems)) {
    muleMessage.setInboundProperty(MULE_REMOTE_CLIENT_ADDRESS,xForwardedForItems[0]);
    if (xForwardedForItems.length > 1) {
      muleMessage.setInboundProperty(MULE_PROXY_ADDRESS,xForwardedForItems[xForwardedForItems.length - 1]);
    }
 else {
      muleMessage.setInboundProperty(MULE_PROXY_ADDRESS,httpServerConnection.getRemoteClientAddress());
    }
  }
}
