{
  if (data instanceof InputStream && !streamingIsAllowed) {
    throw new IOException("Streaming is not allowed with this configuration");
  }
 else   if (data instanceof Message) {
    if (payloadOnly) {
      return getByteArray(((Message)data).getPayload().getValue(),payloadOnly,streamingIsAllowed,encoding,objectSerializer);
    }
 else {
      return objectSerializer.getExternalProtocol().serialize(data);
    }
  }
 else   if (data instanceof byte[]) {
    return (byte[])data;
  }
 else   if (data instanceof String) {
    return ((String)data).getBytes(encoding);
  }
 else   if (data instanceof Serializable) {
    return objectSerializer.getExternalProtocol().serialize(data);
  }
  throw new IllegalArgumentException(format("Cannot serialize data: '%s'",data));
}
