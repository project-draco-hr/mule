{
  LoginContext loginContext;
  JaasAuthentication auth=(JaasAuthentication)authentication;
  MuleCallbackHandler cbh=new MuleCallbackHandler(auth);
  try {
    if (auth.getSubject() != null) {
      loginContext=new LoginContext(loginContextName,auth.getSubject(),cbh);
    }
 else {
      loginContext=new LoginContext(loginContextName,cbh);
    }
  }
 catch (  LoginException e) {
    throw new org.mule.api.security.UnauthorisedException(CoreMessages.cannotLoadFromClasspath(loginContextName));
  }
  try {
    loginContext.login();
  }
 catch (  LoginException le) {
    le.fillInStackTrace();
    throw new UnauthorisedException(CoreMessages.authFailedForUser(auth.getPrincipal()));
  }
  Subject subject=loginContext.getSubject();
  JaasAuthentication finalAuth=new JaasAuthentication(auth.getPrincipal(),auth.getCredentials(),subject);
  finalAuth.setAuthenticated(true);
  finalAuth.setEvent(authentication.getEvent());
  return finalAuth;
}
