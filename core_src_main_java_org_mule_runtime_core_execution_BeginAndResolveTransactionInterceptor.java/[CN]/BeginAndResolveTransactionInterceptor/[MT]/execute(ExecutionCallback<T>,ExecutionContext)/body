{
  byte action=transactionConfig.getAction();
  int timeout=transactionConfig.getTimeout();
  boolean resolveStartedTransaction=false;
  Transaction tx=TransactionCoordination.getInstance().getTransaction();
  if (action == TransactionConfig.ACTION_ALWAYS_BEGIN || (action == TransactionConfig.ACTION_BEGIN_OR_JOIN && tx == null)) {
    if (logger.isDebugEnabled()) {
      logger.debug("Beginning transaction");
    }
    executionContext.markTransactionStart();
    tx=transactionConfig.getFactory().beginTransaction(muleContext);
    tx.setTimeout(timeout);
    resolveStartedTransaction=true;
    if (logger.isDebugEnabled()) {
      logger.debug("Transaction successfully started: " + tx);
    }
  }
  T result;
  try {
    result=next.execute(callback,executionContext);
    resolveTransactionIfRequired(resolveStartedTransaction);
    return result;
  }
 catch (  MessagingException e) {
    if (processOnException) {
      resolveTransactionIfRequired(resolveStartedTransaction || mustResolveAnyTransaction);
    }
    throw e;
  }
}
