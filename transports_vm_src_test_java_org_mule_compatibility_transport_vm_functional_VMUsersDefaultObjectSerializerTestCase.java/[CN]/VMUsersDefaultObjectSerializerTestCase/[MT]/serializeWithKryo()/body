{
  final String payload="payload";
  flowRunner("dispatch").withPayload(payload).run();
  InternalMessage response=muleContext.getClient().request("vm://in",5000).getRight().get();
  assertThat(response,is(notNullValue()));
  assertThat(getPayloadAsString(response),is(payload));
  ArgumentCaptor<InternalMessage> messageArgumentCaptor=ArgumentCaptor.forClass(InternalMessage.class);
  verify(objectSerializer,atLeastOnce()).getExternalProtocol().serialize(messageArgumentCaptor.capture());
  InternalMessage capturedMessage=messageArgumentCaptor.getValue();
  assertThat(capturedMessage,is(notNullValue()));
  assertThat(getPayloadAsString(capturedMessage),is(payload));
  verify(objectSerializer,atLeastOnce()).getExternalProtocol().deserialize(any(byte[].class));
}
