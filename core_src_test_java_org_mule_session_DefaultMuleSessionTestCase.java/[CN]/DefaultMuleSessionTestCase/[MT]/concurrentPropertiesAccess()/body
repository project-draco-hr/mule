{
  final MuleSession session=new DefaultMuleSession();
  session.setProperty("p1","v1");
  session.setProperty("p2","v2");
  session.setProperty("p3","v3");
  session.setProperty("p4","v4");
  final CountDownLatch concurrentAccess=new CountDownLatch(2);
  final CountDownLatch executionComplete=new CountDownLatch(2);
  final AtomicBoolean failed=new AtomicBoolean(false);
  Runnable r=new Runnable(){
    @Override public void run(){
      try {
        int i=0;
        for (        String propertyName : session.getPropertyNamesAsSet()) {
          if (i == 2) {
            concurrentAccess.countDown();
            concurrentAccess.await(LATCH_TIMEOUT,TimeUnit.MILLISECONDS);
          }
          session.removeProperty(propertyName);
          i++;
        }
      }
 catch (      Exception e) {
        failed.set(true);
      }
      executionComplete.countDown();
    }
  }
;
  new Thread(r).start();
  new Thread(r).start();
  concurrentAccess.await(LATCH_TIMEOUT,TimeUnit.MILLISECONDS);
  assertThat(failed.get(),is(false));
}
