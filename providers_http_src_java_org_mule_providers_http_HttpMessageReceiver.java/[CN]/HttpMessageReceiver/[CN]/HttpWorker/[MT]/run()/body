{
  try {
    int counter=0;
    dataIn=new DataInputStream(new BufferedInputStream(socket.getInputStream()));
    dataOut=new DataOutputStream(new BufferedOutputStream(socket.getOutputStream()));
    do {
      if (isServerSide() && ++counter > 500) {
        counter=0;
        Thread.yield();
      }
      if (disposing.get() || socket.isClosed()) {
        logger.debug("Peer closed connection");
        break;
      }
      Properties headers=new Properties();
      byte[] payload=parseRequest(dataIn,headers);
      if (payload == null) {
        break;
      }
      UMOMessageAdapter adapter=connector.getMessageAdapter(new Object[]{payload,headers});
      boolean http11=((String)adapter.getProperty(HttpConnector.HTTP_VERSION_PROPERTY)).equalsIgnoreCase(HttpConstants.HTTP11);
      if (!http11) {
        keepAlive=adapter.getProperty(HttpConstants.HEADER_KEEP_ALIVE) != null;
      }
 else {
        String connection=(String)adapter.getProperty(HttpConstants.HEADER_CONNECTION);
        if (connection != null && connection.equalsIgnoreCase("close")) {
          keepAlive=false;
        }
 else {
          keepAlive=true;
        }
      }
      if (keepAlive && !keepAliveRegistered) {
        keepAliveRegistered=true;
        if (keepAliveMonitor != null) {
          keepAliveMonitor.addExpirable(((HttpConnector)connector).getKeepAliveTimeout(),this);
        }
 else {
          logger.info("Request has Keep alive set but the HttpConnector has keep alive disables");
          keepAlive=false;
        }
      }
      if (adapter != null) {
        UMOMessage message=new MuleMessage(adapter);
        if (logger.isDebugEnabled()) {
          logger.debug(message.getProperty(HttpConnector.HTTP_REQUEST_PROPERTY));
        }
        OutputStream os=new ResponseOutputStream(dataOut,socket);
        UMOMessage returnMessage=routeMessage(message,endpoint.isSynchronous(),os);
        if (returnMessage == null) {
          returnMessage=new MuleMessage("",null);
        }
        RequestContext.rewriteEvent(returnMessage);
        Object response=responseTransformer.transform(returnMessage.getPayload());
        if (response instanceof byte[]) {
          dataOut.write((byte[])response);
        }
 else {
          dataOut.write(response.toString().getBytes());
        }
        dataOut.flush();
        if (keepAliveMonitor != null) {
          keepAliveMonitor.resetExpirable(this);
        }
      }
    }
 while (!socket.isClosed() && keepAlive);
  }
 catch (  Exception e) {
    keepAlive=false;
    handleException(e);
  }
 finally {
    if (keepAliveMonitor != null) {
      keepAliveMonitor.removeExpirable(this);
    }
    dispose();
  }
}
