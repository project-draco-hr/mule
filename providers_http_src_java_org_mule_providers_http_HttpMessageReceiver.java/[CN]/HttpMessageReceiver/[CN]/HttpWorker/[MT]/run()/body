{
  boolean keepAlive=((HttpConnector)connector).isKeepAlive();
  try {
    dataIn=new DataInputStream(new BufferedInputStream(socket.getInputStream()));
    dataOut=new DataOutputStream(new BufferedOutputStream(socket.getOutputStream()));
    do {
      if (disposing.get() || socket.isClosed()) {
        logger.debug("Peer closed connection");
        break;
      }
      Properties headers=new Properties();
      Object payload=parseRequest(dataIn,headers);
      if (payload == null) {
        break;
      }
      UMOMessageAdapter adapter=connector.getMessageAdapter(new Object[]{payload,headers});
      keepAlive=adapter.getBooleanProperty(HttpConstants.HEADER_KEEP_ALIVE,keepAlive);
      UMOMessage message=new MuleMessage(adapter);
      if (logger.isDebugEnabled()) {
        logger.debug(message.getProperty(HttpConnector.HTTP_REQUEST_PROPERTY));
      }
      OutputStream os=new ResponseOutputStream(dataOut,socket);
      AbstractMessageReceiver receiver=getTargetReceiver(message,endpoint);
      UMOMessage returnMessage=null;
      if (receiver != null) {
        returnMessage=receiver.routeMessage(message,endpoint.isSynchronous(),os);
        if (returnMessage == null) {
          returnMessage=new MuleMessage("");
        }
        RequestContext.rewriteEvent(returnMessage);
      }
 else {
        returnMessage=new MuleMessage(new Message(Messages.CANNOT_BIND_TO_ADDRESS_X,endpoint.getEndpointURI().toString()).toString());
        returnMessage.setIntProperty(HttpConnector.HTTP_STATUS_PROPERTY,HttpConstants.SC_NOT_FOUND);
        RequestContext.setEvent(new MuleEvent(returnMessage,endpoint,new MuleSession(),true));
      }
      Object response=responseTransformer.transform(returnMessage);
      if (response instanceof byte[]) {
        dataOut.write((byte[])response);
      }
 else {
        dataOut.write(response.toString().getBytes());
      }
      dataOut.flush();
    }
 while (socket.isConnected() && keepAlive);
  }
 catch (  Exception e) {
    keepAlive=false;
    handleException(e);
  }
 finally {
    dispose();
  }
}
