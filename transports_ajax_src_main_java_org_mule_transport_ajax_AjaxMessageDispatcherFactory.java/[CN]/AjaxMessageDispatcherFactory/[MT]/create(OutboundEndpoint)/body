{
  AjaxMessageDispatcher dispatcher=new AjaxMessageDispatcher(endpoint);
  if (endpoint.getConnector() instanceof AjaxConnector) {
    AjaxConnector.BayeuxHolder holder=((AjaxConnector)endpoint.getConnector()).registerBayeuxEndpoint(endpoint);
    dispatcher.setBayeux(holder.getBayeux());
  }
 else {
    AbstractBayeux b=((AjaxServletConnector)endpoint.getConnector()).getBayeux();
    if (b == null) {
      throw new IllegalArgumentException("Bayeux is null: " + endpoint.getConnector());
    }
    dispatcher.setBayeux(b);
  }
  return dispatcher;
}
