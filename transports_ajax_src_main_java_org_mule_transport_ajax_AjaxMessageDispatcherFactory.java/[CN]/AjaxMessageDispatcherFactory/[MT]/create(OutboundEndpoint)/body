{
  AjaxMessageDispatcher dispatcher=new AjaxMessageDispatcher(endpoint);
  if (endpoint.getConnector() instanceof AjaxConnector) {
    AjaxConnector.BayeuxHolder holder=((AjaxConnector)endpoint.getConnector()).registerBayeuxEndpoint(endpoint);
    dispatcher.setBayeux(holder.getBayeux());
  }
 else {
    AbstractBayeux b=((AjaxServletConnector)endpoint.getConnector()).getBayeux();
    if (b == null) {
      long start=System.currentTimeMillis();
      long timeout=start + endpoint.getResponseTimeout();
      while (start < timeout) {
        try {
          Thread.sleep(1000);
          b=((AjaxServletConnector)endpoint.getConnector()).getBayeux();
          if (b != null)           break;
        }
 catch (        InterruptedException e) {
        }
      }
      throw new IllegalArgumentException("Bayeux is null: " + endpoint.getConnector() + ". Waited for "+ endpoint.getResponseTimeout()+ " for object to become availble, this usually caused if the servlet container takes a long time to start up");
    }
    dispatcher.setBayeux(b);
  }
  return dispatcher;
}
