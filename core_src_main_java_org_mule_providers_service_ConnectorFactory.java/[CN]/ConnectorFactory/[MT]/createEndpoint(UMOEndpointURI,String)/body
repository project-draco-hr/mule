{
  String scheme=uri.getFullScheme();
  UMOConnector connector=null;
  try {
    if (uri.getCreateConnector() == ALWAYS_CREATE_CONNECTOR) {
      connector=createConnector(uri);
      MuleManager.getInstance().registerConnector(connector);
    }
 else     if (uri.getCreateConnector() == NEVER_CREATE_CONNECTOR) {
      connector=getConnectorByProtocol(scheme);
    }
 else     if (uri.getConnectorName() != null) {
      connector=MuleManager.getInstance().lookupConnector(uri.getConnectorName());
      if (connector == null) {
        throw new ConnectorFactoryException(new Message(Messages.X_NOT_REGISTERED_WITH_MANAGER,"Connector: " + uri.getConnectorName()));
      }
    }
 else {
      connector=getConnectorByProtocol(scheme);
      if (connector == null) {
        connector=createConnector(uri);
        MuleManager.getInstance().registerConnector(connector);
      }
    }
  }
 catch (  Exception e) {
    throw new ConnectorFactoryException(e);
  }
  if (connector == null) {
    Message m=new Message(Messages.FAILED_TO_CREATE_X_WITH_X,"Endpoint","Uri: " + uri);
    m.setNextMessage(new Message(Messages.X_IS_NULL,"connector"));
    throw new ConnectorFactoryException(m);
  }
  UMOEndpoint endpoint=new MuleEndpoint();
  endpoint.setConnector(connector);
  endpoint.setEndpointURI(uri);
  if (uri.getEndpointName() != null) {
    endpoint.setName(uri.getEndpointName());
  }
  String name=ObjectNameHelper.getEndpointName(endpoint);
  endpoint.setName(name);
  if (type != null) {
    endpoint.setType(type);
    UMOTransformer trans=getTransformer(uri,connector,(UMOEndpoint.ENDPOINT_TYPE_RECEIVER.equals(type) ? 0 : 1));
    endpoint.setTransformer(trans);
    if (UMOEndpoint.ENDPOINT_TYPE_RECEIVER.equals(type)) {
      trans=getTransformer(uri,connector,2);
      endpoint.setResponseTransformer(trans);
    }
  }
  return endpoint;
}
