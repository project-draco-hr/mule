{
  AbstractConnector connector=Mockito.mock(AbstractConnector.class);
  when(connector.getSessionHandler()).thenReturn(new NullSessionHandler());
  when(connector.getMuleContext()).thenReturn(muleContext);
  FlowConstruct flowConstruct=Mockito.mock(FlowConstruct.class);
  InboundEndpoint endpoint=Mockito.mock(InboundEndpoint.class);
  when(endpoint.getExchangePattern()).thenReturn(mep);
  when(endpoint.getConnector()).thenReturn(connector);
  when(endpoint.getEndpointURI()).thenReturn(new MuleEndpointURI("test://test",muleContext));
  when(endpoint.getTransactionConfig()).thenReturn(new MuleTransactionConfig());
  when(endpoint.getExchangePattern()).thenReturn(mep);
  when(endpoint.getMuleContext()).thenReturn(muleContext);
  MuleEvent responseEvent=Mockito.mock(MuleEvent.class);
  when(responseEvent.getSession()).thenReturn(muleSession);
  MessageProcessor listener=Mockito.mock(MessageProcessor.class);
  when(listener.process(any(MuleEvent.class))).thenAnswer(new Answer<MuleEvent>(){
    @Override public MuleEvent answer(    InvocationOnMock invocation) throws Throwable {
      return (MuleEvent)invocation.getArguments()[0];
    }
  }
);
  MessageReceiver messageReceiver=new TestMessageReceiver(connector,flowConstruct,endpoint);
  messageReceiver.setListener(listener);
  return messageReceiver;
}
