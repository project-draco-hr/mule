{
  boolean closeConnection=false;
  while (requestCount < MAX_REQUESTS && !closeConnection) {
    HttpRequest request=parseRequest(in,muleContext.getConfiguration().getDefaultEncoding());
    Header connHeader=request.getFirstHeader("Connection");
    connectionHeader=(connHeader == null) ? null : connHeader.getValue();
    requestCount++;
    closeConnection="close".equals(connectionHeader);
    StringBuffer response=new StringBuffer("HTTP/1.1 200 OK\n");
    if (closeConnection) {
      response.append(HttpConstants.HEADER_CONNECTION);
      response.append(": close\n");
    }
    response.append("Content-Length: 4\n\nTEST");
    out.write(response.toString().getBytes());
  }
}
