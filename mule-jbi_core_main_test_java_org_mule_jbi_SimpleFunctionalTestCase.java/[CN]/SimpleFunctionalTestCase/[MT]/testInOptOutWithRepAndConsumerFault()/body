{
  TestComponent provider=new TestComponent();
  TestComponent consumer=new TestComponent();
  ((ComponentRegistryImpl)container.getComponentRegistry()).registerTransientEngineComponent("provider",provider);
  ((ComponentRegistryImpl)container.getComponentRegistry()).registerTransientEngineComponent("consumer",consumer);
  ServiceEndpoint endpoint=provider.getContext().activateEndpoint(SERVICE_NAME,ENDPOINT_NAME);
  MessageExchangeFactory mef=consumer.getChannel().createExchangeFactory(endpoint);
  InOptionalOut mec=mef.createInOptionalOutExchange();
  NormalizedMessage m=mec.createMessage();
  m.setContent(new StreamSource(new ByteArrayInputStream(PAYLOAD.getBytes())));
  mec.setInMessage(m);
  consumer.getChannel().send(mec);
  InOptionalOut mep=(InOptionalOut)provider.getChannel().accept(10L);
  assertNotNull(mep);
  assertEquals(ExchangeStatus.ACTIVE,mep.getStatus());
  m=mep.createMessage();
  m.setContent(new StreamSource(new ByteArrayInputStream(RESPONSE.getBytes())));
  mep.setOutMessage(m);
  provider.getChannel().send(mep);
  assertSame(mec,consumer.getChannel().accept(10L));
  assertEquals(ExchangeStatus.ACTIVE,mec.getStatus());
  mec.setStatus(ExchangeStatus.ERROR);
  consumer.getChannel().send(mec);
  assertSame(mep,provider.getChannel().accept(10L));
  assertEquals(ExchangeStatus.ERROR,mep.getStatus());
  mep.setStatus(ExchangeStatus.DONE);
  provider.getChannel().send(mep);
  assertSame(mec,consumer.getChannel().accept(10L));
  assertEquals(ExchangeStatus.DONE,mec.getStatus());
  assertNull(consumer.getChannel().accept(10L));
  assertNull(provider.getChannel().accept(10L));
}
