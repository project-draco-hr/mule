{
  Object content=message.getContent();
  if (content instanceof Multipart) {
    TreeMap attachments=new TreeMap();
    MailUtils.getAttachments((Multipart)content,attachments);
    logger.debug("Received Multipart message");
    int i=0;
    for (Iterator iterator=attachments.entrySet().iterator(); iterator.hasNext(); i++) {
      Map.Entry entry=(Map.Entry)iterator.next();
      Part part=(Part)entry.getValue();
      String name=entry.getKey().toString();
      if (i == 0) {
        setMessage(part);
      }
 else {
        addAttachment(name,part.getDataHandler());
        addAttachmentHeaders(name,part);
      }
    }
  }
 else {
    setMessage(message);
  }
}
