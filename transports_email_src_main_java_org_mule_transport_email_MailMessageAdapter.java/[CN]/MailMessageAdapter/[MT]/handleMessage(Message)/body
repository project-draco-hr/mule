{
  Object content=message.getContent();
  if (content instanceof Multipart) {
    TreeMap attachments=new TreeMap();
    MailUtils.getAttachments((Multipart)content,attachments);
    logger.debug("Received Multipart message. Adding attachments");
    for (Iterator iterator=attachments.entrySet().iterator(); iterator.hasNext(); ) {
      Map.Entry entry=(Map.Entry)iterator.next();
      Part part=(Part)entry.getValue();
      String name=entry.getKey().toString();
      addAttachment(name,part.getDataHandler());
      addAttachmentHeaders(name,part);
    }
  }
  setMessage(message);
}
