{
  final int numberOfMessages=2;
  MuleClient client=muleContext.getClient();
  logger.debug("sending messages");
  for (int sentPackets=0; sentPackets < numberOfMessages; sentPackets++) {
    String msg=MESSAGE + sentPackets;
    client.dispatch("serverEndpoint",msg,null);
  }
  int broadcastMessages=numberOfMessages * 3;
  Set<String> receivedMessages=new HashSet<String>(broadcastMessages);
  logger.debug("receiving messages");
  int receivedPackets=0;
  for (; receivedPackets < broadcastMessages; receivedPackets++) {
    MuleMessage message=client.request("vm://foo",2000);
    assertNotNull(message);
    receivedMessages.add(message.getPayloadAsString());
  }
  assertEquals(broadcastMessages,receivedPackets);
  checkBroadcastMessagesForComponent(numberOfMessages,receivedMessages,"Component1");
  checkBroadcastMessagesForComponent(numberOfMessages,receivedMessages,"Component2");
  checkBroadcastMessagesForComponent(numberOfMessages,receivedMessages,"Component3");
  assertEquals(0,receivedMessages.size());
}
