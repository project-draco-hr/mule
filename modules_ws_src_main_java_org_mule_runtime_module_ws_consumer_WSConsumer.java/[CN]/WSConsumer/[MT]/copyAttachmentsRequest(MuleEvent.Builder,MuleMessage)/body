{
  final Builder builder=MuleMessage.builder(message);
  List<Attachment> attachments=new ArrayList<>();
  for (  String outboundAttachmentName : message.getOutboundAttachmentNames()) {
    attachments.add(new AttachmentImpl(outboundAttachmentName,message.getOutboundAttachment(outboundAttachmentName)));
  }
  try {
    if (message.getPayload() instanceof MultiPartPayload) {
      for (      org.mule.runtime.api.message.MuleMessage part : ((MultiPartPayload)message.getPayload()).getParts()) {
        final String partName=((PartAttributes)part.getAttributes()).getName();
        attachments.add(new AttachmentImpl(partName,toDataHandler(partName,part.getPayload(),part.getDataType().getMediaType())));
      }
      builder.nullPayload();
    }
  }
 catch (  IOException e) {
    throw new MessagingException(CoreMessages.createStaticMessage("Exception processing attachments."),eventBuilder.build(),e,this);
  }
  eventBuilder.addFlowVariable(CxfConstants.ATTACHMENTS,attachments).message(builder.outboundAttachments(emptyMap()).build());
}
