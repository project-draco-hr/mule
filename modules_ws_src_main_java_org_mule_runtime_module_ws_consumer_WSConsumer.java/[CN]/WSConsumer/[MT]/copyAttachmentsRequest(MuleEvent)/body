{
  MuleMessage message=event.getMessage();
  final Builder builder=MuleMessage.builder(event.getMessage());
  List<Attachment> attachments=new ArrayList<>();
  for (  String outboundAttachmentName : event.getMessage().getOutboundAttachmentNames()) {
    attachments.add(new AttachmentImpl(outboundAttachmentName,event.getMessage().getOutboundAttachment(outboundAttachmentName)));
  }
  try {
    if (event.getMessage().getPayload() instanceof MultiPartPayload) {
      for (      org.mule.runtime.api.message.MuleMessage part : ((MultiPartPayload)event.getMessage().getPayload()).getParts()) {
        final String partName=((PartAttributes)part.getAttributes()).getName();
        attachments.add(new AttachmentImpl(partName,toDataHandler(partName,part.getPayload(),part.getDataType().getMediaType())));
      }
      builder.nullPayload();
    }
  }
 catch (  IOException e) {
    throw new MessagingException(CoreMessages.createStaticMessage("Exception processing attachments."),event,e,this);
  }
  event.setFlowVariable(CxfConstants.ATTACHMENTS,attachments);
  event.setMessage(builder.outboundAttachments(emptyMap()).build());
}
