{
  if (logger.isDebugEnabled()) {
    logger.debug("Received message from: " + endpoint.getEndpointURI().getAddress());
    logger.debug("Payload is of type: " + message.getPayload().getClass().getName());
    StringBuffer buf=new StringBuffer();
    Map props=message.getProperties();
    for (Iterator iterator=props.entrySet().iterator(); iterator.hasNext(); ) {
      Map.Entry entry=(Map.Entry)iterator.next();
      buf.append("  ").append(entry.getKey()).append("=").append(entry.getValue()).append("\n");
    }
    logger.debug("Message properties:\n" + buf.toString());
  }
  ResponseOutputStream ros=null;
  if (outputStream != null) {
    if (outputStream instanceof ResponseOutputStream) {
      ros=(ResponseOutputStream)outputStream;
    }
 else {
      ros=new ResponseOutputStream(outputStream);
    }
  }
  if (endpoint.getFilter() != null) {
    if (!endpoint.getFilter().accept(message)) {
      handleUnacceptedFilter(message);
      return null;
    }
  }
  UMOSession session=new MuleSession(component,trans);
  UMOEvent muleEvent=new MuleEvent(message,endpoint,session,synchronous,ros);
  RequestContext.setEvent(muleEvent);
  if (endpoint.getSecurityFilter() != null) {
    try {
      endpoint.getSecurityFilter().authenticate(muleEvent);
    }
 catch (    UMOSecurityException e) {
      logger.warn("Request was made but was not authenticated: " + e.getMessage(),e);
      return handleSecurtyException(e,muleEvent);
    }
  }
  UMOMessage resultMessage=null;
  if (UMOEndpoint.ENDPOINT_TYPE_RESPONSE.equals(endpoint.getType())) {
    component.getDescriptor().getResponseRouter().route(muleEvent);
    return null;
  }
 else {
    resultMessage=component.getDescriptor().getInboundRouter().route(muleEvent);
  }
  return resultMessage;
}
