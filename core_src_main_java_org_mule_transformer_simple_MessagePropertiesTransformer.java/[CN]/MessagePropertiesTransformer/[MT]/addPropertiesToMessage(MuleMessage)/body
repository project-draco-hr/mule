{
  for (Iterator iterator=addProperties.entrySet().iterator(); iterator.hasNext(); ) {
    Map.Entry entry=(Map.Entry)iterator.next();
    if (entry.getKey() == null) {
      logger.error("Setting Null property keys is not supported, this entry is being ignored");
    }
 else {
      final String key=entry.getKey().toString();
      Object value=entry.getValue();
      if (muleContext.getExpressionManager().isValidExpression(value.toString())) {
        value=muleContext.getExpressionManager().evaluate(value.toString(),message);
      }
      if (message.getProperty(key,scope) != null) {
        if (overwrite) {
          logger.debug("Overwriting message property " + key);
          message.setProperty(key,value,scope);
        }
 else {
          logger.debug(MessageFormat.format("Message already contains the property and overwrite is false, skipping: key={0}, value={1}, scope={2}",key,value,scope));
        }
      }
 else {
        message.setProperty(key,value,scope);
      }
    }
  }
}
