{
  byte[] msg=loadEncryptedMessage();
  Map<String,String> props=new HashMap<String,String>();
  props.put("TARGET_FILE",TARGET);
  MuleClient client=new MuleClient(muleContext);
  MuleMessage reply=client.send("vm://echo",new String(msg),props);
  assertNull(reply.getExceptionPayload());
  File pollingFile=null;
  for (int i=0; i < 5; i++) {
    pollingFile=new File(DIRECTORY + TARGET);
    if (!pollingFile.exists()) {
      Thread.sleep(1000);
    }
  }
  pollingFile=null;
  try {
    FileReader outputFile=new FileReader(DIRECTORY + TARGET);
    String fileContents=IOUtils.toString(outputFile);
    outputFile.close();
    assertTrue(fileContents.contains("This is a test message"));
    File f=FileUtils.newFile(DIRECTORY + TARGET);
    assertTrue("Deleting the output file failed",f.delete());
  }
 catch (  FileNotFoundException fileNotFound) {
    fail("File not successfully created");
  }
}
