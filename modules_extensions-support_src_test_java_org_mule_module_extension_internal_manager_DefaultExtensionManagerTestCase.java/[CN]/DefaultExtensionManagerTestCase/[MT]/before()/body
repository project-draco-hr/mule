{
  DefaultExtensionManager extensionsManager=new DefaultExtensionManager();
  extensionsManager.setExtensionsDiscoverer(discoverer);
  extensionsManager.setMuleContext(muleContext);
  this.extensionsManager=extensionsManager;
  when(extension1.getName()).thenReturn(EXTENSION1_NAME);
  when(extension1.getConfigurations()).thenReturn(Arrays.asList(extension1Configuration));
  when(extension2.getName()).thenReturn(EXTENSION2_NAME);
  when(extension1.getVersion()).thenReturn(EXTENSION1_VERSION);
  when(extension2.getVersion()).thenReturn(EXTENSION2_VERSION);
  when(extension1Configuration.getName()).thenReturn(EXTENSION1_CONFIG_NAME);
  when(extension1Configuration.getInstantiator().newInstance()).thenReturn(configInstance);
  when(extension1Configuration.getInstantiator().getObjectType()).thenReturn((Class)configInstance.getClass());
  when(extension1.getConfiguration(EXTENSION1_CONFIG_NAME)).thenReturn(extension1Configuration);
  when(extension1.getOperation(EXTENSION1_OPERATION_NAME)).thenReturn(extension1Operation);
  when(extension1Operation.getName()).thenReturn(EXTENSION1_OPERATION_NAME);
  when(extension1OperationContext.getOperation()).thenReturn(extension1Operation);
  when(extension1ConfigurationInstanceProvider.getConfiguration()).thenReturn(extension1Configuration);
  when(extension1ConfigurationInstanceProvider.getName()).thenReturn(EXTENSION1_CONFIG_INSTANCE_NAME);
  when(extension1ConfigurationInstanceProvider.get(same(extension1OperationContext),any(ConfigurationInstanceRegistrationCallback.class))).thenAnswer(new Answer<Object>(){
    private boolean firstTime=true;
    @Override public Object answer(    InvocationOnMock invocation) throws Throwable {
      if (firstTime) {
        ConfigurationInstanceRegistrationCallback callback=(ConfigurationInstanceRegistrationCallback)invocation.getArguments()[1];
        callback.registerNewConfigurationInstance(extension1ConfigurationInstanceProvider,configInstance);
        firstTime=false;
      }
      return configInstance;
    }
  }
);
  when(executor.getExecutorDelegate()).thenReturn(executorDelegate);
  when(extension1Operation.getExecutor(configInstance)).thenReturn(executor);
  classLoader=getClass().getClassLoader();
  setDiscoverableExtensions(extension1,extension2);
  when(discoverer.discover(same(classLoader))).thenAnswer(new Answer<List<Extension>>(){
    @Override public List<Extension> answer(    InvocationOnMock invocation) throws Throwable {
      return getTestExtensions();
    }
  }
);
  ExtensionsTestUtils.stubRegistryKeys(muleContext,EXTENSION1_CONFIG_INSTANCE_NAME,EXTENSION1_OPERATION_NAME,EXTENSION1_NAME);
}
