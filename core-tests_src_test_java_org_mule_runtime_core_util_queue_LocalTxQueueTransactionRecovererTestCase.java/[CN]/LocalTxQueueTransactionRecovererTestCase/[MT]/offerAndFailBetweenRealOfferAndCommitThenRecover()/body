{
  txLog=new TestTransactionLogger(temporaryFolder.getRoot().getAbsolutePath(),muleContext).failDuringLogCommit();
  final DefaultQueueStore outQueue=new DefaultQueueStore(QUEUE_NAME,muleContext,new DefaultQueueConfiguration(0,true));
  persistentTransactionContext=new PersistentQueueTransactionContext(txLog,createQueueProvider(outQueue));
  persistentTransactionContext.offer(outQueue,testEvent(),TIMEOUT);
  try {
    persistentTransactionContext.doCommit();
    fail();
  }
 catch (  ResourceManagerException e) {
  }
  txLog.close();
  txLog=new TestTransactionLogger(temporaryFolder.getRoot().getAbsolutePath(),muleContext);
  queueTransactionRecoverer=new LocalTxQueueTransactionRecoverer(txLog,createQueueProvider(outQueue));
  queueTransactionRecoverer.recover();
  Serializable muleEvent=outQueue.poll(TIMEOUT);
  assertThat(muleEvent,nullValue());
}
