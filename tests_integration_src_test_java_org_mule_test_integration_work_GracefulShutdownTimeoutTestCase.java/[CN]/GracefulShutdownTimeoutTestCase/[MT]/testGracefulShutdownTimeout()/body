{
  final Latch latch=new Latch();
  FlowConstruct service=muleContext.getRegistry().lookupFlowConstruct("TestService");
  FunctionalTestComponent testComponent=(FunctionalTestComponent)getComponent(service);
  testComponent.setEventCallback(new EventCallback(){
    public void eventReceived(    MuleEventContext context,    Object component) throws Exception {
      Thread.sleep(5500);
      latch.countDown();
    }
  }
);
  if (variant.equals(ConfigVariant.FLOW)) {
    ((Flow)service).process(getTestEvent("test"));
    Thread.sleep(200);
    ((Flow)service).dispose();
    assertTrue(latch.await(1000,TimeUnit.MILLISECONDS));
  }
 else {
    ((Service)service).dispatchEvent(getTestEvent("test"));
    Thread.sleep(200);
    ((Service)service).dispose();
    assertTrue(latch.await(1000,TimeUnit.MILLISECONDS));
  }
}
