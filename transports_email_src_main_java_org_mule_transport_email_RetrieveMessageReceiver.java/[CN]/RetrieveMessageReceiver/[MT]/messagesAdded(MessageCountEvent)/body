{
  Message messages[]=event.getMessages();
  if (messages != null) {
    MuleMessage message=null;
    for (int i=0; i < messages.length; i++) {
      try {
        if (!messages[i].getFlags().contains(Flags.Flag.DELETED) && !messages[i].getFlags().contains(Flags.Flag.SEEN)) {
          MimeMessage mimeMessage=new MimeMessage((MimeMessage)messages[i]);
          storeMessage(mimeMessage);
          message=createMuleMessage(mimeMessage,endpoint.getEncoding());
          if (castConnector().isDeleteReadMessages()) {
            messages[i].setFlag(Flags.Flag.DELETED,true);
          }
 else {
            messages[i].setFlag(Flags.Flag.SEEN,true);
          }
          routeMessage(message);
        }
      }
 catch (      MuleException e) {
        getFlowConstruct().getExceptionListener().exceptionThrown(e);
      }
catch (      Exception e) {
        Exception forwarded;
        if (message != null) {
          forwarded=new RoutingException(EmailMessages.routingError(),message,endpoint,e);
        }
 else {
          forwarded=new ReceiveException(endpoint,-1,e);
        }
        getFlowConstruct().getExceptionListener().exceptionThrown(forwarded);
      }
    }
    if (moveToFolder != null) {
      try {
        folder.copyMessages(messages,moveToFolder);
      }
 catch (      MessagingException e) {
        getFlowConstruct().getExceptionListener().exceptionThrown(e);
      }
    }
  }
}
