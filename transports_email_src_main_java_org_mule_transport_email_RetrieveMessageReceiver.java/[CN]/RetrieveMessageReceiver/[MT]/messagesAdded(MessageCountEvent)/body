{
  Message messages[]=event.getMessages();
  if (messages != null) {
    MuleMessage message=null;
    for (int i=0; i < messages.length; i++) {
      try {
        if (!messages[i].getFlags().contains(Flags.Flag.DELETED) && !messages[i].getFlags().contains(Flags.Flag.SEEN)) {
          MimeMessage mimeMessage=new MimeMessage((MimeMessage)messages[i]);
          storeMessage(mimeMessage);
          message=createMuleMessage(mimeMessage,endpoint.getEncoding());
          if (castConnector().isDeleteReadMessages()) {
            messages[i].setFlag(Flags.Flag.DELETED,true);
          }
 else {
            if (this.getEndpoint().getFilter() != null && this.getEndpoint().getFilter().accept(message)) {
              Flags.Flag flag=castConnector().getDefaultProcessMessageAction();
              if (flag != null) {
                messages[i].setFlag(flag,true);
              }
            }
 else {
              messages[i].setFlag(Flags.Flag.SEEN,false);
            }
          }
          routeMessage(message);
        }
      }
 catch (      MuleException e) {
        getConnector().getMuleContext().getExceptionListener().handleException(e);
      }
catch (      Exception e) {
        Exception forwarded;
        if (message != null) {
          forwarded=new org.mule.api.MessagingException(EmailMessages.routingError(),message,e);
        }
 else {
          forwarded=new ReceiveException(endpoint,-1,e);
        }
        getConnector().getMuleContext().getExceptionListener().handleException(forwarded);
      }
    }
    if (moveToFolder != null) {
      try {
        folder.copyMessages(messages,moveToFolder);
      }
 catch (      MessagingException e) {
        getConnector().getMuleContext().getExceptionListener().handleException(e);
      }
    }
  }
}
