{
  try {
    Message messages[]=event.getMessages();
    List<Message> processedMessages=new ArrayList<Message>();
    if (messages != null) {
      MuleMessage message=null;
      for (int i=0; i < messages.length; i++) {
        if (getLifecycleState().isStopping()) {
          break;
        }
        processedMessages.add(messages[i]);
        try {
          if (!messages[i].getFlags().contains(Flags.Flag.DELETED) && !messages[i].getFlags().contains(Flags.Flag.SEEN)) {
            MimeMessage mimeMessage=new MimeMessage((MimeMessage)messages[i]);
            storeMessage(mimeMessage);
            message=createMuleMessage(mimeMessage,endpoint.getEncoding());
            if (castConnector().isDeleteReadMessages()) {
              messages[i].setFlag(Flags.Flag.DELETED,true);
            }
 else {
              if (this.getEndpoint().getFilter() != null && this.getEndpoint().getFilter().accept(message)) {
                Flags.Flag flag=castConnector().getDefaultProcessMessageAction();
                if (flag != null) {
                  messages[i].setFlag(flag,true);
                }
              }
 else {
                messages[i].setFlag(Flags.Flag.SEEN,false);
              }
            }
            routeMessage(message);
          }
        }
 catch (        MuleException e) {
          throw e;
        }
catch (        Exception e) {
          Exception forwarded;
          if (message != null) {
            forwarded=new org.mule.api.MessagingException(EmailMessages.routingError(),message,e);
          }
 else {
            forwarded=new ReceiveException(endpoint,-1,e);
          }
          throw forwarded;
        }
      }
      if (moveToFolder != null) {
        folder.copyMessages(processedMessages.toArray(new Message[processedMessages.size()]),moveToFolder);
      }
    }
  }
 catch (  Exception e) {
    throw new MuleRuntimeException(e);
  }
}
