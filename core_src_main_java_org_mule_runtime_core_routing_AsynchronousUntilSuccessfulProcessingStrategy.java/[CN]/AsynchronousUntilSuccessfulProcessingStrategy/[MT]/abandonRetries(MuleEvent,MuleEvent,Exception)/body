{
  if (getUntilSuccessfulConfiguration().getDlqMP() == null) {
    logger.info("Retry attempts exhausted and no DLQ defined");
    messagingExceptionHandler.handleException(new MessagingException(mutableEvent,buildRetryPolicyExhaustedException(lastException)),mutableEvent);
    return;
  }
  MuleEvent eventCopy=threadSafeCopy(event);
  logger.info("Retry attempts exhausted, routing message to DLQ: " + getUntilSuccessfulConfiguration().getDlqMP());
  try {
    RetryPolicyExhaustedException exception=buildRetryPolicyExhaustedException(lastException);
    mutableEvent.setMessage(MuleMessage.builder(mutableEvent.getMessage()).exceptionPayload(new DefaultExceptionPayload(exception)).build());
    mutableEvent.setError(ErrorBuilder.builder(exception).errorType(muleContext.getErrorTypeLocator().lookupErrorType(exception)).build());
    getUntilSuccessfulConfiguration().getDlqMP().process(mutableEvent);
  }
 catch (  MessagingException e) {
    messagingExceptionHandler.handleException(e,eventCopy);
  }
catch (  Exception e) {
    messagingExceptionHandler.handleException(new MessagingException(event,e),eventCopy);
  }
}
