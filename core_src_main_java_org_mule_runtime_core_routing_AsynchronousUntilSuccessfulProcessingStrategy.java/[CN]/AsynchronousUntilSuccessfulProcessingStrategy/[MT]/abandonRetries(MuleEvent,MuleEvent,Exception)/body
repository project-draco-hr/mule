{
  if (getUntilSuccessfulConfiguration().getDlqMP() == null) {
    logger.info("Retry attempts exhausted and no DLQ defined");
    messagingExceptionHandler.handleException(new MessagingException(mutableEvent,buildRetryPolicyExhaustedException(lastException)),mutableEvent);
    return;
  }
  MuleEvent eventCopy=event;
  logger.info("Retry attempts exhausted, routing message to DLQ: " + getUntilSuccessfulConfiguration().getDlqMP());
  try {
    RetryPolicyExhaustedException exception=buildRetryPolicyExhaustedException(lastException);
    MuleEvent mutatedEvent=MuleEvent.builder(mutableEvent).message(MuleMessage.builder(mutableEvent.getMessage()).exceptionPayload(new DefaultExceptionPayload(exception)).build()).error(ErrorBuilder.builder(exception).errorType(muleContext.getErrorTypeLocator().lookupErrorType(exception)).build()).build();
    getUntilSuccessfulConfiguration().getDlqMP().process(mutatedEvent);
  }
 catch (  MessagingException e) {
    messagingExceptionHandler.handleException(e,eventCopy);
  }
catch (  Exception e) {
    messagingExceptionHandler.handleException(new MessagingException(event,e),eventCopy);
  }
}
