{
  MuleContext context;
  if (isDisposeContextPerClass() && muleContext != null) {
    context=muleContext;
  }
 else {
    MuleContextFactory muleContextFactory=new DefaultMuleContextFactory();
    List<ConfigurationBuilder> builders=new ArrayList<>();
    builders.add(new SimpleConfigurationBuilder(getStartUpProperties()));
    builders.add(getBuilder());
    addBuilders(builders);
    MuleContextBuilder contextBuilder=new DefaultMuleContextBuilder();
    DefaultMuleConfiguration muleConfiguration=new DefaultMuleConfiguration();
    String workingDirectory=this.workingDirectory.getRoot().getAbsolutePath();
    logger.info("Using working directory for test: " + workingDirectory);
    muleConfiguration.setWorkingDirectory(workingDirectory);
    contextBuilder.setMuleConfiguration(muleConfiguration);
    configureMuleContext(contextBuilder);
    context=muleContextFactory.createMuleContext(builders,contextBuilder);
    if (!isGracefulShutdown()) {
      ((DefaultMuleConfiguration)context.getConfiguration()).setShutdownTimeout(0);
    }
  }
  return context;
}
