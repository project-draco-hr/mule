{
  MuleMessage resultMessage=null;
  ResponseOutputStream ros=null;
  if (outputStream != null) {
    if (outputStream instanceof ResponseOutputStream) {
      ros=(ResponseOutputStream)outputStream;
    }
 else {
      ros=new ResponseOutputStream(outputStream);
    }
  }
  MuleSession session;
  try {
    session=connector.getSessionHandler().retrieveSessionInfoFromMessage(message);
  }
 catch (  SerializationException e) {
    session=new LegacySessionHandler().retrieveSessionInfoFromMessage(message);
  }
  if (session != null) {
    session.setService(service);
  }
 else {
    session=new DefaultMuleSession(service,connector.getMuleContext());
  }
  MuleEvent muleEvent=new DefaultMuleEvent(message,endpoint,session,synchronous,ros);
  muleEvent=OptimizedRequestContext.unsafeSetEvent(muleEvent);
  boolean authorised=false;
  if (endpoint.getSecurityFilter() != null) {
    try {
      endpoint.getSecurityFilter().authenticate(muleEvent);
      authorised=true;
    }
 catch (    SecurityException e) {
      logger.warn("Request was made but was not authenticated: " + e.getMessage(),e);
      connector.fireNotification(new SecurityNotification(e,SecurityNotification.SECURITY_AUTHENTICATION_FAILED));
      handleException(e);
      resultMessage=RequestContext.getEvent().getMessage();
      resultMessage.setPayload(e.getLocalizedMessage());
    }
  }
 else {
    authorised=true;
  }
  if (authorised) {
    if (responseEndpoint) {
      muleEvent.transformMessage();
      service.getResponseRouter().route(muleEvent);
      return null;
    }
 else {
      resultMessage=service.getInboundRouter().route(muleEvent);
    }
  }
  if (resultMessage != null) {
    if (resultMessage.getExceptionPayload() != null) {
      setExceptionDetails(resultMessage,resultMessage.getExceptionPayload().getException());
    }
    resultMessage.applyTransformers(endpoint.getResponseTransformers());
  }
  return resultMessage;
}
