{
  final UMOEndpointURI uri=endpoint.getEndpointURI();
  FTPClient client=connector.getFtp(uri);
  try {
    connector.enterActiveOrPassiveMode(client,endpoint);
    connector.setupFileType(client,endpoint);
    final String path=uri.getPath();
    if (!client.changeWorkingDirectory(path)) {
      throw new IOException(MessageFormat.format("Failed to change working directory to {0}. Ftp error: {1}",new Object[]{path,new Integer(client.getReplyCode())}));
    }
    FTPFile[] files=client.listFiles();
    if (!FTPReply.isPositiveCompletion(client.getReplyCode())) {
      throw new IOException("Failed to list files. Ftp error: " + client.getReplyCode());
    }
    if (files == null || files.length == 0) {
      return files;
    }
    List v=new ArrayList();
    for (int i=0; i < files.length; i++) {
      if (files[i].isFile()) {
        if (filenameFilter == null || filenameFilter.accept(null,files[i].getName())) {
          v.add(files[i]);
        }
      }
    }
    return (FTPFile[])v.toArray(new FTPFile[v.size()]);
  }
  finally {
    connector.releaseFtp(uri,client);
  }
}
