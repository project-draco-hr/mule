{
  final MuleContext muleContext=receiver.getConnector().getMuleContext();
  TransactionTemplate tt=new TransactionTemplate(endpoint.getTransactionConfig(),endpoint.getConnector().getExceptionListener(),muleContext);
  TransactionCallback cb=new TransactionCallback(){
    public Object doInTransaction() throws Exception {
      Transaction tx=TransactionCoordination.getInstance().getTransaction();
      if (tx != null) {
        bindTransaction(tx);
      }
      List results=new ArrayList(messages.size());
      for (Iterator iterator=messages.iterator(); iterator.hasNext(); ) {
        Object payload=iterator.next();
        payload=preProcessMessage(payload);
        if (payload != null) {
          MuleMessage muleMessage=receiver.createMuleMessage(payload,endpoint.getEncoding());
          preRouteMuleMessage(muleMessage);
          MuleMessage result=receiver.routeMessage(muleMessage,tx,tx != null || endpoint.isSynchronous(),out);
          if (result != null) {
            payload=postProcessMessage(result);
            if (payload != null) {
              results.add(payload);
            }
          }
        }
      }
      return results;
    }
  }
;
  try {
    List results=(List)tt.execute(cb);
    handleResults(results);
  }
 catch (  Exception e) {
    handleException(e);
  }
 finally {
    messages.clear();
  }
}
