{
  Object result;
  String encoding=null;
  if (src instanceof UMOMessage) {
    encoding=((UMOMessage)src).getEncoding();
    src=((UMOMessage)src).getPayload();
  }
  if (!isSourceTypeSupported(src.getClass())) {
    if (ignoreBadInput) {
      logger.debug("Source type is incompatible with this transformer. Property 'ignoreBadInput' is set to true so the transformer chain will continue");
      return src;
    }
 else {
      throw new TransformerException(new Message(Messages.TRANSFORM_X_UNSUPORTED_TYPE_X_ENDPOINT_X,getName(),src.getClass().getName(),endpoint.getEndpointURI()),this);
    }
  }
 else {
    if (endpoint != null && endpoint.getEncoding() != null) {
      encoding=endpoint.getEncoding();
    }
    if (encoding == null) {
      encoding=MuleManager.getConfiguration().getEncoding();
    }
    result=doTransform(src,encoding);
    result=checkReturnClass(result);
    if (transformer != null) {
      result=transformer.transform(result);
    }
  }
  return result;
}
