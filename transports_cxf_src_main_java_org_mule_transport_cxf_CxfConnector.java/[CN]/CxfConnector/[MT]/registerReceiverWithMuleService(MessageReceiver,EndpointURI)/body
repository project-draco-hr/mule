{
  CxfMessageReceiver cxfReceiver=(CxfMessageReceiver)receiver;
  Server server=cxfReceiver.getServer();
  String flowConstruct=cxfReceiver.getFlowConstruct().getName();
  uriToServer.put(server.getEndpoint().getEndpointInfo().getAddress(),server);
  SedaService outerProtocolService=new SedaService(muleContext);
  outerProtocolService.setName(flowConstruct + "_cxfComponent");
  outerProtocolService.setModel(muleContext.getRegistry().lookupSystemModel());
  CxfServiceComponent svcComponent=new CxfServiceComponent(this,(CxfMessageReceiver)receiver);
  svcComponent.setBus(bus);
  final DefaultJavaComponent component=new DefaultJavaComponent(new SingletonObjectFactory(svcComponent));
  component.setMuleContext(muleContext);
  outerProtocolService.setComponent(component);
  String endpoint=receiver.getEndpointURI().getAddress();
  String scheme=ep.getScheme().toLowerCase();
  InboundEndpoint originalEndpoint=receiver.getEndpoint();
  if (scheme.equals("http") || scheme.equals("https") || scheme.equals("ssl")|| scheme.equals("tcp")|| scheme.equals("servlet")) {
    originalEndpoint.getProperties().put(HttpConnector.HTTP_METHOD_PROPERTY,"POST");
    originalEndpoint.getProperties().put(HttpConstants.HEADER_CONTENT_TYPE,"text/xml");
  }
  QName serviceName=server.getEndpoint().getEndpointInfo().getName();
  EndpointBuilder protocolEndpointBuilder=new EndpointURIEndpointBuilder(endpoint,muleContext);
  protocolEndpointBuilder.setExchangePattern(originalEndpoint.getExchangePattern());
  protocolEndpointBuilder.setName(ep.getScheme() + ":" + serviceName.getLocalPart());
  protocolEndpointBuilder.setTransactionConfig(originalEndpoint.getTransactionConfig());
  EndpointBuilder receiverEndpointBuilder=new EndpointURIEndpointBuilder(originalEndpoint);
  EndpointBuilder transformerEndpoint;
  if (cxfReceiver.isApplyTransformersToProtocol()) {
    transformerEndpoint=protocolEndpointBuilder;
    receiverEndpointBuilder.setTransformers(Collections.<Transformer>emptyList());
    receiverEndpointBuilder.setResponseTransformers(Collections.<Transformer>emptyList());
  }
 else {
    transformerEndpoint=receiverEndpointBuilder;
  }
  if (originalEndpoint.getTransformers() != null && !originalEndpoint.getTransformers().isEmpty()) {
    transformerEndpoint.setTransformers(originalEndpoint.getTransformers());
  }
  if (originalEndpoint.getResponseTransformers() != null && !originalEndpoint.getResponseTransformers().isEmpty()) {
    transformerEndpoint.setResponseTransformers(originalEndpoint.getResponseTransformers());
  }
  EndpointBuilder filterEndpoint;
  if (cxfReceiver.isApplyFiltersToProtocol()) {
    filterEndpoint=protocolEndpointBuilder;
    receiverEndpointBuilder.setFilter(null);
  }
 else {
    filterEndpoint=receiverEndpointBuilder;
  }
  filterEndpoint.setFilter(originalEndpoint.getFilter());
  EndpointBuilder secFilterEndpoint;
  if (cxfReceiver.isApplySecurityToProtocol()) {
    secFilterEndpoint=protocolEndpointBuilder;
    receiverEndpointBuilder.setSecurityFilter(null);
  }
 else {
    secFilterEndpoint=receiverEndpointBuilder;
  }
  secFilterEndpoint.setSecurityFilter(originalEndpoint.getSecurityFilter());
  String connectorName=(String)originalEndpoint.getProperty(CxfConstants.PROTOCOL_CONNECTOR);
  if (connectorName != null) {
    protocolEndpointBuilder.setConnector(muleContext.getRegistry().lookupConnector(connectorName));
  }
  InboundEndpoint protocolEndpoint=muleContext.getRegistry().lookupEndpointFactory().getInboundEndpoint(protocolEndpointBuilder);
  InboundEndpoint receiverEndpoint=muleContext.getRegistry().lookupEndpointFactory().getInboundEndpoint(receiverEndpointBuilder);
  receiver.setEndpoint(receiverEndpoint);
  outerProtocolService.setInboundRouter(new DefaultInboundRouterCollection());
  outerProtocolService.getInboundRouter().addEndpoint(protocolEndpoint);
  if (!serviceToProtocolServices.containsKey(flowConstruct)) {
    serviceToProtocolServices.put(flowConstruct,new HashSet());
  }
  serviceToProtocolServices.get(flowConstruct).add(outerProtocolService);
}
