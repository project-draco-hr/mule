{
  MuleSession session=getTestSession(null,muleContext);
  Flow flow=getTestFlow("test",Apple.class);
  assertNotNull(flow);
  MessageChunkAggregator router=new MessageChunkAggregator();
  router.setMuleContext(muleContext);
  router.setFlowConstruct(flow);
  router.initialise();
  MuleMessage message1=MuleMessage.of("test event A");
  MuleMessage message2=MuleMessage.of("test event B");
  MuleMessage message3=MuleMessage.of("test event C");
  MessageExecutionContext context=create(flow,"foo");
  DefaultMuleEvent event1=new DefaultMuleEvent(context,message1,getTestFlow(),session);
  event1.setCorrelation(new Correlation(1,null));
  DefaultMuleEvent event2=new DefaultMuleEvent(context,message2,getTestFlow(),session);
  event1.setCorrelation(new Correlation(2,null));
  DefaultMuleEvent event3=new DefaultMuleEvent(context,message3,getTestFlow(),session);
  event1.setCorrelation(new Correlation(3,null));
  assertNull(router.process(event1));
  assertNull(router.process(event2));
  MuleEvent resultEvent=router.process(event3);
  assertNotNull(resultEvent);
  MuleMessage resultMessage=resultEvent.getMessage();
  assertNotNull(resultMessage);
  String payload=getPayloadAsString(resultMessage);
  assertTrue(payload.contains("test event A"));
  assertTrue(payload.contains("test event B"));
  assertTrue(payload.contains("test event C"));
  assertTrue(payload.matches("test event [A,B,C]test event [A,B,C]test event [A,B,C]"));
}
