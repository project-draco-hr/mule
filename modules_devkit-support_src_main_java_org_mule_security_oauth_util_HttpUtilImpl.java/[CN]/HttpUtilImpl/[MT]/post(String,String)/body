{
  HttpURLConnection conn=null;
  try {
    conn=((HttpURLConnection)new URL(url).openConnection());
  }
 catch (  MalformedURLException e) {
    throw new IllegalArgumentException(url + " is not a valid url",e);
  }
catch (  IOException e) {
    throw new RuntimeException("Could not open connection to " + url,e);
  }
  try {
    conn.setRequestMethod("POST");
  }
 catch (  ProtocolException e) {
    throw new RuntimeException("Something is wrong with the runtime, POST is not recognized as a verb",e);
  }
  conn.setDoOutput(true);
  if (logger.isDebugEnabled()) {
    logger.debug(String.format("Sending request to [%s] using the following as content [%s]",url,body));
  }
  OutputStreamWriter out=null;
  InputStream errorStream=null;
  try {
    out=new OutputStreamWriter(conn.getOutputStream());
    out.write(body);
    out.flush();
    int responseCode=conn.getResponseCode();
    if (wasSuccessful(responseCode)) {
      return IOUtils.toString(conn.getInputStream());
    }
 else {
      errorStream=conn.getErrorStream();
      String response=IOUtils.toString(errorStream);
      String errorMsg=String.format("Received status code [%d] while trying to get OAuth2 verification code. Response body was [%s]",responseCode,response);
      logger.error(errorMsg);
      throw new IOException(errorMsg);
    }
  }
 catch (  IOException e) {
    throw new RuntimeException("Error found while consuming http resource at " + url,e);
  }
 finally {
    IOUtils.closeQuietly(out);
    IOUtils.closeQuietly(errorStream);
  }
}
