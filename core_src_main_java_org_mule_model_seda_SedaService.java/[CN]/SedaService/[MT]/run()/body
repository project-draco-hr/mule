{
  DefaultMuleEvent event=null;
  QueueSession queueSession=muleContext.getQueueManager().getQueueSession();
  while (!isStopped()) {
    try {
      if (isPaused()) {
        waitIfPaused(event);
        if (lifecycleManager.getState().isStopping()) {
          queueDraining.set(true);
          if (!isPersistent() && (queueSession != null && getQueueSize() > 0)) {
            logger.warn(CoreMessages.stopPausedSedaServiceNonPeristentQueueMessageLoss(getQueueSize(),this));
          }
          queueDraining.set(false);
          break;
        }
      }
      if (lifecycleManager.getState().isStopping()) {
        if (isPersistent() || queueSession == null || getQueueSize() <= 0) {
          queueDraining.set(false);
          break;
        }
      }
      event=(DefaultMuleEvent)dequeue();
      if (event != null) {
        if (stats.isEnabled()) {
          stats.decQueuedEvent();
        }
        if (logger.isDebugEnabled()) {
          logger.debug(MessageFormat.format("Service: {0} dequeued event on: {1}",name,event.getEndpoint().getEndpointURI()));
        }
        Work work=new ComponentStageWorker(event);
        if (threadingProfile.isDoThreading()) {
          workManager.scheduleWork(work,WorkManager.INDEFINITE,null,this);
        }
 else {
          work.run();
        }
      }
    }
 catch (    Exception e) {
      if (e instanceof InterruptedException) {
        queueDraining.set(false);
        break;
      }
      if (e instanceof MuleException) {
        handleException(e);
      }
 else {
        handleException(new ServiceException(CoreMessages.eventProcessingFailedFor(name),(event == null ? null : event.getMessage()),this,e));
      }
    }
  }
}
