{
  try {
    startTransaction();
  }
 catch (  Exception e) {
    handleException("Caught exception trying to start transaction. This thread will terminate. Reason: " + e,e);
  }
  try {
    Object message=getMessage();
    if (message != null) {
      if (logger.isTraceEnabled()) {
        logger.trace("Received Message: " + message);
      }
      processMessage(message,new XaTransaction(transaction));
    }
 else {
      cancelTransaction();
    }
  }
 catch (  Exception e1) {
    logger.error(e1.getMessage(),e1);
    try {
      rollbackTransaction();
      endpoint.getConnector().stop();
    }
 catch (    Exception e) {
      logger.error("Failed to stop endpoint: " + e,e);
    }
  }
}
