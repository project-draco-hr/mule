{
  Message msg;
  if (message instanceof Message) {
    msg=(Message)message;
  }
 else {
    throw new MessageTypeNotSupportedException(message,MailMessageAdapter.class);
  }
  try {
    Object content=msg.getContent();
    if (content instanceof Multipart) {
      this.messagePart=((Multipart)content).getBodyPart(0);
      logger.debug("Received Multipart message");
      Part part;
      String name;
      for (int i=1; i < ((Multipart)content).getCount(); i++) {
        part=((Multipart)content).getBodyPart(i);
        name=part.getFileName();
        if (name == null)         name=String.valueOf(i - 1);
        addAttachment(name,part.getDataHandler());
      }
    }
 else {
      messagePart=msg;
    }
    setProperty(MailProperties.TO_ADDRESSES_PROPERTY,MailUtils.mailAddressesToString(msg.getRecipients(Message.RecipientType.TO)));
    setProperty(MailProperties.CC_ADDRESSES_PROPERTY,MailUtils.mailAddressesToString(msg.getRecipients(Message.RecipientType.CC)));
    setProperty(MailProperties.BCC_ADDRESSES_PROPERTY,MailUtils.mailAddressesToString(msg.getRecipients(Message.RecipientType.BCC)));
    setProperty(MailProperties.REPLY_TO_ADDRESSES_PROPERTY,MailUtils.mailAddressesToString(msg.getReplyTo()));
    setProperty(MailProperties.FROM_ADDRESS_PROPERTY,MailUtils.mailAddressesToString(msg.getFrom()));
    setProperty(MailProperties.SUBJECT_PROPERTY,msg.getSubject());
    setProperty(MailProperties.CONTENT_TYPE_PROPERTY,msg.getContentType());
    setProperty(MailProperties.SENT_DATE_PROPERTY,msg.getSentDate());
    for (Enumeration e=msg.getAllHeaders(); e.hasMoreElements(); ) {
      Header h=(Header)e.nextElement();
      properties.put(h.getName(),h.getValue());
    }
  }
 catch (  Exception e) {
    throw new MessagingException(new org.mule.config.i18n.Message(Messages.FAILED_TO_CREATE_X,"Message Adapter"),e);
  }
}
