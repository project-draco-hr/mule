{
  Message msg;
  if (message instanceof Message) {
    msg=(Message)message;
  }
 else {
    throw new MessageTypeNotSupportedException(message,MailMessageAdapter.class);
  }
  try {
    Object content=msg.getContent();
    if (content instanceof Multipart) {
      this.messagePart=((Multipart)content).getBodyPart(0);
      logger.debug("Received Multipart message");
      Part part;
      String name;
      for (int i=1; i < ((Multipart)content).getCount(); i++) {
        part=((Multipart)content).getBodyPart(i);
        name=part.getDescription();
        if (name == null)         name=String.valueOf(i - 1);
        addAttachment(name,part.getDataHandler());
      }
    }
 else {
      messagePart=msg;
    }
    Address[] addresses=null;
    properties.put(PROPERTY_SUBJECT,msg.getSubject());
    addresses=msg.getFrom();
    if (addresses != null && addresses.length > 0) {
      properties.put(PROPERTY_FROM_ADDRESS,addresses[0].toString());
      properties.put(PROPERTY_FROM_ADDRESSES,addresses);
    }
    properties.put(PROPERTY_TO_ADDRESSES,msg.getRecipients(Message.RecipientType.TO));
    properties.put(PROPERTY_CC_ADDRESSES,msg.getRecipients(Message.RecipientType.CC));
    properties.put(PROPERTY_BCC_ADDRESSES,msg.getRecipients(Message.RecipientType.BCC));
    for (Enumeration e=msg.getAllHeaders(); e.hasMoreElements(); ) {
      Header h=(Header)e.nextElement();
      properties.put(h.getName(),h.getValue());
    }
  }
 catch (  Exception e) {
    throw new MessagingException(new org.mule.config.i18n.Message(Messages.FAILED_TO_CREATE_X,"Message Adapter"),e);
  }
}
