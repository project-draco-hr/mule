{
  ActiveMQConnectionFactory connectionFactory=new ActiveMQConnectionFactory("vm://localhost?broker.persistent=false&broker.useJmx=false");
  Connection producerConnection=null;
  Connection consumerConnection=null;
  try {
    producerConnection=connectionFactory.createConnection();
    producerConnection.start();
    Session producerSession=producerConnection.createSession(false,Session.AUTO_ACKNOWLEDGE);
    Destination producerDestination=producerSession.createQueue(producerQueue);
    MessageProducer producer=producerSession.createProducer(producerDestination);
    consumerConnection=connectionFactory.createConnection();
    consumerConnection.start();
    Session consumerSession=consumerConnection.createSession(false,Session.AUTO_ACKNOWLEDGE);
    Destination consumerDestination=consumerSession.createQueue(consumerQueue);
    MessageConsumer consumer=consumerSession.createConsumer(consumerDestination);
    String message="QoS Headers Propagation Test";
    TextMessage textMessage=producerSession.createTextMessage(message);
    producer.setPriority(7);
    producer.setDeliveryMode(DeliveryMode.PERSISTENT);
    producer.send(textMessage);
    Message response=consumer.receive(10000);
    if (honorProperties) {
      performHeadersHonoredAssertions(response);
    }
 else {
      performHeadersNotHonoredAssertions(response);
    }
  }
  finally {
    try {
      if (consumerConnection != null) {
        consumerConnection.close();
      }
    }
 catch (    JMSException e) {
    }
    try {
      if (producerConnection != null) {
        producerConnection.close();
      }
    }
 catch (    JMSException e) {
    }
  }
}
