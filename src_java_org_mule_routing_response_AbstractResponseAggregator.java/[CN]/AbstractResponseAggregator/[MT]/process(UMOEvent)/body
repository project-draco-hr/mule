{
  AtomicBoolean doAggregate=new AtomicBoolean(false);
  EventGroup eg=addEvent(event);
  doAggregate.compareAndSet(false,shouldAggregate(eg));
  if (doAggregate.get()) {
synchronized (lock) {
      UMOMessage returnMessage=aggregateEvents(eg);
      Object id=eg.getGroupId();
      removeGroup(id);
      responseEvents.put(id,returnMessage);
      Lock l=(Lock)locks.get(id);
      if (l == null) {
        if (logger.isDebugEnabled()) {
          logger.debug("Creating latch for " + id + " in "+ this);
        }
        l=new Latch();
        locks.put(id,l);
      }
      l.unlock();
    }
  }
}
