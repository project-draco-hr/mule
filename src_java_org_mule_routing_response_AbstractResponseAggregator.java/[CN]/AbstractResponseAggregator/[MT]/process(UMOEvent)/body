{
  AtomicBoolean doAggregate=new AtomicBoolean(false);
  EventGroup eg=addEvent(event);
  doAggregate.compareAndSet(false,shouldAggregate(eg));
  if (doAggregate.get()) {
synchronized (lock) {
      UMOMessage returnMessage=aggregateEvents(eg);
      Object id=eg.getGroupId();
      removeGroup(id);
      responseEvents.put(id,returnMessage);
      Sync s=(Sync)locks.get(id);
      if (s == null) {
        if (logger.isDebugEnabled()) {
          logger.debug("Creating latch for " + id + " in "+ this);
        }
        s=new Latch();
        locks.put(id,s);
      }
      s.release();
    }
  }
}
