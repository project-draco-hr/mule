{
  if (endpoint.getTransactionConfig() != null && endpoint.getTransactionConfig().getFactory() instanceof XaTransactionFactory) {
    if (dataSource instanceof XADataSource) {
      return ((XADataSource)dataSource).getXAConnection();
    }
 else {
      throw new IllegalStateException("dataSource should be an instance of XADataSource");
    }
  }
 else {
    if (dataSource instanceof DataSource) {
      Connection con=((DataSource)dataSource).getConnection();
      con.setAutoCommit(false);
      return con;
    }
 else {
      throw new IllegalStateException("dataSource should be an instance of DataSource");
    }
  }
}
