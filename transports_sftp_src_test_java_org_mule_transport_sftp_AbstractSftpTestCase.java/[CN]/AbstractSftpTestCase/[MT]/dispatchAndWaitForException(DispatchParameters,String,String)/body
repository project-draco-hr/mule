{
  final CountDownLatch latch=new CountDownLatch(1);
  SystemExceptionHandler listener=null;
  MessagingExceptionHandler messagingListener=null;
  MuleClient muleClient=p.getMuleClient();
  boolean localMuleClient=muleClient == null;
  SystemExceptionHandler currentExceptionListener=null;
  MessagingExceptionHandler currentMessagingListener=null;
  final ValueHolder<Exception> exceptionHolder=new ValueHolder<Exception>();
  try {
    if (localMuleClient)     muleClient=new MuleClient(muleContext);
    listener=new SystemExceptionHandler(){
      @Override public void handleException(      Exception e,      RollbackMethod rollbackMethod){
        exceptionHolder.value=e;
        if (logger.isDebugEnabled())         logger.debug("Expected exception occurred: " + e.getMessage() + ", time to countdown the latch");
        latch.countDown();
      }
      @Override public void handleException(      Exception exception){
        handleException(exception,null);
      }
    }
;
    messagingListener=new MessagingExceptionHandler(){
      @Override public MuleEvent handleException(      Exception e,      MuleEvent event,      RollbackMethod rollbackMethod){
        exceptionHolder.value=e;
        if (logger.isDebugEnabled())         logger.debug("Expected exception occurred: " + e.getMessage() + ", time to countdown the latch");
        latch.countDown();
        return event;
      }
      @Override public MuleEvent handleException(      Exception exception,      MuleEvent event){
        return handleException(exception,event,null);
      }
    }
;
    currentMessagingListener=muleContext.getRegistry().lookupService(serviceName).getExceptionListener();
    muleContext.getRegistry().lookupService(serviceName).setExceptionListener(messagingListener);
    currentExceptionListener=muleContext.getExceptionListener();
    muleContext.setExceptionListener(listener);
    Map<String,String> headers=new HashMap<String,String>();
    headers.put("filename",p.getFilename());
    if (p.getHeaders() != null) {
      headers.putAll(p.getHeaders());
    }
    String connectString=(p.getSftpConnector() == null) ? "" : "?connector=" + p.getSftpConnector();
    muleClient.dispatch(getAddressByEndpoint(muleClient,p.getInboundEndpoint()) + connectString,TEST_MESSAGE,headers);
    if (logger.isDebugEnabled())     logger.debug("Waiting for an exception to occur...");
    boolean workDone=latch.await(p.getTimeout(),TimeUnit.MILLISECONDS);
    if (logger.isDebugEnabled())     logger.debug((workDone) ? "Exception occurred, continue..." : "No exception, instead a timeout occurred!");
    assertTrue("Test timed out. It took more than " + p.getTimeout() + " milliseconds. If this error occurs the test probably needs a longer time out (on your computer/network)",workDone);
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail("An unexpected error occurred: " + e.getMessage());
  }
 finally {
    if (localMuleClient)     muleClient.dispose();
    muleContext.setExceptionListener(currentExceptionListener);
    muleContext.getRegistry().lookupService(serviceName).setExceptionListener(currentMessagingListener);
  }
  return exceptionHolder.value;
}
