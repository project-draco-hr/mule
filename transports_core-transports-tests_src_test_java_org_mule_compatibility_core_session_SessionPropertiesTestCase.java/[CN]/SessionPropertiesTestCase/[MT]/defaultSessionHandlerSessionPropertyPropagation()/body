{
  MuleMessage message=MuleMessage.builder().payload("data").build();
  Flow flow=getTestFlow();
  MuleEvent event=new DefaultMuleEvent(create(flow),message,ONE_WAY,flow);
  event.getSession().setProperty("key","value");
  message=new SerializeAndEncodeSessionHandler().storeSessionInfoToMessage(event.getSession(),message,muleContext);
  message=MuleMessage.builder(message).addInboundProperty(MULE_SESSION_PROPERTY,message.getOutboundProperty(MULE_SESSION_PROPERTY)).build();
  MuleSession newSession=new SerializeAndEncodeSessionHandler().retrieveSessionInfoFromMessage(message,muleContext);
  assertNotSame(newSession,event.getSession());
  assertFalse(newSession.equals(event.getSession()));
  assertEquals(1,newSession.getPropertyNamesAsSet().size());
  assertEquals("value",newSession.getProperty("key"));
  newSession.setProperty("newKey","newValue");
  assertEquals(2,newSession.getPropertyNamesAsSet().size());
  assertEquals("newValue",newSession.getProperty("newKey"));
  assertEquals(1,event.getSession().getPropertyNamesAsSet().size());
  assertNull(event.getSession().getProperty("newKey"));
}
