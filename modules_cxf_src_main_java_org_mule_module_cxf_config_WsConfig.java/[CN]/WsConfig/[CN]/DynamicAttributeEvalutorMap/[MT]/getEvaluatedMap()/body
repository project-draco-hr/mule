{
  MuleEvent event=RequestContext.getEvent();
  MuleMessage message=(event != null) ? event.getMessage() : null;
  if (map != null && message != null) {
    Map<String,Object> evaluatedMap=new LinkedHashMap<String,Object>(map.size());
    for (    Entry<String,Object> entry : map.entrySet()) {
      if (entry.getValue() instanceof String) {
        AttributeEvaluator evaluator=new AttributeEvaluator((String)entry.getValue());
        evaluator.initialize(message.getMuleContext().getExpressionManager());
        evaluatedMap.put(entry.getKey(),evaluator.resolveValue(message));
      }
 else {
        evaluatedMap.put(entry.getKey(),entry.getValue());
      }
    }
    return evaluatedMap;
  }
  return map;
}
