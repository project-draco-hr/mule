{
  final int countDownInitialCount=4;
  final CountDownLatch countDown=new CountDownLatch(countDownInitialCount);
  UMODescriptor descriptor=getDescriptor("testComponent",FunctionalTestComponent.class.getName());
  EventCallback callback=new EventCallback(){
    public void eventReceived(    UMOEventContext context,    Object Component) throws Exception {
      callbackCalled=true;
      currentTx=context.getCurrentTransaction();
      assertNotNull(currentTx);
      assertTrue(currentTx.isBegun());
      System.out.println("@@@@ Rolling back transaction @@@@");
      currentTx.setRollbackOnly();
      countDown.countDown();
    }
  }
;
  initialiseComponent(descriptor,UMOTransactionConfig.ACTION_ALWAYS_BEGIN,callback);
  UMOManager manager=MuleManager.getInstance();
  addResultListener(getDLDest().getAddress(),countDown);
  JmsConnector umoCnn=(JmsConnector)manager.lookupConnector(CONNECTOR_NAME);
  umoCnn.setMaxRedelivery(1);
  umoCnn.setExceptionListener(new RollbackExceptionListener(countDown,getDLDest()));
  manager.start();
  send(DEFAULT_MESSAGE,false,Session.AUTO_ACKNOWLEDGE);
  afterInitialise();
  countDown.await(LOCK_WAIT,TimeUnit.MILLISECONDS);
  assertTrue("Only " + (countDownInitialCount - countDown.getCount()) + " of "+ countDownInitialCount+ " checkpoints hit",countDown.getCount() == 0);
  assertNotNull(currentMsg);
  System.out.println(currentMsg);
  String dest=currentMsg.getStringProperty(MuleProperties.MULE_ENDPOINT_PROPERTY);
  assertNotNull(dest);
  assertEquals(getDLDest().getUri().toString(),dest);
  assertTrue(callbackCalled);
  assertNull(receive(getInDest().getAddress(),2000));
}
