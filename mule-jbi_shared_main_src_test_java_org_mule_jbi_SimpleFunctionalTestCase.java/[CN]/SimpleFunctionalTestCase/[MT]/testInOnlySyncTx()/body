{
  new Thread(new Runnable(){
    public void run(){
      try {
        InOnly mep=(InOnly)provider.getChannel().accept(10000L);
        assertNotNull(mep);
        assertTrue(mep.isTransacted());
        assertNotNull(txMgr.getTransaction());
        assertEquals(ExchangeStatus.ACTIVE,mep.getStatus());
        mep.setStatus(ExchangeStatus.DONE);
        provider.getChannel().send(mep);
        assertNull(txMgr.getTransaction());
      }
 catch (      Exception e) {
        e.printStackTrace();
        fail();
      }
    }
  }
).start();
  MessageExchangeFactory mef=consumer.getChannel().createExchangeFactory(endpoint);
  InOnly mec=mef.createInOnlyExchange();
  NormalizedMessage m=mec.createMessage();
  m.setContent(new StreamSource(new ByteArrayInputStream(PAYLOAD.getBytes())));
  mec.setInMessage(m);
  txMgr.begin();
  assertNotNull(txMgr.getTransaction());
  mec.setProperty(MessageExchange.JTA_TRANSACTION_PROPERTY_NAME,txMgr.getTransaction());
  consumer.getChannel().sendSync(mec,10000L);
  assertEquals(ExchangeStatus.DONE,mec.getStatus());
  assertNotNull(txMgr.getTransaction());
  txMgr.commit();
  assertNull(txMgr.getTransaction());
  assertNull(consumer.getChannel().accept(10L));
  assertNull(provider.getChannel().accept(10L));
}
