{
  File pluginDir=getAppPluginsFolder(APP_NAME);
  pluginDir.mkdirs();
  final File pluginFile=new ApplicationPluginFileBuilder("plugin").usingLibrary("lib/echo-test.jar").getArtifactFile();
  copyFile(pluginFile,new File(pluginDir,"plugin1.zip"));
  copyFile(pluginFile,new File(pluginDir,"plugin2.zip"));
  final ApplicationPluginDescriptorFactory pluginDescriptorFactory=mock(ApplicationPluginDescriptorFactory.class);
  final ApplicationDescriptorFactory applicationDescriptorFactory=new ApplicationDescriptorFactory(pluginDescriptorFactory,applicationPluginRepository);
  final ApplicationPluginDescriptor expectedPluginDescriptor1=mock(ApplicationPluginDescriptor.class);
  when(expectedPluginDescriptor1.getName()).thenReturn("plugin1");
  when(expectedPluginDescriptor1.getClassLoaderFilter()).thenReturn(ArtifactClassLoaderFilter.NULL_CLASSLOADER_FILTER);
  final ApplicationPluginDescriptor expectedPluginDescriptor2=mock(ApplicationPluginDescriptor.class);
  when(expectedPluginDescriptor2.getName()).thenReturn("plugin2");
  when(expectedPluginDescriptor2.getClassLoaderFilter()).thenReturn(ArtifactClassLoaderFilter.NULL_CLASSLOADER_FILTER);
  when(pluginDescriptorFactory.create(any())).thenReturn(expectedPluginDescriptor1).thenReturn(expectedPluginDescriptor2);
  ApplicationDescriptor desc=applicationDescriptorFactory.create(getAppFolder(APP_NAME));
  Set<ApplicationPluginDescriptor> plugins=desc.getPlugins();
  assertThat(plugins.size(),equalTo(2));
  assertThat(plugins,hasItem(equalTo(expectedPluginDescriptor1)));
  assertThat(plugins,hasItem(equalTo(expectedPluginDescriptor2)));
}
