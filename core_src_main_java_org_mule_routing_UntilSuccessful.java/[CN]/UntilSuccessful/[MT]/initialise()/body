{
  if (routes.isEmpty()) {
    throw new InitialisationException(MessageFactory.createStaticMessage("One message processor must be configured within UntilSuccessful."),this);
  }
  if (routes.size() > 1) {
    throw new InitialisationException(MessageFactory.createStaticMessage("Only one message processor is allowed within UntilSuccessful." + " Use a Processor Chain to group several message processors into one."),this);
  }
  super.initialise();
  if (deadLetterQueue != null) {
    if (deadLetterQueue instanceof EndpointBuilder) {
      try {
        dlqMP=((EndpointBuilder)deadLetterQueue).buildOutboundEndpoint();
      }
 catch (      final EndpointException ee) {
        throw new InitialisationException(MessageFactory.createStaticMessage("deadLetterQueue-ref is not a valid endpoint builder: " + deadLetterQueue),ee,this);
      }
    }
 else     if (deadLetterQueue instanceof MessageProcessor) {
      dlqMP=(MessageProcessor)deadLetterQueue;
    }
 else {
      throw new InitialisationException(MessageFactory.createStaticMessage("deadLetterQueue-ref is not a valid mesage processor: " + deadLetterQueue),null,this);
    }
  }
  if (failureExpression != null) {
    failureExpressionFilter=new ExpressionFilter(failureExpression);
  }
 else {
    failureExpressionFilter=new ExpressionFilter("exception-type:");
  }
  failureExpressionFilter.setMuleContext(muleContext);
  if ((ackExpression != null) && (!muleContext.getExpressionManager().isExpression(ackExpression))) {
    throw new InitialisationException(MessageFactory.createStaticMessage("Invalid ackExpression: " + ackExpression),this);
  }
  if (synchronous) {
    this.untilSuccessfulStrategy=new SynchronousUntilSuccessfulProcessingStrategy();
  }
 else {
    if (threadingProfile == null) {
      threadingProfile=muleContext.getDefaultThreadingProfile();
    }
    this.untilSuccessfulStrategy=new AsynchronousUntilSuccessfulProcessingStrategy();
  }
  this.untilSuccessfulStrategy.setUntilSuccessfulConfiguration(this);
  if (untilSuccessfulStrategy instanceof Initialisable) {
    ((Initialisable)untilSuccessfulStrategy).initialise();
  }
  String flowName=flowConstruct.getName();
  String clusterId=muleContext.getClusterId();
  eventKeyPrefix=flowName + "-" + clusterId+ "-";
}
