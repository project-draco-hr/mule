{
  if (link != null && link.contains(key))   return "${infinite:" + link.toString() + "}";
  if (key != null) {
    key=key.trim();
    if (key.length() > 0) {
      String value=(String)properties.getProperty(key);
      if (value != null)       return process(value,new Link(link,key));
      value=doCommands(key);
      if (value != null)       return process(value,new Link(link,key));
      if (key != null && key.trim().length() > 0) {
        value=System.getProperty(key);
        if (value != null)         return value;
      }
      if (!flattening)       domain.warning("No translation found for macro: " + key);
    }
 else {
      domain.warning("Found empty macro key");
    }
  }
 else {
    domain.warning("Found null macro key");
  }
  return "${" + key + "}";
}
