{
  Flow flow=getTestFlow("test",Apple.class);
  MuleSession session=getTestSession(flow,muleContext);
  TestEventAggregator router=new TestEventAggregator(3);
  router.setMuleContext(muleContext);
  router.setFlowConstruct(flow);
  router.initialise();
  MuleMessage message1=MuleMessage.builder().payload("test event A").build();
  MuleMessage message2=MuleMessage.builder().payload("test event B").build();
  MuleMessage message3=MuleMessage.builder().payload("test event C").build();
  message1=MuleMessage.builder(message1).correlationId(message1.getUniqueId()).build();
  message2=MuleMessage.builder(message2).correlationId(message1.getUniqueId()).build();
  message3=MuleMessage.builder(message3).correlationId(message1.getUniqueId()).build();
  MuleEvent event1=new DefaultMuleEvent(message1,flow,session);
  MuleEvent event2=new DefaultMuleEvent(message2,flow,session);
  MuleEvent event3=new DefaultMuleEvent(message3,flow,session);
  assertNull(router.process(event1));
  assertNull(router.process(event2));
  MuleEvent result=router.process(event3);
  assertNotNull(result);
  assertTrue(result.getMessageAsString().contains("test event A"));
  assertTrue(result.getMessageAsString().contains("test event B"));
  assertTrue(result.getMessageAsString().contains("test event C"));
  assertTrue(result.getMessageAsString().matches("test event [A,B,C] test event [A,B,C] test event [A,B,C] "));
}
