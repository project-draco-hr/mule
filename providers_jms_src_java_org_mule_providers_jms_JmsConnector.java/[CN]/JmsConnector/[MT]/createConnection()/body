{
  Connection connection=null;
  if (connectionFactory == null) {
    connectionFactory=createConnectionFactory();
  }
  if (connectionFactory != null && connectionFactory instanceof XAConnectionFactory) {
    if (MuleManager.getInstance().getTransactionManager() != null) {
      connectionFactory=new ConnectionFactoryWrapper((XAConnectionFactory)connectionFactory,MuleManager.getInstance().getTransactionManager());
    }
  }
  if (username != null) {
    connection=jmsSupport.createConnection(connectionFactory,username,password);
  }
 else {
    connection=jmsSupport.createConnection(connectionFactory);
  }
  if (clientId == null) {
    setClientId("mule." + getName());
    logger.debug("Jms clientId is not set defaulting to: " + getClientId());
  }
  connection.setClientID(getClientId());
  return connection;
}
