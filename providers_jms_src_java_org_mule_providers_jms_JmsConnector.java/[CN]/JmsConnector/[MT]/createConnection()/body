{
  Connection connection;
  if (connectionFactory == null) {
    connectionFactory=createConnectionFactory();
  }
  if (connectionFactory != null && connectionFactory instanceof XAConnectionFactory) {
    if (MuleManager.getInstance().getTransactionManager() != null) {
      connectionFactory=new ConnectionFactoryWrapper(connectionFactory,MuleManager.getInstance().getTransactionManager());
    }
  }
  if (username != null) {
    connection=jmsSupport.createConnection(connectionFactory,username,password);
  }
 else {
    connection=jmsSupport.createConnection(connectionFactory);
  }
  if (clientId != null) {
    connection.setClientID(getClientId());
  }
  final ConnectionStrategy connectionStrategy=getConnectionStrategy();
  if (connectionStrategy != null && connection != null) {
    connection.setExceptionListener(new ExceptionListener(){
      public void onException(      JMSException jmsException){
        logger.debug("About to dispose of myself due to a JMS connection shutdown.");
        JmsConnector.this.doDispose();
        try {
          connectionStrategy.connect(JmsConnector.this);
        }
 catch (        FatalConnectException e) {
          logger.fatal("Failed to reconnect to JMS server. I'm giving up.");
        }
      }
    }
);
  }
  return connection;
}
