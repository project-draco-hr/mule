{
  try {
    ImmutableMap.Builder<String,String> headers=ImmutableMap.builder();
    headers.putAll(configuration.getHeaders());
    headers.putAll(emailBuilder.getHeaders());
    EmailBody body=emailBuilder.getBody();
    Message message=MessageBuilder.newMessage(connection.getSession()).withSentDate(Calendar.getInstance().getTime()).fromAddresses(isNotBlank(emailBuilder.getFromAddress()) ? emailBuilder.getFromAddress() : configuration.getFrom()).to(emailBuilder.getToAddresses()).cc(emailBuilder.getCcAddresses()).bcc(emailBuilder.getBccAddresses()).withSubject(emailBuilder.getSubject()).withAttachments(emailBuilder.getAttachments()).withBody(body.getContent(),body.getContentType(),body.getCharset() == null ? configuration.getDefaultCharset() : body.getCharset()).withHeaders(headers.build()).build();
    Transport.send(message);
  }
 catch (  MessagingException e) {
    throw new EmailSendException(e);
  }
}
