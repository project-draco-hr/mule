{
  HashMap props=new HashMap();
  UMOEndpoint endpoint=new MuleEndpoint(getTestEndpointURI(),false);
  QuickConfigurationBuilder builder=new QuickConfigurationBuilder();
  builder.registerComponent(FunctionalTestComponent.class.getName(),"testComponent",null,endpoint,props);
  logger.debug("starting mule");
  managementContext.start();
  UMOMessage message=new MuleMessage(MESSAGE);
  message.setStringProperty(MailProperties.TO_ADDRESSES_PROPERTY,EMAIL);
  UMOSession session=getTestSession(getTestComponent(getTestDescriptor("apple",Apple.class.getName())));
  MuleEvent event=new MuleEvent(message,endpoint,session,true,new ResponseOutputStream(System.out));
  endpoint.dispatch(event);
  getServers().waitForIncomingEmail(DELIVERY_DELAY_MS,1);
  MimeMessage[] messages=getServers().getReceivedMessages();
  int count=null == messages ? 0 : messages.length;
  assertEquals("did not receive mail",1,count);
  assertMessageOk(messages[0]);
}
