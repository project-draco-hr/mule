{
  logger.debug("Polling...");
  TransactionTemplate tt=new TransactionTemplate(endpoint.getTransactionConfig(),connector.getExceptionListener(),connector.getMuleContext());
  TransactionCallback cb=new TransactionCallback(){
    public Object doInTransaction() throws Exception {
      try {
        List messages=getMessages();
        if (messages != null && messages.size() > 0) {
          for (          Object message : messages) {
            processMessage(message);
          }
        }
        return null;
      }
 catch (      Exception e) {
        JmsThreadContext ctx=context.getContext();
        ctx.consumer=null;
        Transaction tx=TransactionCoordination.getInstance().getTransaction();
        if (ctx.session != null && tx instanceof XaTransaction.MuleXaObject) {
          if (ctx.session instanceof XaTransaction.MuleXaObject) {
            ((XaTransaction.MuleXaObject)ctx.session).setReuseObject(false);
          }
 else {
            logger.warn("Session should be XA, but is of type " + ctx.session.getClass().getName());
          }
        }
        ctx.session=null;
        throw e;
      }
    }
  }
;
  tt.execute(cb);
}
