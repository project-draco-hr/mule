{
  final MuleMessage attachmentPart=MuleMessage.builder().payload("this is the attachment").mediaType(MediaType.TEXT).attributes(new PartAttributes("attachment")).build();
  MuleMessage message=MuleMessage.builder().payload(new DefaultMultiPartPayload(MuleMessage.builder().payload(TEST_PAYLOAD).attributes(BODY_ATTRIBUTES).build(),attachmentPart)).build();
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  ObjectOutputStream oos=new ObjectOutputStream(baos);
  Flow flow=getTestFlow();
  setCurrentEvent(MuleEvent.builder(DefaultMessageContext.create(flow,TEST_CONNECTOR)).message(message).flow(flow).build());
  oos.writeObject(message);
  oos.flush();
  ObjectInputStream ois=new ObjectInputStream(new ByteArrayInputStream(baos.toByteArray()));
  message=(MuleMessage)ois.readObject();
  assertThat(((MultiPartPayload)message.getPayload()).getPartNames(),hasItem("attachment"));
  assertThat(((MultiPartPayload)message.getPayload()).getPart("attachment").getPayload(),is("this is the attachment"));
  assertThat(((MultiPartPayload)message.getPayload()).getPart("attachment").getAttributes(),equalTo(attachmentPart.getAttributes()));
}
